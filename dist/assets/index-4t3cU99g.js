var t=Object.defineProperty,__publicField=(e,n,i)=>((e,n,i)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i)(e,"symbol"!=typeof n?n+"":n,i);import{R as e}from"./RTree-ooJMOIo3.js";import{d as n,o as i,c as r,_ as s}from"./index-CBIm98R_.js";const o=new WeakMap;function getMetadataMap(t,e){return o.get(t)&&o.get(t).get(e)}function ordinaryGetOwnMetadata(t,e,n){if(void 0===e)throw new TypeError;const i=getMetadataMap(e,n);return i&&i.get(t)}function ordinaryDefineOwnMetadata(t,e,n,i){if(i&&!["string","symbol"].includes(typeof i))throw new TypeError;(getMetadataMap(n,i)||function createMetadataMap(t,e){const n=o.get(t)||new Map;o.set(t,n);const i=n.get(e)||new Map;return n.set(e,i),i}(n,i)).set(t,e)}function ordinaryGetMetadata(t,e,n){return ordinaryGetOwnMetadata(t,e,n)?ordinaryGetOwnMetadata(t,e,n):Object.getPrototypeOf(e)?ordinaryGetMetadata(t,Object.getPrototypeOf(e),n):void 0}const a={decorate:function decorate(t,e,n,i){if(!Array.isArray(t)||0===t.length)throw new TypeError;return void 0!==n?function decorateProperty(t,e,n,i){return t.reverse().forEach((t=>{i=t(e,n,i)||i})),i}(t,e,n,i):"function"==typeof e?function decorateConstructor(t,e){return t.reverse().forEach((t=>{const n=t(e);n&&(e=n)})),e}(t,e):void 0},defineMetadata:function defineMetadata(t,e,n,i){ordinaryDefineOwnMetadata(t,e,n,i)},getMetadata:function getMetadata(t,e,n){return ordinaryGetMetadata(t,e,n)},getOwnMetadata:function getOwnMetadata(t,e,n){return ordinaryGetOwnMetadata(t,e,n)},hasMetadata:function hasMetadata(t,e,n){return!!ordinaryGetMetadata(t,e,n)},hasOwnMetadata:function hasOwnMetadata(t,e,n){return!!ordinaryGetOwnMetadata(t,e,n)},metadata:function metadata(t,e){return function decorator(n,i){ordinaryDefineOwnMetadata(t,e,n,i)}}};Object.assign(Reflect,a);var c="named",h="name",u="unmanaged",d="optional",l="inject",p="multi_inject",g="inversify:tagged",m="inversify:tagged_props",f="inversify:paramtypes",y="post_construct",v="pre_destroy";var S=function getNonCustomTagKeys(){return[l,p,h,u,c,d]}(),A={Request:"Request",Singleton:"Singleton",Transient:"Transient"},b={ConstantValue:"ConstantValue",Constructor:"Constructor",DynamicValue:"DynamicValue",Factory:"Factory",Function:"Function",Instance:"Instance",Invalid:"Invalid",Provider:"Provider"},C={ClassProperty:"ClassProperty",ConstructorArgument:"ConstructorArgument",Variable:"Variable"},w=0;function id(){return w++}var I=function(){function Binding2(t,e){this.id=id(),this.activated=!1,this.serviceIdentifier=t,this.scope=e,this.type=b.Invalid,this.constraint=function(t){return!0},this.implementationType=null,this.cache=null,this.factory=null,this.provider=null,this.onActivation=null,this.onDeactivation=null,this.dynamicValue=null}return Binding2.prototype.clone=function(){var t=new Binding2(this.serviceIdentifier,this.scope);return t.activated=t.scope===A.Singleton&&this.activated,t.implementationType=this.implementationType,t.dynamicValue=this.dynamicValue,t.scope=this.scope,t.type=this.type,t.factory=this.factory,t.provider=this.provider,t.constraint=this.constraint,t.onActivation=this.onActivation,t.onDeactivation=this.onDeactivation,t.cache=this.cache,t},Binding2}(),E="Metadata key was used more than once in a parameter:",M="NULL argument",T="Key Not Found",x="Ambiguous match found for serviceIdentifier:",N="No matching bindings found for serviceIdentifier:",P="Missing required @injectable annotation in:",D="Missing required @inject or @multiInject annotation in:",L="Circular dependency found:",O="The @inject @multiInject @tagged and @named decorators must be applied to the parameters of a class constructor or a class property.",ARGUMENTS_LENGTH_MISMATCH=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return"The number of constructor arguments in the derived class "+t[0]+" must be >= than the number of constructor arguments of its base class."},POST_CONSTRUCT_ERROR=function(t,e){return"@postConstruct error in class "+t+": "+e},PRE_DESTROY_ERROR=function(t,e){return"@preDestroy error in class "+t+": "+e},ON_DEACTIVATION_ERROR=function(t,e){return"onDeactivation() error in class "+t+": "+e},B="Maximum call stack size exceeded",R=function(){function MetadataReader2(){}return MetadataReader2.prototype.getConstructorMetadata=function(t){return{compilerGeneratedMetadata:Reflect.getMetadata(f,t),userGeneratedMetadata:Reflect.getMetadata(g,t)||{}}},MetadataReader2.prototype.getPropertiesMetadata=function(t){return Reflect.getMetadata(m,t)||[]},MetadataReader2}(),_={MultipleBindingsAvailable:2,NoBindingsAvailable:0,OnlyOneBindingAvailable:1};function isStackOverflowExeption(t){return t instanceof RangeError||t.message===B}function getServiceIdentifierAsString(t){return"function"==typeof t?t.name:"symbol"==typeof t?t.toString():t}function listRegisteredBindingsForServiceIdentifier(t,e,n){var i="",r=n(t,e);return 0!==r.length&&(i="\nRegistered bindings:",r.forEach((function(t){var e="Object";null!==t.implementationType&&(e=getFunctionName(t.implementationType)),i=i+"\n "+e,t.constraint.metaData&&(i=i+" - "+t.constraint.metaData)}))),i}function alreadyDependencyChain(t,e){return null!==t.parentRequest&&(t.parentRequest.serviceIdentifier===e||alreadyDependencyChain(t.parentRequest,e))}function circularDependencyToException(t){t.childRequests.forEach((function(t){if(alreadyDependencyChain(t,t.serviceIdentifier)){var e=function dependencyChainToString(t){var e=function _createStringArr(t,e){void 0===e&&(e=[]);var n=getServiceIdentifierAsString(t.serviceIdentifier);return e.push(n),null!==t.parentRequest?_createStringArr(t.parentRequest,e):e}(t);return e.reverse().join(" --\x3e ")}(t);throw new Error(L+" "+e)}circularDependencyToException(t)}))}function getFunctionName(t){if(t.name)return t.name;var e=t.toString(),n=e.match(/^function\s*([^\s(]+)/);return n?n[1]:"Anonymous function: "+e}var k=function(){function Context2(t){this.id=id(),this.container=t}return Context2.prototype.addPlan=function(t){this.plan=t},Context2.prototype.setCurrentRequest=function(t){this.currentRequest=t},Context2}(),W=function(){function Metadata2(t,e){this.key=t,this.value=e}return Metadata2.prototype.toString=function(){return this.key===c?"named: "+String(this.value).toString()+" ":"tagged: { key:"+this.key.toString()+", value: "+String(this.value)+" }"},Metadata2}(),j=function(){return function Plan2(t,e){this.parentContext=t,this.rootRequest=e}}(),V=function(){function LazyServiceIdentifier2(t){this._cb=t}return LazyServiceIdentifier2.prototype.unwrap=function(){return this._cb()},LazyServiceIdentifier2}(),q=function(){function QueryableString2(t){this.str=t}return QueryableString2.prototype.startsWith=function(t){return 0===this.str.indexOf(t)},QueryableString2.prototype.endsWith=function(t){var e,n=t.split("").reverse().join("");return e=this.str.split("").reverse().join(""),this.startsWith.call({str:e},n)},QueryableString2.prototype.contains=function(t){return-1!==this.str.indexOf(t)},QueryableString2.prototype.equals=function(t){return this.str===t},QueryableString2.prototype.value=function(){return this.str},QueryableString2}(),X=function(){function Target2(t,e,n,i){this.id=id(),this.type=t,this.serviceIdentifier=n;var r="symbol"==typeof e?function getSymbolDescription(t){return t.toString().slice(7,-1)}(e):e;this.name=new q(r||""),this.identifier=e,this.metadata=new Array;var s=null;"string"==typeof i?s=new W(c,i):i instanceof W&&(s=i),null!==s&&this.metadata.push(s)}return Target2.prototype.hasTag=function(t){for(var e=0,n=this.metadata;e<n.length;e++){if(n[e].key===t)return!0}return!1},Target2.prototype.isArray=function(){return this.hasTag(p)},Target2.prototype.matchesArray=function(t){return this.matchesTag(p)(t)},Target2.prototype.isNamed=function(){return this.hasTag(c)},Target2.prototype.isTagged=function(){return this.metadata.some((function(t){return S.every((function(e){return t.key!==e}))}))},Target2.prototype.isOptional=function(){return this.matchesTag(d)(!0)},Target2.prototype.getNamedTag=function(){return this.isNamed()?this.metadata.filter((function(t){return t.key===c}))[0]:null},Target2.prototype.getCustomTags=function(){return this.isTagged()?this.metadata.filter((function(t){return S.every((function(e){return t.key!==e}))})):null},Target2.prototype.matchesNamedTag=function(t){return this.matchesTag(c)(t)},Target2.prototype.matchesTag=function(t){var e=this;return function(n){for(var i=0,r=e.metadata;i<r.length;i++){var s=r[i];if(s.key===t&&s.value===n)return!0}return!1}},Target2}(),__spreadArray$2=function(t,e,n){if(n||2===arguments.length)for(var i,r=0,s=e.length;r<s;r++)!i&&r in e||(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))};function getTargets(t,e,n,i){var r=t.getConstructorMetadata(n),s=r.compilerGeneratedMetadata;if(void 0===s)throw new Error(P+" "+e+".");var o=r.userGeneratedMetadata,a=Object.keys(o),c=0===n.length&&a.length>0,h=a.length>n.length,u=function getConstructorArgsAsTargets(t,e,n,i,r){for(var s=[],o=0;o<r;o++){var a=getConstructorArgsAsTarget(o,t,e,n,i);null!==a&&s.push(a)}return s}(i,e,s,o,c||h?a.length:n.length),d=getClassPropsAsTargets(t,n,e);return __spreadArray$2(__spreadArray$2([],u,!0),d,!0)}function getConstructorArgsAsTarget(t,e,n,i,r){var s=r[t.toString()]||[],o=formatTargetMetadata(s),a=!0!==o.unmanaged,c=i[t],h=o.inject||o.multiInject;if((c=h||c)instanceof V&&(c=c.unwrap()),a){if(!e&&(c===Object||c===Function||void 0===c))throw new Error(D+" argument "+t+" in class "+n+".");var u=new X(C.ConstructorArgument,o.targetName,c);return u.metadata=s,u}return null}function _getServiceIdentifierForProperty(t,e,n,i){var r=t||e;if(void 0===r){var s=P+" for property "+String(n)+" in class "+i+".";throw new Error(s)}return r}function getClassPropsAsTargets(t,e,n){for(var i=t.getPropertiesMetadata(e),r=[],s=Object.getOwnPropertySymbols(i),o=0,a=Object.keys(i).concat(s);o<a.length;o++){var c=a[o],h=i[c],u=formatTargetMetadata(h),d=u.targetName||c,l=_getServiceIdentifierForProperty(u.inject,u.multiInject,c,n),p=new X(C.ClassProperty,d,l);p.metadata=h,r.push(p)}var g=Object.getPrototypeOf(e.prototype).constructor;if(g!==Object){var m=getClassPropsAsTargets(t,g,n);r=__spreadArray$2(__spreadArray$2([],r,!0),m,!0)}return r}function getBaseClassDependencyCount(t,e){var n=Object.getPrototypeOf(e.prototype).constructor;if(n!==Object){var i=getTargets(t,getFunctionName(n),n,!0),r=i.map((function(t){return t.metadata.filter((function(t){return t.key===u}))})),s=[].concat.apply([],r).length,o=i.length-s;return o>0?o:getBaseClassDependencyCount(t,n)}return 0}function formatTargetMetadata(t){var e={};return t.forEach((function(t){e[t.key.toString()]=t.value})),{inject:e[l],multiInject:e[p],targetName:e[h],unmanaged:e[u]}}var Y=function(){function Request2(t,e,n,i,r){this.id=id(),this.serviceIdentifier=t,this.parentContext=e,this.parentRequest=n,this.target=r,this.childRequests=[],this.bindings=Array.isArray(i)?i:[i],this.requestScope=null===n?new Map:null}return Request2.prototype.addChildRequest=function(t,e,n){var i=new Request2(t,this.parentContext,this,e,n);return this.childRequests.push(i),i},Request2}();function getBindingDictionary(t){return t._bindingDictionary}function _getActiveBindings(t,e,n,i,r){var s=getBindings(n.container,r.serviceIdentifier),o=[];return s.length===_.NoBindingsAvailable&&n.container.options.autoBindInjectable&&"function"==typeof r.serviceIdentifier&&t.getConstructorMetadata(r.serviceIdentifier).compilerGeneratedMetadata&&(n.container.bind(r.serviceIdentifier).toSelf(),s=getBindings(n.container,r.serviceIdentifier)),o=e?s:s.filter((function(t){var e=new Y(t.serviceIdentifier,n,i,t,r);return t.constraint(e)})),function _validateActiveBindingCount(t,e,n,i){switch(e.length){case _.NoBindingsAvailable:if(n.isOptional())return e;var r=getServiceIdentifierAsString(t),s=N;throw s+=function listMetadataForTarget(t,e){if(e.isTagged()||e.isNamed()){var n="",i=e.getNamedTag(),r=e.getCustomTags();return null!==i&&(n+=i.toString()+"\n"),null!==r&&r.forEach((function(t){n+=t.toString()+"\n"}))," "+t+"\n "+t+" - "+n}return" "+t}(r,n),s+=listRegisteredBindingsForServiceIdentifier(i,r,getBindings),new Error(s);case _.OnlyOneBindingAvailable:return e;case _.MultipleBindingsAvailable:default:if(n.isArray())return e;r=getServiceIdentifierAsString(t),s=x+" "+r;throw s+=listRegisteredBindingsForServiceIdentifier(i,r,getBindings),new Error(s)}}(r.serviceIdentifier,o,r,n.container),o}function _createSubRequests(t,e,n,i,r,s){var o,a;if(null===r){o=_getActiveBindings(t,e,i,null,s),a=new Y(n,i,null,o,s);var c=new j(i,a);i.addPlan(c)}else o=_getActiveBindings(t,e,i,r,s),a=r.addChildRequest(s.serviceIdentifier,o,s);o.forEach((function(e){var n=null;if(s.isArray())n=a.addChildRequest(e.serviceIdentifier,e,s);else{if(e.cache)return;n=a}if(e.type===b.Instance&&null!==e.implementationType){var r=function getDependencies(t,e){return getTargets(t,getFunctionName(e),e,!1)}(t,e.implementationType);if(!i.container.options.skipBaseClassChecks){var o=getBaseClassDependencyCount(t,e.implementationType);if(r.length<o){var c=ARGUMENTS_LENGTH_MISMATCH(getFunctionName(e.implementationType));throw new Error(c)}}r.forEach((function(e){_createSubRequests(t,!1,e.serviceIdentifier,i,n,e)}))}}))}function getBindings(t,e){var n=[],i=getBindingDictionary(t);return i.hasKey(e)?n=i.get(e):null!==t.parent&&(n=getBindings(t.parent,e)),n}function plan(t,e,n,i,r,s,o,a){void 0===a&&(a=!1);var c=new k(e),h=function _createTarget(t,e,n,i,r,s){var o=new W(t?p:l,n),a=new X(e,i,n,o);if(void 0!==r){var c=new W(r,s);a.metadata.push(c)}return a}(n,i,r,"",s,o);try{return _createSubRequests(t,a,r,c,null,h),c}catch(u){throw isStackOverflowExeption(u)&&circularDependencyToException(c.plan.rootRequest),u}}function isPromise(t){return("object"==typeof t&&null!==t||"function"==typeof t)&&"function"==typeof t.then}function isPromiseOrContainsPromise(t){return!!isPromise(t)||Array.isArray(t)&&t.some(isPromise)}var H,F,__awaiter$3=function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function fulfilled(t){try{step(i.next(t))}catch(e){s(e)}}function rejected(t){try{step(i.throw(t))}catch(e){s(e)}}function step(t){t.done?r(t.value):function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((i=i.apply(t,e||[])).next())}))},__generator$3=function(t,e){var n,i,r,s,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function verb(s){return function(a){return function step(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){o.label=s[1];break}if(6===s[0]&&o.label<r[1]){o.label=r[1],r=s;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(s);break}r[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(a){s=[6,a],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},_saveToRequestScope=function(t,e,n){t.has(e.id)||t.set(e.id,n)},_saveToSingletonScope=function(t,e){t.cache=e,t.activated=!0,isPromise(e)&&_saveAsyncResultToSingletonScope(t,e)},_saveAsyncResultToSingletonScope=function(t,e){return __awaiter$3(void 0,void 0,void 0,(function(){var n,i;return __generator$3(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,e];case 1:return n=r.sent(),t.cache=n,[3,3];case 2:throw i=r.sent(),t.cache=null,t.activated=!1,i;case 3:return[2]}}))}))};(F=H||(H={})).DynamicValue="toDynamicValue",F.Factory="toFactory",F.Provider="toProvider";var __assign$1=function(){return __assign$1=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},__assign$1.apply(this,arguments)},__awaiter$2=function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function fulfilled(t){try{step(i.next(t))}catch(e){s(e)}}function rejected(t){try{step(i.throw(t))}catch(e){s(e)}}function step(t){t.done?r(t.value):function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((i=i.apply(t,e||[])).next())}))},__generator$2=function(t,e){var n,i,r,s,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function verb(s){return function(a){return function step(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){o.label=s[1];break}if(6===s[0]&&o.label<r[1]){o.label=r[1],r=s;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(s);break}r[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(a){s=[6,a],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},__spreadArray$1=function(t,e,n){if(n||2===arguments.length)for(var i,r=0,s=e.length;r<s;r++)!i&&r in e||(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))};function _createInstance(t,e,n){var i;if(e.length>0){var r=function _resolveRequests(t,e){return t.reduce((function(t,n){var i=e(n);return n.target.type===C.ConstructorArgument?t.constructorInjections.push(i):(t.propertyRequests.push(n),t.propertyInjections.push(i)),t.isAsync||(t.isAsync=isPromiseOrContainsPromise(i)),t}),{constructorInjections:[],propertyInjections:[],propertyRequests:[],isAsync:!1})}(e,n),s=__assign$1(__assign$1({},r),{constr:t});i=r.isAsync?function createInstanceWithInjectionsAsync(t){return __awaiter$2(this,void 0,void 0,(function(){var e,n;return __generator$2(this,(function(i){switch(i.label){case 0:return[4,possiblyWaitInjections(t.constructorInjections)];case 1:return e=i.sent(),[4,possiblyWaitInjections(t.propertyInjections)];case 2:return n=i.sent(),[2,createInstanceWithInjections(__assign$1(__assign$1({},t),{constructorInjections:e,propertyInjections:n}))]}}))}))}(s):createInstanceWithInjections(s)}else i=new t;return i}function createInstanceWithInjections(t){var e,n=new((e=t.constr).bind.apply(e,__spreadArray$1([void 0],t.constructorInjections,!1)));return t.propertyRequests.forEach((function(e,i){var r=e.target.identifier,s=t.propertyInjections[i];e.target.isOptional()&&void 0===s||(n[r]=s)})),n}function possiblyWaitInjections(t){return __awaiter$2(this,void 0,void 0,(function(){var e,n,i,r;return __generator$2(this,(function(s){for(e=[],n=0,i=t;n<i.length;n++)r=i[n],Array.isArray(r)?e.push(Promise.all(r)):e.push(r);return[2,Promise.all(e)]}))}))}function _getInstanceAfterPostConstruct(t,e){var n=function _postConstruct(t,e){var n,i;if(Reflect.hasMetadata(y,t)){var r=Reflect.getMetadata(y,t);try{return null===(i=(n=e)[r.value])||void 0===i?void 0:i.call(n)}catch(s){if(s instanceof Error)throw new Error(POST_CONSTRUCT_ERROR(t.name,s.message))}}}(t,e);return isPromise(n)?n.then((function(){return e})):e}function _validateInstanceResolution(t,e){t.scope!==A.Singleton&&function _throwIfHandlingDeactivation(t,e){var n="Class cannot be instantiated in "+(t.scope===A.Request?"request":"transient")+" scope.";if("function"==typeof t.onDeactivation)throw new Error(ON_DEACTIVATION_ERROR(e.name,n));if(Reflect.hasMetadata(v,e))throw new Error(PRE_DESTROY_ERROR(e.name,n))}(t,e)}var __awaiter$1=function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function fulfilled(t){try{step(i.next(t))}catch(e){s(e)}}function rejected(t){try{step(i.throw(t))}catch(e){s(e)}}function step(t){t.done?r(t.value):function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((i=i.apply(t,e||[])).next())}))},__generator$1=function(t,e){var n,i,r,s,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function verb(s){return function(a){return function step(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){o.label=s[1];break}if(6===s[0]&&o.label<r[1]){o.label=r[1],r=s;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(s);break}r[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(a){s=[6,a],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},_resolveRequest=function(t){return function(e){e.parentContext.setCurrentRequest(e);var n=e.bindings,i=e.childRequests,r=e.target&&e.target.isArray(),s=!(e.parentRequest&&e.parentRequest.target&&e.target&&e.parentRequest.target.matchesArray(e.target.serviceIdentifier));if(r&&s)return i.map((function(e){return _resolveRequest(t)(e)}));if(!e.target.isOptional()||0!==n.length){var o=n[0];return _resolveBinding(t,e,o)}}},_resolveFactoryFromBinding=function(t,e){var n=function(t){switch(t.type){case b.Factory:return{factory:t.factory,factoryType:H.Factory};case b.Provider:return{factory:t.provider,factoryType:H.Provider};case b.DynamicValue:return{factory:t.dynamicValue,factoryType:H.DynamicValue};default:throw new Error("Unexpected factory type "+t.type)}}(t);return function(t,e){try{return t()}catch(n){throw isStackOverflowExeption(n)&&(n=e()),n}}((function(){return n.factory.bind(t)(e)}),(function(){return new Error((t=n.factoryType,i=e.currentRequest.serviceIdentifier.toString(),"It looks like there is a circular dependency in one of the '"+t+"' bindings. Please investigate bindings with service identifier '"+i+"'."));var t,i}))},_getResolvedFromBinding=function(t,e,n){var i,r=e.childRequests;switch(function(t){var e=null;switch(t.type){case b.ConstantValue:case b.Function:e=t.cache;break;case b.Constructor:case b.Instance:e=t.implementationType;break;case b.DynamicValue:e=t.dynamicValue;break;case b.Provider:e=t.provider;break;case b.Factory:e=t.factory}if(null===e){var n=getServiceIdentifierAsString(t.serviceIdentifier);throw new Error("Invalid binding type: "+n)}}(n),n.type){case b.ConstantValue:case b.Function:i=n.cache;break;case b.Constructor:i=n.implementationType;break;case b.Instance:i=function resolveInstance(t,e,n,i){_validateInstanceResolution(t,e);var r=_createInstance(e,n,i);return isPromise(r)?r.then((function(t){return _getInstanceAfterPostConstruct(e,t)})):_getInstanceAfterPostConstruct(e,r)}(n,n.implementationType,r,_resolveRequest(t));break;default:i=_resolveFactoryFromBinding(n,e.parentContext)}return i},_resolveInScope=function(t,e,n){var i=function(t,e){return e.scope===A.Singleton&&e.activated?e.cache:e.scope===A.Request&&t.has(e.id)?t.get(e.id):null}(t,e);return null!==i||function(t,e,n){e.scope===A.Singleton&&_saveToSingletonScope(e,n),e.scope===A.Request&&_saveToRequestScope(t,e,n)}(t,e,i=n()),i},_resolveBinding=function(t,e,n){return _resolveInScope(t,n,(function(){var i=_getResolvedFromBinding(t,e,n);return i=isPromise(i)?i.then((function(t){return _onActivation(e,n,t)})):_onActivation(e,n,i)}))};function _onActivation(t,e,n){var i,r=_bindingActivation(t.parentContext,e,n),s=_getContainersIterator(t.parentContext.container),o=s.next();do{i=o.value;var a=t.parentContext,c=t.serviceIdentifier,h=_getContainerActivationsForService(i,c);r=isPromise(r)?_activateContainerAsync(h,a,r):_activateContainer(h,a,r),o=s.next()}while(!0!==o.done&&!getBindingDictionary(i).hasKey(t.serviceIdentifier));return r}var _bindingActivation=function(t,e,n){return"function"==typeof e.onActivation?e.onActivation(t,n):n},_activateContainer=function(t,e,n){for(var i=t.next();!i.done;){if(isPromise(n=i.value(e,n)))return _activateContainerAsync(t,e,n);i=t.next()}return n},_activateContainerAsync=function(t,e,n){return __awaiter$1(void 0,void 0,void 0,(function(){var i,r;return __generator$1(this,(function(s){switch(s.label){case 0:return[4,n];case 1:i=s.sent(),r=t.next(),s.label=2;case 2:return r.done?[3,4]:[4,r.value(e,i)];case 3:return i=s.sent(),r=t.next(),[3,2];case 4:return[2,i]}}))}))},_getContainerActivationsForService=function(t,e){var n=t._activations;return n.hasKey(e)?n.get(e).values():[].values()},_getContainersIterator=function(t){for(var e=[t],n=t.parent;null!==n;)e.push(n),n=n.parent;return{next:function(){var t=e.pop();return void 0!==t?{done:!1,value:t}:{done:!0,value:void 0}}}};var traverseAncerstors=function(t,e){var n=t.parentRequest;return null!==n&&(!!e(n)||traverseAncerstors(n,e))},taggedConstraint=function(t){return function(e){var constraint=function(n){return null!==n&&null!==n.target&&n.target.matchesTag(t)(e)};return constraint.metaData=new W(t,e),constraint}},K=taggedConstraint(c),typeConstraint=function(t){return function(e){var n=null;if(null!==e){if(n=e.bindings[0],"string"==typeof t)return n.serviceIdentifier===t;var i=e.bindings[0].implementationType;return t===i}return!1}},U=function(){function BindingWhenSyntax2(t){this._binding=t}return BindingWhenSyntax2.prototype.when=function(t){return this._binding.constraint=t,new z(this._binding)},BindingWhenSyntax2.prototype.whenTargetNamed=function(t){return this._binding.constraint=K(t),new z(this._binding)},BindingWhenSyntax2.prototype.whenTargetIsDefault=function(){return this._binding.constraint=function(t){return null!==t&&(null!==t.target&&!t.target.isNamed()&&!t.target.isTagged())},new z(this._binding)},BindingWhenSyntax2.prototype.whenTargetTagged=function(t,e){return this._binding.constraint=taggedConstraint(t)(e),new z(this._binding)},BindingWhenSyntax2.prototype.whenInjectedInto=function(t){return this._binding.constraint=function(e){return null!==e&&typeConstraint(t)(e.parentRequest)},new z(this._binding)},BindingWhenSyntax2.prototype.whenParentNamed=function(t){return this._binding.constraint=function(e){return null!==e&&K(t)(e.parentRequest)},new z(this._binding)},BindingWhenSyntax2.prototype.whenParentTagged=function(t,e){return this._binding.constraint=function(n){return null!==n&&taggedConstraint(t)(e)(n.parentRequest)},new z(this._binding)},BindingWhenSyntax2.prototype.whenAnyAncestorIs=function(t){return this._binding.constraint=function(e){return null!==e&&traverseAncerstors(e,typeConstraint(t))},new z(this._binding)},BindingWhenSyntax2.prototype.whenNoAncestorIs=function(t){return this._binding.constraint=function(e){return null!==e&&!traverseAncerstors(e,typeConstraint(t))},new z(this._binding)},BindingWhenSyntax2.prototype.whenAnyAncestorNamed=function(t){return this._binding.constraint=function(e){return null!==e&&traverseAncerstors(e,K(t))},new z(this._binding)},BindingWhenSyntax2.prototype.whenNoAncestorNamed=function(t){return this._binding.constraint=function(e){return null!==e&&!traverseAncerstors(e,K(t))},new z(this._binding)},BindingWhenSyntax2.prototype.whenAnyAncestorTagged=function(t,e){return this._binding.constraint=function(n){return null!==n&&traverseAncerstors(n,taggedConstraint(t)(e))},new z(this._binding)},BindingWhenSyntax2.prototype.whenNoAncestorTagged=function(t,e){return this._binding.constraint=function(n){return null!==n&&!traverseAncerstors(n,taggedConstraint(t)(e))},new z(this._binding)},BindingWhenSyntax2.prototype.whenAnyAncestorMatches=function(t){return this._binding.constraint=function(e){return null!==e&&traverseAncerstors(e,t)},new z(this._binding)},BindingWhenSyntax2.prototype.whenNoAncestorMatches=function(t){return this._binding.constraint=function(e){return null!==e&&!traverseAncerstors(e,t)},new z(this._binding)},BindingWhenSyntax2}(),z=function(){function BindingOnSyntax2(t){this._binding=t}return BindingOnSyntax2.prototype.onActivation=function(t){return this._binding.onActivation=t,new U(this._binding)},BindingOnSyntax2.prototype.onDeactivation=function(t){return this._binding.onDeactivation=t,new U(this._binding)},BindingOnSyntax2}(),G=function(){function BindingWhenOnSyntax2(t){this._binding=t,this._bindingWhenSyntax=new U(this._binding),this._bindingOnSyntax=new z(this._binding)}return BindingWhenOnSyntax2.prototype.when=function(t){return this._bindingWhenSyntax.when(t)},BindingWhenOnSyntax2.prototype.whenTargetNamed=function(t){return this._bindingWhenSyntax.whenTargetNamed(t)},BindingWhenOnSyntax2.prototype.whenTargetIsDefault=function(){return this._bindingWhenSyntax.whenTargetIsDefault()},BindingWhenOnSyntax2.prototype.whenTargetTagged=function(t,e){return this._bindingWhenSyntax.whenTargetTagged(t,e)},BindingWhenOnSyntax2.prototype.whenInjectedInto=function(t){return this._bindingWhenSyntax.whenInjectedInto(t)},BindingWhenOnSyntax2.prototype.whenParentNamed=function(t){return this._bindingWhenSyntax.whenParentNamed(t)},BindingWhenOnSyntax2.prototype.whenParentTagged=function(t,e){return this._bindingWhenSyntax.whenParentTagged(t,e)},BindingWhenOnSyntax2.prototype.whenAnyAncestorIs=function(t){return this._bindingWhenSyntax.whenAnyAncestorIs(t)},BindingWhenOnSyntax2.prototype.whenNoAncestorIs=function(t){return this._bindingWhenSyntax.whenNoAncestorIs(t)},BindingWhenOnSyntax2.prototype.whenAnyAncestorNamed=function(t){return this._bindingWhenSyntax.whenAnyAncestorNamed(t)},BindingWhenOnSyntax2.prototype.whenAnyAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenAnyAncestorTagged(t,e)},BindingWhenOnSyntax2.prototype.whenNoAncestorNamed=function(t){return this._bindingWhenSyntax.whenNoAncestorNamed(t)},BindingWhenOnSyntax2.prototype.whenNoAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenNoAncestorTagged(t,e)},BindingWhenOnSyntax2.prototype.whenAnyAncestorMatches=function(t){return this._bindingWhenSyntax.whenAnyAncestorMatches(t)},BindingWhenOnSyntax2.prototype.whenNoAncestorMatches=function(t){return this._bindingWhenSyntax.whenNoAncestorMatches(t)},BindingWhenOnSyntax2.prototype.onActivation=function(t){return this._bindingOnSyntax.onActivation(t)},BindingWhenOnSyntax2.prototype.onDeactivation=function(t){return this._bindingOnSyntax.onDeactivation(t)},BindingWhenOnSyntax2}(),Q=function(){function BindingInSyntax2(t){this._binding=t}return BindingInSyntax2.prototype.inRequestScope=function(){return this._binding.scope=A.Request,new G(this._binding)},BindingInSyntax2.prototype.inSingletonScope=function(){return this._binding.scope=A.Singleton,new G(this._binding)},BindingInSyntax2.prototype.inTransientScope=function(){return this._binding.scope=A.Transient,new G(this._binding)},BindingInSyntax2}(),$=function(){function BindingInWhenOnSyntax2(t){this._binding=t,this._bindingWhenSyntax=new U(this._binding),this._bindingOnSyntax=new z(this._binding),this._bindingInSyntax=new Q(t)}return BindingInWhenOnSyntax2.prototype.inRequestScope=function(){return this._bindingInSyntax.inRequestScope()},BindingInWhenOnSyntax2.prototype.inSingletonScope=function(){return this._bindingInSyntax.inSingletonScope()},BindingInWhenOnSyntax2.prototype.inTransientScope=function(){return this._bindingInSyntax.inTransientScope()},BindingInWhenOnSyntax2.prototype.when=function(t){return this._bindingWhenSyntax.when(t)},BindingInWhenOnSyntax2.prototype.whenTargetNamed=function(t){return this._bindingWhenSyntax.whenTargetNamed(t)},BindingInWhenOnSyntax2.prototype.whenTargetIsDefault=function(){return this._bindingWhenSyntax.whenTargetIsDefault()},BindingInWhenOnSyntax2.prototype.whenTargetTagged=function(t,e){return this._bindingWhenSyntax.whenTargetTagged(t,e)},BindingInWhenOnSyntax2.prototype.whenInjectedInto=function(t){return this._bindingWhenSyntax.whenInjectedInto(t)},BindingInWhenOnSyntax2.prototype.whenParentNamed=function(t){return this._bindingWhenSyntax.whenParentNamed(t)},BindingInWhenOnSyntax2.prototype.whenParentTagged=function(t,e){return this._bindingWhenSyntax.whenParentTagged(t,e)},BindingInWhenOnSyntax2.prototype.whenAnyAncestorIs=function(t){return this._bindingWhenSyntax.whenAnyAncestorIs(t)},BindingInWhenOnSyntax2.prototype.whenNoAncestorIs=function(t){return this._bindingWhenSyntax.whenNoAncestorIs(t)},BindingInWhenOnSyntax2.prototype.whenAnyAncestorNamed=function(t){return this._bindingWhenSyntax.whenAnyAncestorNamed(t)},BindingInWhenOnSyntax2.prototype.whenAnyAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenAnyAncestorTagged(t,e)},BindingInWhenOnSyntax2.prototype.whenNoAncestorNamed=function(t){return this._bindingWhenSyntax.whenNoAncestorNamed(t)},BindingInWhenOnSyntax2.prototype.whenNoAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenNoAncestorTagged(t,e)},BindingInWhenOnSyntax2.prototype.whenAnyAncestorMatches=function(t){return this._bindingWhenSyntax.whenAnyAncestorMatches(t)},BindingInWhenOnSyntax2.prototype.whenNoAncestorMatches=function(t){return this._bindingWhenSyntax.whenNoAncestorMatches(t)},BindingInWhenOnSyntax2.prototype.onActivation=function(t){return this._bindingOnSyntax.onActivation(t)},BindingInWhenOnSyntax2.prototype.onDeactivation=function(t){return this._bindingOnSyntax.onDeactivation(t)},BindingInWhenOnSyntax2}(),J=function(){function BindingToSyntax2(t){this._binding=t}return BindingToSyntax2.prototype.to=function(t){return this._binding.type=b.Instance,this._binding.implementationType=t,new $(this._binding)},BindingToSyntax2.prototype.toSelf=function(){if("function"!=typeof this._binding.serviceIdentifier)throw new Error("The toSelf function can only be applied when a constructor is used as service identifier");var t=this._binding.serviceIdentifier;return this.to(t)},BindingToSyntax2.prototype.toConstantValue=function(t){return this._binding.type=b.ConstantValue,this._binding.cache=t,this._binding.dynamicValue=null,this._binding.implementationType=null,this._binding.scope=A.Singleton,new G(this._binding)},BindingToSyntax2.prototype.toDynamicValue=function(t){return this._binding.type=b.DynamicValue,this._binding.cache=null,this._binding.dynamicValue=t,this._binding.implementationType=null,new $(this._binding)},BindingToSyntax2.prototype.toConstructor=function(t){return this._binding.type=b.Constructor,this._binding.implementationType=t,this._binding.scope=A.Singleton,new G(this._binding)},BindingToSyntax2.prototype.toFactory=function(t){return this._binding.type=b.Factory,this._binding.factory=t,this._binding.scope=A.Singleton,new G(this._binding)},BindingToSyntax2.prototype.toFunction=function(t){if("function"!=typeof t)throw new Error("Value provided to function binding must be a function!");var e=this.toConstantValue(t);return this._binding.type=b.Function,this._binding.scope=A.Singleton,e},BindingToSyntax2.prototype.toAutoFactory=function(t){return this._binding.type=b.Factory,this._binding.factory=function(e){return function(){return e.container.get(t)}},this._binding.scope=A.Singleton,new G(this._binding)},BindingToSyntax2.prototype.toAutoNamedFactory=function(t){return this._binding.type=b.Factory,this._binding.factory=function(e){return function(n){return e.container.getNamed(t,n)}},new G(this._binding)},BindingToSyntax2.prototype.toProvider=function(t){return this._binding.type=b.Provider,this._binding.provider=t,this._binding.scope=A.Singleton,new G(this._binding)},BindingToSyntax2.prototype.toService=function(t){this.toDynamicValue((function(e){return e.container.get(t)}))},BindingToSyntax2}(),Z=function(){function ContainerSnapshot2(){}return ContainerSnapshot2.of=function(t,e,n,i,r){var s=new ContainerSnapshot2;return s.bindings=t,s.middleware=e,s.deactivations=i,s.activations=n,s.moduleActivationStore=r,s},ContainerSnapshot2}();var tt=function(){function Lookup2(){this._map=new Map}return Lookup2.prototype.getMap=function(){return this._map},Lookup2.prototype.add=function(t,e){if(null==t)throw new Error(M);if(null==e)throw new Error(M);var n=this._map.get(t);void 0!==n?n.push(e):this._map.set(t,[e])},Lookup2.prototype.get=function(t){if(null==t)throw new Error(M);var e=this._map.get(t);if(void 0!==e)return e;throw new Error(T)},Lookup2.prototype.remove=function(t){if(null==t)throw new Error(M);if(!this._map.delete(t))throw new Error(T)},Lookup2.prototype.removeIntersection=function(t){var e=this;this.traverse((function(n,i){var r=t.hasKey(n)?t.get(n):void 0;if(void 0!==r){var s=i.filter((function(t){return!r.some((function(e){return t===e}))}));e._setValue(n,s)}}))},Lookup2.prototype.removeByCondition=function(t){var e=this,n=[];return this._map.forEach((function(i,r){for(var s=[],o=0,a=i;o<a.length;o++){var c=a[o];t(c)?n.push(c):s.push(c)}e._setValue(r,s)})),n},Lookup2.prototype.hasKey=function(t){if(null==t)throw new Error(M);return this._map.has(t)},Lookup2.prototype.clone=function(){var t=new Lookup2;return this._map.forEach((function(e,n){e.forEach((function(e){return t.add(n,function isClonable(t){return"object"==typeof t&&null!==t&&"clone"in t&&"function"==typeof t.clone}(e)?e.clone():e)}))})),t},Lookup2.prototype.traverse=function(t){this._map.forEach((function(e,n){t(n,e)}))},Lookup2.prototype._setValue=function(t,e){e.length>0?this._map.set(t,e):this._map.delete(t)},Lookup2}(),et=function(){function ModuleActivationStore2(){this._map=new Map}return ModuleActivationStore2.prototype.remove=function(t){if(this._map.has(t)){var e=this._map.get(t);return this._map.delete(t),e}return this._getEmptyHandlersStore()},ModuleActivationStore2.prototype.addDeactivation=function(t,e,n){this._getModuleActivationHandlers(t).onDeactivations.add(e,n)},ModuleActivationStore2.prototype.addActivation=function(t,e,n){this._getModuleActivationHandlers(t).onActivations.add(e,n)},ModuleActivationStore2.prototype.clone=function(){var t=new ModuleActivationStore2;return this._map.forEach((function(e,n){t._map.set(n,{onActivations:e.onActivations.clone(),onDeactivations:e.onDeactivations.clone()})})),t},ModuleActivationStore2.prototype._getModuleActivationHandlers=function(t){var e=this._map.get(t);return void 0===e&&(e=this._getEmptyHandlersStore(),this._map.set(t,e)),e},ModuleActivationStore2.prototype._getEmptyHandlersStore=function(){return{onActivations:new tt,onDeactivations:new tt}},ModuleActivationStore2}(),__assign=function(){return __assign=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},__assign.apply(this,arguments)},__awaiter=function(t,e,n,i){return new(n||(n=Promise))((function(r,s){function fulfilled(t){try{step(i.next(t))}catch(e){s(e)}}function rejected(t){try{step(i.throw(t))}catch(e){s(e)}}function step(t){t.done?r(t.value):function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((i=i.apply(t,e||[])).next())}))},__generator=function(t,e){var n,i,r,s,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function verb(s){return function(a){return function step(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){o.label=s[1];break}if(6===s[0]&&o.label<r[1]){o.label=r[1],r=s;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(s);break}r[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(a){s=[6,a],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},nt=function(){function Container2(t){var e=t||{};if("object"!=typeof e)throw new Error("Invalid Container constructor argument. Container options must be an object.");if(void 0===e.defaultScope)e.defaultScope=A.Transient;else if(e.defaultScope!==A.Singleton&&e.defaultScope!==A.Transient&&e.defaultScope!==A.Request)throw new Error('Invalid Container option. Default scope must be a string ("singleton" or "transient").');if(void 0===e.autoBindInjectable)e.autoBindInjectable=!1;else if("boolean"!=typeof e.autoBindInjectable)throw new Error("Invalid Container option. Auto bind injectable must be a boolean");if(void 0===e.skipBaseClassChecks)e.skipBaseClassChecks=!1;else if("boolean"!=typeof e.skipBaseClassChecks)throw new Error("Invalid Container option. Skip base check must be a boolean");this.options={autoBindInjectable:e.autoBindInjectable,defaultScope:e.defaultScope,skipBaseClassChecks:e.skipBaseClassChecks},this.id=id(),this._bindingDictionary=new tt,this._snapshots=[],this._middleware=null,this._activations=new tt,this._deactivations=new tt,this.parent=null,this._metadataReader=new R,this._moduleActivationStore=new et}return Container2.merge=function(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];var r=new Container2,s=function(t,e,n){if(n||2===arguments.length)for(var i,r=0,s=e.length;r<s;r++)!i&&r in e||(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))}([t,e],n,!0).map((function(t){return getBindingDictionary(t)})),o=getBindingDictionary(r);return s.forEach((function(t){!function copyDictionary(t,e){t.traverse((function(t,n){n.forEach((function(t){e.add(t.serviceIdentifier,t.clone())}))}))}(t,o)})),r},Container2.prototype.load=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=this._getContainerModuleHelpersFactory(),i=0,r=t;i<r.length;i++){var s=r[i],o=n(s.id);s.registry(o.bindFunction,o.unbindFunction,o.isboundFunction,o.rebindFunction,o.unbindAsyncFunction,o.onActivationFunction,o.onDeactivationFunction)}},Container2.prototype.loadAsync=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return __awaiter(this,void 0,void 0,(function(){var e,n,i,r,s;return __generator(this,(function(o){switch(o.label){case 0:e=this._getContainerModuleHelpersFactory(),n=0,i=t,o.label=1;case 1:return n<i.length?(r=i[n],s=e(r.id),[4,r.registry(s.bindFunction,s.unbindFunction,s.isboundFunction,s.rebindFunction,s.unbindAsyncFunction,s.onActivationFunction,s.onDeactivationFunction)]):[3,4];case 2:o.sent(),o.label=3;case 3:return n++,[3,1];case 4:return[2]}}))}))},Container2.prototype.unload=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];e.forEach((function(e){var n=t._removeModuleBindings(e.id);t._deactivateSingletons(n),t._removeModuleHandlers(e.id)}))},Container2.prototype.unloadAsync=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return __awaiter(this,void 0,void 0,(function(){var e,n,i,r;return __generator(this,(function(s){switch(s.label){case 0:e=0,n=t,s.label=1;case 1:return e<n.length?(i=n[e],r=this._removeModuleBindings(i.id),[4,this._deactivateSingletonsAsync(r)]):[3,4];case 2:s.sent(),this._removeModuleHandlers(i.id),s.label=3;case 3:return e++,[3,1];case 4:return[2]}}))}))},Container2.prototype.bind=function(t){var e=this.options.defaultScope||A.Transient,n=new I(t,e);return this._bindingDictionary.add(t,n),new J(n)},Container2.prototype.rebind=function(t){return this.unbind(t),this.bind(t)},Container2.prototype.rebindAsync=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,this.unbindAsync(t)];case 1:return e.sent(),[2,this.bind(t)]}}))}))},Container2.prototype.unbind=function(t){if(this._bindingDictionary.hasKey(t)){var e=this._bindingDictionary.get(t);this._deactivateSingletons(e)}this._removeServiceFromDictionary(t)},Container2.prototype.unbindAsync=function(t){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(n){switch(n.label){case 0:return this._bindingDictionary.hasKey(t)?(e=this._bindingDictionary.get(t),[4,this._deactivateSingletonsAsync(e)]):[3,2];case 1:n.sent(),n.label=2;case 2:return this._removeServiceFromDictionary(t),[2]}}))}))},Container2.prototype.unbindAll=function(){var t=this;this._bindingDictionary.traverse((function(e,n){t._deactivateSingletons(n)})),this._bindingDictionary=new tt},Container2.prototype.unbindAllAsync=function(){return __awaiter(this,void 0,void 0,(function(){var t,e=this;return __generator(this,(function(n){switch(n.label){case 0:return t=[],this._bindingDictionary.traverse((function(n,i){t.push(e._deactivateSingletonsAsync(i))})),[4,Promise.all(t)];case 1:return n.sent(),this._bindingDictionary=new tt,[2]}}))}))},Container2.prototype.onActivation=function(t,e){this._activations.add(t,e)},Container2.prototype.onDeactivation=function(t,e){this._deactivations.add(t,e)},Container2.prototype.isBound=function(t){var e=this._bindingDictionary.hasKey(t);return!e&&this.parent&&(e=this.parent.isBound(t)),e},Container2.prototype.isCurrentBound=function(t){return this._bindingDictionary.hasKey(t)},Container2.prototype.isBoundNamed=function(t,e){return this.isBoundTagged(t,c,e)},Container2.prototype.isBoundTagged=function(t,e,n){var i=!1;if(this._bindingDictionary.hasKey(t)){var r=this._bindingDictionary.get(t),s=function createMockRequest(t,e,n,i){var r=new X(C.Variable,"",e,new W(n,i)),s=new k(t);return new Y(e,s,null,[],r)}(this,t,e,n);i=r.some((function(t){return t.constraint(s)}))}return!i&&this.parent&&(i=this.parent.isBoundTagged(t,e,n)),i},Container2.prototype.snapshot=function(){this._snapshots.push(Z.of(this._bindingDictionary.clone(),this._middleware,this._activations.clone(),this._deactivations.clone(),this._moduleActivationStore.clone()))},Container2.prototype.restore=function(){var t=this._snapshots.pop();if(void 0===t)throw new Error("No snapshot available to restore.");this._bindingDictionary=t.bindings,this._activations=t.activations,this._deactivations=t.deactivations,this._middleware=t.middleware,this._moduleActivationStore=t.moduleActivationStore},Container2.prototype.createChild=function(t){var e=new Container2(t||this.options);return e.parent=this,e},Container2.prototype.applyMiddleware=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=this._middleware?this._middleware:this._planAndResolve();this._middleware=t.reduce((function(t,e){return e(t)}),n)},Container2.prototype.applyCustomMetadataReader=function(t){this._metadataReader=t},Container2.prototype.get=function(t){var e=this._getNotAllArgs(t,!1);return this._getButThrowIfAsync(e)},Container2.prototype.getAsync=function(t){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(n){return e=this._getNotAllArgs(t,!1),[2,this._get(e)]}))}))},Container2.prototype.getTagged=function(t,e,n){var i=this._getNotAllArgs(t,!1,e,n);return this._getButThrowIfAsync(i)},Container2.prototype.getTaggedAsync=function(t,e,n){return __awaiter(this,void 0,void 0,(function(){var i;return __generator(this,(function(r){return i=this._getNotAllArgs(t,!1,e,n),[2,this._get(i)]}))}))},Container2.prototype.getNamed=function(t,e){return this.getTagged(t,c,e)},Container2.prototype.getNamedAsync=function(t,e){return this.getTaggedAsync(t,c,e)},Container2.prototype.getAll=function(t){var e=this._getAllArgs(t);return this._getButThrowIfAsync(e)},Container2.prototype.getAllAsync=function(t){var e=this._getAllArgs(t);return this._getAll(e)},Container2.prototype.getAllTagged=function(t,e,n){var i=this._getNotAllArgs(t,!0,e,n);return this._getButThrowIfAsync(i)},Container2.prototype.getAllTaggedAsync=function(t,e,n){var i=this._getNotAllArgs(t,!0,e,n);return this._getAll(i)},Container2.prototype.getAllNamed=function(t,e){return this.getAllTagged(t,c,e)},Container2.prototype.getAllNamedAsync=function(t,e){return this.getAllTaggedAsync(t,c,e)},Container2.prototype.resolve=function(t){var e=this.isBound(t);e||this.bind(t).toSelf();var n=this.get(t);return e||this.unbind(t),n},Container2.prototype._preDestroy=function(t,e){var n,i;if(Reflect.hasMetadata(v,t))return null===(i=(n=e)[Reflect.getMetadata(v,t).value])||void 0===i?void 0:i.call(n)},Container2.prototype._removeModuleHandlers=function(t){var e=this._moduleActivationStore.remove(t);this._activations.removeIntersection(e.onActivations),this._deactivations.removeIntersection(e.onDeactivations)},Container2.prototype._removeModuleBindings=function(t){return this._bindingDictionary.removeByCondition((function(e){return e.moduleId===t}))},Container2.prototype._deactivate=function(t,e){var n=this,i=Object.getPrototypeOf(e).constructor;try{if(this._deactivations.hasKey(t.serviceIdentifier)){var r=this._deactivateContainer(e,this._deactivations.get(t.serviceIdentifier).values());if(isPromise(r))return this._handleDeactivationError(r.then((function(){return n._propagateContainerDeactivationThenBindingAndPreDestroyAsync(t,e,i)})),i)}var s=this._propagateContainerDeactivationThenBindingAndPreDestroy(t,e,i);if(isPromise(s))return this._handleDeactivationError(s,i)}catch(o){if(o instanceof Error)throw new Error(ON_DEACTIVATION_ERROR(i.name,o.message))}},Container2.prototype._handleDeactivationError=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,t];case 1:return i.sent(),[3,3];case 2:if((n=i.sent())instanceof Error)throw new Error(ON_DEACTIVATION_ERROR(e.name,n.message));return[3,3];case 3:return[2]}}))}))},Container2.prototype._deactivateContainer=function(t,e){for(var n=this,i=e.next();i.value;){var r=i.value(t);if(isPromise(r))return r.then((function(){return n._deactivateContainerAsync(t,e)}));i=e.next()}},Container2.prototype._deactivateContainerAsync=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(i){switch(i.label){case 0:n=e.next(),i.label=1;case 1:return n.value?[4,n.value(t)]:[3,3];case 2:return i.sent(),n=e.next(),[3,1];case 3:return[2]}}))}))},Container2.prototype._getContainerModuleHelpersFactory=function(){var t=this,setModuleId=function(t,e){t._binding.moduleId=e},getRebindFunction=function(e){return function(n){var i=t.rebind(n);return setModuleId(i,e),i}},getOnActivationFunction=function(e){return function(n,i){t._moduleActivationStore.addActivation(e,n,i),t.onActivation(n,i)}},getOnDeactivationFunction=function(e){return function(n,i){t._moduleActivationStore.addDeactivation(e,n,i),t.onDeactivation(n,i)}};return function(e){return{bindFunction:(n=e,function(e){var i=t.bind(e);return setModuleId(i,n),i}),isboundFunction:function(e){return t.isBound(e)},onActivationFunction:getOnActivationFunction(e),onDeactivationFunction:getOnDeactivationFunction(e),rebindFunction:getRebindFunction(e),unbindFunction:function(e){return t.unbind(e)},unbindAsyncFunction:function(e){return t.unbindAsync(e)}};var n}},Container2.prototype._getAll=function(t){return Promise.all(this._get(t))},Container2.prototype._get=function(t){var e=__assign(__assign({},t),{contextInterceptor:function(t){return t},targetType:C.Variable});if(this._middleware){var n=this._middleware(e);if(null==n)throw new Error("Invalid return type in middleware. Middleware must return!");return n}return this._planAndResolve()(e)},Container2.prototype._getButThrowIfAsync=function(t){var e=this._get(t);if(isPromiseOrContainsPromise(e))throw new Error("You are attempting to construct '"+t.serviceIdentifier+"' in a synchronous way\n but it has asynchronous dependencies.");return e},Container2.prototype._getAllArgs=function(t){return{avoidConstraints:!0,isMultiInject:!0,serviceIdentifier:t}},Container2.prototype._getNotAllArgs=function(t,e,n,i){return{avoidConstraints:!1,isMultiInject:e,serviceIdentifier:t,key:n,value:i}},Container2.prototype._planAndResolve=function(){var t=this;return function(e){var n=plan(t._metadataReader,t,e.isMultiInject,e.targetType,e.serviceIdentifier,e.key,e.value,e.avoidConstraints);return function resolve(t){return _resolveRequest(t.plan.rootRequest.requestScope)(t.plan.rootRequest)}(n=e.contextInterceptor(n))}},Container2.prototype._deactivateIfSingleton=function(t){var e=this;if(t.activated)return isPromise(t.cache)?t.cache.then((function(n){return e._deactivate(t,n)})):this._deactivate(t,t.cache)},Container2.prototype._deactivateSingletons=function(t){for(var e=0,n=t;e<n.length;e++){var i=n[e];if(isPromise(this._deactivateIfSingleton(i)))throw new Error("Attempting to unbind dependency with asynchronous destruction (@preDestroy or onDeactivation)")}},Container2.prototype._deactivateSingletonsAsync=function(t){return __awaiter(this,void 0,void 0,(function(){var e=this;return __generator(this,(function(n){switch(n.label){case 0:return[4,Promise.all(t.map((function(t){return e._deactivateIfSingleton(t)})))];case 1:return n.sent(),[2]}}))}))},Container2.prototype._propagateContainerDeactivationThenBindingAndPreDestroy=function(t,e,n){return this.parent?this._deactivate.bind(this.parent)(t,e):this._bindingDeactivationAndPreDestroy(t,e,n)},Container2.prototype._propagateContainerDeactivationThenBindingAndPreDestroyAsync=function(t,e,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(i){switch(i.label){case 0:return this.parent?[4,this._deactivate.bind(this.parent)(t,e)]:[3,2];case 1:return i.sent(),[3,4];case 2:return[4,this._bindingDeactivationAndPreDestroyAsync(t,e,n)];case 3:i.sent(),i.label=4;case 4:return[2]}}))}))},Container2.prototype._removeServiceFromDictionary=function(t){try{this._bindingDictionary.remove(t)}catch(e){throw new Error("Could not unbind serviceIdentifier: "+getServiceIdentifierAsString(t))}},Container2.prototype._bindingDeactivationAndPreDestroy=function(t,e,n){var i=this;if("function"==typeof t.onDeactivation){var r=t.onDeactivation(e);if(isPromise(r))return r.then((function(){return i._preDestroy(n,e)}))}return this._preDestroy(n,e)},Container2.prototype._bindingDeactivationAndPreDestroyAsync=function(t,e,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(i){switch(i.label){case 0:return"function"!=typeof t.onDeactivation?[3,2]:[4,t.onDeactivation(e)];case 1:i.sent(),i.label=2;case 2:return[4,this._preDestroy(n,e)];case 3:return i.sent(),[2]}}))}))},Container2}();function tagParameter(t,e,n,i){!function _throwIfMethodParameter(t){if(void 0!==t)throw new Error(O)}(e),_tagParameterOrProperty(g,t,n.toString(),i)}function _ensureNoMetadataKeyDuplicates(t){var e=[];if(Array.isArray(t)){var n=function getFirstArrayDuplicate(t){for(var e=new Set,n=0,i=t;n<i.length;n++){var r=i[n];if(e.has(r))return r;e.add(r)}}((e=t).map((function(t){return t.key})));if(void 0!==n)throw new Error(E+" "+n.toString())}else e=[t];return e}function _tagParameterOrProperty(t,e,n,i){var r=_ensureNoMetadataKeyDuplicates(i),s={};Reflect.hasOwnMetadata(t,e)&&(s=Reflect.getMetadata(t,e));var o=s[n];if(void 0===o)o=[];else for(var _loop_1=function(t){if(r.some((function(e){return e.key===t.key})))throw new Error(E+" "+t.key.toString())},a=0,c=o;a<c.length;a++){_loop_1(c[a])}o.push.apply(o,r),s[n]=o,Reflect.defineMetadata(t,s,e)}function createTaggedDecorator(t){return function(e,n,i){"number"==typeof i?tagParameter(e,n,i,t):function tagProperty(t,e,n){if(function targetIsConstructorFunction(t){return void 0!==t.prototype}(t))throw new Error(O);_tagParameterOrProperty(m,t.constructor,e,n)}(e,n,t)}}function injectable(){return function(t){if(Reflect.hasOwnMetadata(f,t))throw new Error("Cannot apply @injectable decorator multiple times.");var e=Reflect.getMetadata("design:paramtypes",t)||[];return Reflect.defineMetadata(f,e,t),t}}var it=function injectBase(t){return function(e){return function(n,i,r){if(void 0===e){var s="function"==typeof n?n.name:n.constructor.name;throw new Error("@inject called with undefined this could mean that the class "+s+" has a circular dependency problem. You can use a LazyServiceIdentifier to  overcome this limitation.")}return createTaggedDecorator(new W(t,e))(n,i,r)}}}(l);var rt=function propertyEventDecorator(t,e){return function(){return function(n,i){var r=new W(t,i);if(Reflect.hasOwnMetadata(t,n.constructor))throw new Error(e);Reflect.defineMetadata(t,r,n.constructor)}}}(y,"Cannot apply @postConstruct decorator multiple times in the same class"),st=(t=>(t.InteractionVisual="InteractionVisual",t.CommandVisual="CommandVisual",t.DataVisual="DataVisual",t.RTreeVisual="RTreeVisual",t))(st||{}),ot=Object.getOwnPropertyDescriptor;let at=class{constructor(){__publicField(this,"domContainer"),__publicField(this,"interactionCanvas"),__publicField(this,"commandCanvas"),__publicField(this,"dataCanvas")}init(t){if(this.domContainer=t,!this.isPositionAbsolute(this.domContainer))throw new Error("CAD domContainer must be position absolute !");this.interactionCanvas=this.createCanvas(st.InteractionVisual),this.commandCanvas=this.createCanvas(st.CommandVisual),this.dataCanvas=this.createCanvas(st.DataVisual),this.domContainer.appendChild(this.dataCanvas),this.domContainer.appendChild(this.commandCanvas),this.domContainer.appendChild(this.interactionCanvas)}createCanvas(t){const e=document.createElement("canvas");switch(e.id=t,e.style.width="100%",e.style.height="100%",e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.cursor="none",t){case st.InteractionVisual:e.style.backgroundColor="transparent",e.style.zIndex="3";break;case st.CommandVisual:e.style.backgroundColor="transparent",e.style.zIndex="2";break;case st.DataVisual:e.style.backgroundColor="#000",e.style.zIndex="1"}return e}isPositionAbsolute(t){return"absolute"===window.getComputedStyle(t).position}};at=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?ot(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],at);class ArcCalculator{constructor(t,e,n,i,r=!1){__publicField(this,"points"),__publicField(this,"r"),__publicField(this,"startAngle"),__publicField(this,"endAngle"),__publicField(this,"anticlockwise"),this.points=[t],this.r=e,this.startAngle=n,this.endAngle=i,this.anticlockwise=r}static fromShape(t){if(!Array.isArray(t.points)||1!==t.points.length||void 0===t.r||void 0===t.startAngle||void 0===t.endAngle)throw new Error("Invalid shape data");return new ArcCalculator(t.points[0],t.r,t.startAngle,t.endAngle,t.anticlockwise)}static from3Points(t){if(3!==t.length)throw new Error("Exactly three points are required");const[e,n,i]=t,{xCenter:r,yCenter:s,r:o}=this.calculateCircle(e,n,i),a=this.angle(r,s,e[0],e[1]),c=this.angle(r,s,i[0],i[1]);return new ArcCalculator([r,s],o,a,c,function isAnticlockwise(t,e,n){const[i,r]=t,[s,o]=e,[a,c]=n;return(s-i)*(c-r)-(o-r)*(a-i)<0}(e,n,i))}static fromCenterStartEndPoint(t,e,n){const i=Math.sqrt((e[0]-t[0])**2+(e[1]-t[1])**2),r=Math.atan2(e[1]-t[1],e[0]-t[0]),s=Math.atan2(n[1]-t[1],n[0]-t[0]);return new ArcCalculator(t,i,r,s,!0)}static fromTangencyLine(t,e,n){const[i,r]=t,[s,o]=e,[a,c]=n,h=s-i,u=o-r,d=Math.sqrt(h*h+u*u),l=h/d,p=u/d,g=-p,m=(s+a)/2,f=(o+c)/2,y=((m-s)*g+(f-o)*l)/(g**2+l**2),v=m-y*g,S=f-y*l,A=Math.sqrt((v-s)**2+(S-o)**2),b=Math.atan2(o-S,s-v),C=Math.atan2(c-S,a-v);return new ArcCalculator([v,S],A,b,C,l*(c-o)-p*(a-s)<0)}static fromTangencyArc(t,e){const[n,i]=t.points[0],r=t.r,s=t.endAngle,o=t.anticlockwise,[a,c]=e,h=n+r*Math.cos(s),u=i+r*Math.sin(s),d=o?-(u-i):u-i,l=o?h-n:-(h-n),p=Math.sqrt(d**2+l**2),g=d/p,m=l/p,f=(h+a)/2,y=(u+c)/2,v=((f-h)*g+(y-u)*m)/(g**2+m**2),S=f-v*g,A=y-v*m,b=Math.sqrt((S-h)**2+(A-u)**2),C=Math.atan2(u-A,h-S),w=Math.atan2(c-A,a-S);return new ArcCalculator([S,A],b,C,w,g*(c-u)-m*(a-h)>0)}static calculateCircle(t,e,n){const[i,r]=t,[s,o]=e,[a,c]=n,h=2*(i*(o-c)+s*(c-r)+a*(r-o)),u=((i**2+r**2)*(o-c)+(s**2+o**2)*(c-r)+(a**2+c**2)*(r-o))/h,d=((i**2+r**2)*(a-s)+(s**2+o**2)*(i-a)+(a**2+c**2)*(s-i))/h;return{xCenter:u,yCenter:d,r:Math.sqrt((i-u)**2+(r-d)**2)}}static angle(t,e,n,i){return Math.atan2(i-e,n-t)}getCanvasArcParams(){return{points:this.points,r:this.r,startAngle:this.startAngle,endAngle:this.endAngle,anticlockwise:this.anticlockwise}}getArcAABB(){if(this.points&&this.points[0]&&this.r&&this.startAngle&&this.endAngle){let normalizeAngle=function(t){for(;t<0;)t+=2*Math.PI;for(;t>=2*Math.PI;)t-=2*Math.PI;return t};const t=this.points[0][0],e=this.points[0][1],n=normalizeAngle(this.startAngle),i=normalizeAngle(this.endAngle),minX=e=>t+this.r*Math.cos(e),minY=t=>e+this.r*Math.sin(t);let r=Math.min(minX(n),minX(i)),s=Math.max(minX(n),minX(i)),o=Math.min(minY(n),minY(i)),a=Math.max(minY(n),minY(i));const c=[0,Math.PI/2,Math.PI,3*Math.PI/2];for(const h of c){const t=normalizeAngle(h);(this.anticlockwise&&(n>=t&&t>=i||n<i&&(n>=t||t>=i))||!this.anticlockwise&&(n<=t&&t<=i||n>i&&(n<=t||t<=i)))&&(r=Math.min(r,minX(t)),s=Math.max(s,minX(t)),o=Math.min(o,minY(t)),a=Math.max(a,minY(t)))}return[[r,o],[s,a]]}return[]}getArcLengthCenterPoint(){if(!this.points||1!==this.points.length||void 0===this.r||void 0===this.startAngle||void 0===this.endAngle)throw new Error("Invalid shape data");const[t,e]=this.points[0],n=this.anticlockwise?(this.startAngle-this.endAngle+2*Math.PI)%(2*Math.PI):(this.endAngle-this.startAngle+2*Math.PI)%(2*Math.PI),i=this.anticlockwise?(this.startAngle-n/2+2*Math.PI)%(2*Math.PI):(this.startAngle+n/2)%(2*Math.PI);return[t+this.r*Math.cos(i),e+this.r*Math.sin(i)]}getArcLengthStartPoint(){if(!this.points||1!==this.points.length||void 0===this.r||void 0===this.startAngle)throw new Error("Invalid shape data");const[t,e]=this.points[0],n=this.r;return[t+n*Math.cos(this.startAngle),e+n*Math.sin(this.startAngle)]}getArcLengthEndPoint(){if(!this.points||1!==this.points.length||void 0===this.r||void 0===this.endAngle)throw new Error("Invalid shape data");const[t,e]=this.points[0],n=this.r;return[t+n*Math.cos(this.endAngle),e+n*Math.sin(this.endAngle)]}static getArcCenterPointByLine(t,e,n){const[i,r]=t,[s,o]=e,[a,c]=n,h=-(o-r),u=s-i,d=(s+a)/2,l=(o+c)/2,p=Math.sqrt((a-s)**2+(c-o)**2)/2;return[d+h*p/Math.sqrt(h**2+u**2),l+u*p/Math.sqrt(h**2+u**2)]}static getArcCenterPointByArc(t,e,n){if(3!==t.length)throw new Error("The previous arc must have exactly three points.");const[i,r,s]=t,{xCenter:o,yCenter:a}=this.calculateCircle(i,r,s),c=s[0]-o,h=s[1]-a,u=Math.sqrt(c**2+h**2),d=c/u,l=h/u,p=(e[0]+n[0])/2,g=(e[1]+n[1])/2,m=Math.sqrt((n[0]-e[0])**2+(n[1]-e[1])**2)/2;return[p+d*m,g+l*m]}}var ct=Object.getOwnPropertyDescriptor;let ht=class{constructor(){__publicField(this,"list",new Map)}addEventListener(t,e){let n=this.list.get(t);n||(n=new Set,this.list.set(t,n)),n.has(e)||n.add(e)}dispatchEvent(t,...e){const n=this.list.get(t);if(n)for(const i of n)i(...e)}removeEventListener(t,e){const n=this.list.get(t);n&&n.has(e)&&n.delete(e)}once(t,e){const tempFn=(...n)=>{e(...n),this.removeEventListener(t,tempFn)};this.addEventListener(t,tempFn)}};ht=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?ct(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],ht);var ut=Object.getOwnPropertyDescriptor;let dt=class extends ht{constructor(){super(),__publicField(this,"_dpr",1)}get dpr(){return this._dpr}setDpr(t){this._dpr=t}get ghostClearCompensation(){return 1*this._dpr}};dt=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?ut(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],dt);var lt=Object.defineProperty,pt=Object.getOwnPropertyDescriptor,__decorateClass$w=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?pt(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&lt(e,n,s),s};let gt=class{constructor(){__publicField(this,"envConfig")}getAABB(t){let e=[];switch(t.type){case At.LINE:e=this.getLineAABB(t.shape[0]);break;case At.MTEXT:e=this.getMTextAABB(t.shape[0]);break;case At.CIRCLE:e=this.getCircleAABB(t.shape[0]);break;case At.ARC:e=this.getArcAABB(t.shape[0]);break;case At.PLINE:e=this.getPlineAABB(t.shape)}if(e.length){const t=this.envConfig.ghostClearCompensation;return[[e[0][0]-t,e[0][1]-t],[e[1][0]+t,e[1][1]+t]]}return e}getEntitiesAABB(t,e=!0){let n=1/0,i=1/0,r=-1/0,s=-1/0;return t.forEach((t=>{const o=e?this.getAABB(t):t.AABB??this.getAABB(t);if(2===o.length){const[t,e]=o[0],[a,c]=o[1];n=Math.min(n,t),i=Math.min(i,e),r=Math.max(r,a),s=Math.max(s,c)}})),[[n,i],[r,s]]}getLineAABB(t){try{const e=t.points,n=e[0][0],i=e[0][1],r=e[1][0],s=e[1][1],o=Math.min(n,r),a=Math.min(i,s),c=Math.max(n,r);return[[o,a],[c,Math.max(i,s)]]}catch(e){return[]}}getMTextAABB(t){try{return t.points}catch(e){return[]}}getCircleAABB(t){try{const e=t.points,n=e[0][0],i=e[0][1],r=t.r;return[[n-r,i-r],[n+r,i+r]]}catch(e){return[]}}getArcAABB(t){return ArcCalculator.fromShape(t).getArcAABB()}getPlineAABB(t){try{let e=1/0,n=1/0,i=-1/0,r=-1/0;return t.forEach((t=>{const s=t.points;switch(t.type){case At.LINE:s.forEach((([t,s])=>{e=Math.min(e,t),n=Math.min(n,s),i=Math.max(i,t),r=Math.max(r,s)}));case At.ARC:}})),[[e,n],[i,r]]}catch(e){return[]}}isRectInsideBoundingBox(t,e){const n=t[0][0],i=t[0][1],r=t[1][0],s=t[1][1];t=[[Math.min(n,r),Math.min(i,s)],[Math.max(n,r),Math.max(i,s)]];const[o,a]=e,[c,h]=t;return o[0]>=c[0]&&o[1]>=c[1]&&a[0]<=h[0]&&a[1]<=h[1]}isRectPartiallyInsideBoundingBox(t,e){const n=t[0][0],i=t[0][1],r=t[1][0],s=t[1][1];t=[[Math.min(n,r),Math.min(i,s)],[Math.max(n,r),Math.max(i,s)]];const[o,a]=e,[c,h]=t;return!(a[0]<c[0]||o[0]>h[0]||a[1]<c[1]||o[1]>h[1])}};__decorateClass$w([it(dt)],gt.prototype,"envConfig",2),gt=__decorateClass$w([injectable()],gt);const mt=function generateUniqueIdFn(){function generateId(t){const e=new Uint8Array(Math.ceil(t/2));crypto.getRandomValues(e);let n="";for(let i=0;i<e.length;i++)n+=e[i].toString(16).padStart(2,"0");return n.slice(0,t)}const t={};return(e=6)=>{let n=generateId(e);for(;t[n];)n=generateId(e);return t[n]=!0,n}}();function deepCopy(t){return JSON.parse(JSON.stringify(t))}function isNumeric(t){if("number"==typeof t)return!0;return/^[-+]?(?:\d*\.\d+|\d+\.\d*|\d+)$/.test(t)}function isNumArray(t){return Array.isArray(t)&&t.every((t=>"number"==typeof t))}class Layer{constructor(){__publicField(this,"id",mt()),__publicField(this,"status",!1),__publicField(this,"name",""),__publicField(this,"on",!0),__publicField(this,"frozen",!1),__publicField(this,"locked",!1),__publicField(this,"color","#fff"),__publicField(this,"lineType",""),__publicField(this,"lineWeight",0),__publicField(this,"printStyle","#fff"),__publicField(this,"print",!0),__publicField(this,"description",""),__publicField(this,"entityList",[])}}var ft=Object.getOwnPropertyDescriptor;let yt=class{constructor(){__publicField(this,"list",[]),this.layerInit()}layerInit(){0===this.list.length&&this.addLayer()}getList(){const t=this.list;if(0===t.length)throw new Error("没有任何图层存在！");return t}getCurrentLayer(){let t=this.list.find((t=>t.status));try{if(null==t)throw new Error("出现没有status为true的情况")}catch(e){this.list[0].status=!0,t=this.list[0]}return t}addLayer(){const t=new Layer;this.list.push(t)}removeLayerByIndex(t){if(!(t>-1&&t<this.list.length))throw new Error("无效的索引。");return this.list.splice(t,1),this.list}removeLayerById(t){return 1===this.list.length&&this.list[0].id===t?this.list:this.list.filter((e=>e.id!==t))}setLayerStatus(t){this.list.some((e=>e.id===t&&(e.status=!1,!0))),this.list.some((e=>e.id===t&&(e.status=!0,!0)))}delLayersByIds(t){return this.list.filter((e=>!t.includes(e.id)))}};yt=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?ft(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],yt);class Vector2D{constructor(t,e){__publicField(this,"coordinates"),this.coordinates=new Float32Array([t,e])}static fromPoints(t,e){const[n,i]=t,[r,s]=e;return new Vector2D(r-n,s-i)}static fromArray(t){return new Vector2D(t[0],t[1])}static fromObject(t){return new Vector2D(t.x,t.y)}getMagnitude(){return Math.sqrt(this.coordinates[0]*this.coordinates[0]+this.coordinates[1]*this.coordinates[1])}getUnitVector(){const t=this.getMagnitude();if(0===t)throw new Error("Cannot calculate unit vector for a zero vector");return new Vector2D(this.coordinates[0]/t,this.coordinates[1]/t)}getDirectionDegrees(){return 180*Math.atan2(this.coordinates[1],this.coordinates[0])/Math.PI}add(t){return new Vector2D(this.coordinates[0]+t.coordinates[0],this.coordinates[1]+t.coordinates[1])}subtract(t){return new Vector2D(this.coordinates[0]-t.coordinates[0],this.coordinates[1]-t.coordinates[1])}scalarMultiply(t){return new Vector2D(this.coordinates[0]*t,this.coordinates[1]*t)}dotProduct(t){return this.coordinates[0]*t.coordinates[0]+this.coordinates[1]*t.coordinates[1]}crossProduct(t){return this.coordinates[0]*t.coordinates[1]-this.coordinates[1]*t.coordinates[0]}getAngleRadians(t){const e=this.dotProduct(t),n=this.getMagnitude()*t.getMagnitude();return Math.acos(e/n)}projectOnto(t){const e=this.dotProduct(t)/t.getMagnitude()**2;return t.scalarMultiply(e)}rotate(t){const e=Math.cos(t),n=Math.sin(t),i=this.coordinates[0]*e-this.coordinates[1]*n,r=this.coordinates[0]*n+this.coordinates[1]*e;return new Vector2D(i,r)}translate(t,e){return new Vector2D(this.coordinates[0]+t,this.coordinates[1]+e)}isEqual(t){return this.coordinates[0]===t.coordinates[0]&&this.coordinates[1]===t.coordinates[1]}getNormalVector(){return new Vector2D(-this.coordinates[1],this.coordinates[0])}isCollidingWith(t,e){return this.subtract(t).getMagnitude()<=e}}class LineCalculator{constructor(t,e){__publicField(this,"points"),this.points=[t,e]}getMidPoint(){const[t,e]=this.points,[n,i]=t,[r,s]=e;return[(n+r)/2,(i+s)/2]}getPerpendicularPoint(t){const[e,n]=this.points,[i,r]=t,[s,o]=e,[a,c]=n,h=a-s,u=c-o,d=((i-s)*h+(r-o)*u)/(h*h+u*u);return d<0||d>1?null:[s+d*h,o+d*u]}getPointToLineDistance(t){const[e,n]=this.points,[i,r]=t,[s,o]=e,[a,c]=n,h=c-o,u=s-a,d=a*o-s*c;return Math.abs(h*i+u*r+d)/Math.sqrt(h*h+u*u)}getPointToSegmentNearest(t){const[e,n]=this.points,[i,r]=t,[s,o]=e,[a,c]=n,h=a-s,u=c-o;let d=((i-s)*h+(r-o)*u)/(h*h+u*u);d=Math.max(0,Math.min(1,d));return[s+d*h,o+d*u]}isIntersectSegment(t,e){const n=Vector2D.fromArray(this.points[0]),i=Vector2D.fromArray(this.points[1]),r=Vector2D.fromArray(t),s=Vector2D.fromArray(e),o=r.subtract(n).crossProduct(i.subtract(n)),a=s.subtract(n).crossProduct(i.subtract(n)),c=n.subtract(r).crossProduct(s.subtract(r)),h=i.subtract(r).crossProduct(s.subtract(r));return o*a<0&&c*h<0}getIntersectSegment(t,e){const[n,i]=this.points,[r,s]=[t,e],[o,a]=n,[c,h]=i,[u,d]=r,[l,p]=s,g=(p-d)*(c-o)-(l-u)*(h-a);if(0===g)return null;const m=((l-u)*(a-d)-(p-d)*(o-u))/g,f=((c-o)*(a-d)-(h-a)*(o-u))/g;if(m<0||m>1||f<0||f>1)return null;return[o+m*(c-o),a+m*(h-a)]}getIntersectCircle(t,e){const[n,i]=this.points,[r,s]=t,[o,a]=n,[c,h]=i,u=c-o,d=h-a,l=u*u+d*d,p=2*(u*(o-r)+d(a-s)),g=p*p-4*l*(r*r+s*s+o*o+a*a-2*(r*o+s*a)-e*e);if(g<0)return null;const m=Math.sqrt(g),f=(-p+m)/(2*l),y=(-p-m)/(2*l),v=[];return f>=0&&f<=1&&v.push([o+f*u,a+f*d]),y>=0&&y<=1&&v.push([o+y*u,a+y*d]),v.length?v:null}getIntersectArc(t,e,n,i,r=!1){const s=this.getIntersectCircle(t,e);if(!s)return null;const[o,a]=t,c=s.map((([t,e])=>Math.atan2(e-a,t-o))),h=c.map(((t,e)=>(t=>{let e=t;return t<n&&(e+=2*Math.PI),r?e<=n&&e>=i:e>=n&&e<=i})(t)?s[e]:null)).filter((t=>null!==t));return h.length?h:null}}class RectangleCalculator{constructor(t,e){__publicField(this,"points"),this.points=[t,e]}isPointInside(t){const[e,n]=this.points,[i,r]=t;return i>=e[0]&&i<=n[0]&&r>=e[1]&&r<=n[1]}isIntersectSegment(t,e){const[n,i]=this.points,r=[[n,[i[0],n[1]]],[n,[n[0],i[1]]],[i,[n[0],i[1]]],[i,[i[0],n[1]]]];let s=new LineCalculator(t,e);for(const o of r)if(s.isIntersectSegment(o[0],o[1]))return!0;return!1}isIntersectRectangleEdge(t,e){const n=t,i=e,r=[[n,[i[0],n[1]]],[n,[n[0],i[1]]],[i,[n[0],i[1]]],[i,[i[0],n[1]]]];for(const s of r)if(this.isIntersectSegment(s[0],s[1]))return!0;return!1}isIntersectRectangle(t,e){const[n,i]=this.points,[r,s]=[t,e];return!(n[0]>s[0]||i[0]<r[0]||n[1]>s[1]||i[1]<r[1])}isIntersectCircle(t,e){const[n,i]=t,[[r,s],[o,a]]=this.points,isPointOnCircleEdge=(t,e,n,i,r)=>{const s=(t-n)**2+(e-i)**2;return Math.abs(s-r*r)<1e-6},isPointInsideRectangle=(t,e,n,i,r,s)=>t>=n&&t<=r&&e>=i&&e<=s,doesLineSegmentIntersectCircle=(t,e,n,i,r,s,o)=>{const a=s-i,c=o-r,h=i-t,u=r-e,d=a*a+c*c,l=2*(h*a+u*c);let p=l*l-4*d*(h*h+u*u-n*n);if(p<0)return!1;p=Math.sqrt(p);const g=(-l-p)/(2*d),m=(-l+p)/(2*d);return g>=0&&g<=1||m>=0&&m<=1},c=n-Math.max(r,Math.min(n,o)),h=i-Math.max(s,Math.min(i,a));if(c*c+h*h>e*e)return!1;const u=[[r,s],[o,s],[o,a],[r,a]],d=[[u[0],u[1]],[u[1],u[2]],[u[2],u[3]],[u[3],u[0]]];for(const[[p,g],[m,f]]of d)if(doesLineSegmentIntersectCircle(n,i,e,p,g,m,f))return!0;for(const[p,g]of u)if(isPointOnCircleEdge(p,g,n,i,e))return!0;const l=[[n+e,i],[n-e,i],[n,i+e],[n,i-e]];for(const[p,g]of l)if(isPointInsideRectangle(p,g,r,s,o,a))return!0;return!1}isIntersectCircleAndCenter(t,e){return this.isIntersectCircle(t,e)||this.isPointInside(t)}isIntersectArc(t,e,n,i,r){const[s,o]=t,[[a,c],[h,u]]=this.points;function normalizeAngle(t){for(;t<0;)t+=2*Math.PI;for(;t>=2*Math.PI;)t-=2*Math.PI;return t}if(n=normalizeAngle(n),i=normalizeAngle(i),r){const t=n;n=i,i=t}function isAngleInArcRange(t,e,n){return e<n?t>=e&&t<=n:t>=e||t<=n}const d=[[a,c],[h,c],[h,u],[a,u]],l=[[d[0],d[1]],[d[1],d[2]],[d[2],d[3]],[d[3],d[0]]],doesLineSegmentIntersectArc=(t,e,n,i,r,s,o,a,c)=>{const h=n-t,u=i-e,d=t-r,l=e-s,p=h*h+u*u,g=2*(d*h+l*u);let m=g*g-4*p*(d*d+l*l-o*o);if(m<0)return!1;m=Math.sqrt(m);const f=(-g-m)/(2*p),y=(-g+m)/(2*p);if(f>=0&&f<=1){const n=t+f*h,i=e+f*u;if(isAngleInArcRange(normalizeAngle(Math.atan2(i-s,n-r)),a,c))return!0}if(y>=0&&y<=1){const n=t+y*h,i=e+y*u;if(isAngleInArcRange(normalizeAngle(Math.atan2(i-s,n-r)),a,c))return!0}return!1};for(const[[p,g],[m,f]]of l)if(doesLineSegmentIntersectArc(p,g,m,f,s,o,e,n,i))return!0;return!1}}var vt=Object.defineProperty,St=Object.getOwnPropertyDescriptor,__decorateClass$u=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?St(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&vt(e,n,s),s},At=(t=>(t.LINE="LINE",t.CONSTRUCTION="CONSTRUCTION",t.PLINE="PLINE",t.ARC="ARC",t.CIRCLE="CIRCLE",t.SPLINE="SPLINE",t.ELLIPSE="ELLIPSE",t.BLOCK="BLOCK",t.POINT="POINT",t.HELIX="HELIX",t.HATCH="HATCH",t.REGION="REGION",t.TABLE="TABLE",t.MTEXT="MTEXT",t))(At||{});const bt="ADD",Ct="EDIT",wt="DELETE";let It=class extends ht{constructor(){super(),__publicField(this,"layerComtainer"),__publicField(this,"boundingBox"),__publicField(this,"entityRTree"),__publicField(this,"_derivedData",{selectionBoxEntities:[],collisionEntity:null}),this.EntityRTreeInit()}get selectionBoxEntities(){return this._derivedData.selectionBoxEntities}get collisionEntity(){return this._derivedData.collisionEntity}all(){return this.entityRTree.all()}toJSON(){return this.entityRTree.toJSON()}getEntityById(t){return this.entityRTree.all().find((e=>e.id===t))}cursorCollisionDetect(t){return this.entityRTree.collides({minX:t[0][0],minY:t[0][1],maxX:t[1][0],maxY:t[1][1]})}getEntityByAABB(t,e=!1){return this.entityRTree.search({minX:t[0][0],minY:t[0][1],maxX:t[1][0],maxY:t[1][1]},e)}getEntityByAABBAllIn(t){return this.entityRTree.searchAllIn({minX:t[0][0],minY:t[0][1],maxX:t[1][0],maxY:t[1][1]})}addEntityData(t){t=t.map((t=>(t.AABB=this.boundingBox.getAABB(t),t.layer=this.layerComtainer.getCurrentLayer(),t))),this.entityRTree.load(t),this.updateDerivedData(0,t),this.dispatchEvent(bt,t)}editEntitiesData(t){const e=this.boundingBox.getEntitiesAABB(t,!1);console.time("纯数据更新"),t.forEach((t=>{const e=t.AABB,n=this.boundingBox.getAABB(t);e&&e[0][0]===n[0][0]&&e[0][1]===n[0][1]&&e[1][0]===n[1][0]&&e[1][1]===n[1][1]||(this.entityRTree.remove(t),t.AABB=n,this.entityRTree.insert(t))})),console.timeEnd("纯数据更新"),console.log(`更新数量：${t.length}`),this.updateDerivedData(1,t),this.dispatchEvent(Ct,t,{oldAABB:e})}delEntityData(t){const e=this.boundingBox.getEntitiesAABB(t,!1);t.forEach((t=>{this.entityRTree.remove(t)})),this.updateDerivedData(2,t),this.dispatchEvent(wt,t,{oldAABB:e})}EntityRTreeInit(){this.entityRTree=new EntityRTree(4)}updateDerivedData(t,e){console.time("DerivedDataUpdatedType.EDIT"),this.updateSelectionBoxEntities(t,e),this.updateCollisionEntity(t,e),console.timeEnd("DerivedDataUpdatedType.EDIT")}updateSelectionBoxEntities(t,e){if(e.length>10||this._derivedData.selectionBoxEntities.length>10)this._derivedData.selectionBoxEntities=this.entityRTree.all().filter((t=>{var e;return null==(e=t.other)?void 0:e.boxSelected}));else if(2===t)this._derivedData.selectionBoxEntities=this._derivedData.selectionBoxEntities.filter((t=>!(e.findIndex((e=>e.id===t.id))>-1)));else e.forEach((t=>{var e;if(null==(e=t.other)?void 0:e.boxSelected){const e=this._derivedData.selectionBoxEntities.findIndex((e=>t.id===e.id));e>-1?this._derivedData.selectionBoxEntities[e]=t:this._derivedData.selectionBoxEntities.push(t)}else this._derivedData.selectionBoxEntities=this._derivedData.selectionBoxEntities.filter((e=>e.id!==t.id))}))}updateCollisionEntity(t,e){this._derivedData.collisionEntity=e.find((t=>{var e;return null==(e=t.other)?void 0:e.collisioned}))}};__decorateClass$u([it(yt)],It.prototype,"layerComtainer",2),__decorateClass$u([it(gt)],It.prototype,"boundingBox",2),It=__decorateClass$u([injectable()],It);class EntityRTree extends e{constructor(){super(...arguments),__publicField(this,"boundingBox")}toBBox(t){let e=t.AABB;return e||(e=this.boundingBox.getAABB(t),t.AABB=e),{...t,minX:e[0][0],minY:e[0][1],maxX:e[1][0],maxY:e[1][1]}}compareMinX(t,e){return t.AABB[0][0]-e.AABB[0][0]}compareMinY(t,e){return t.AABB[0][1]-e.AABB[0][1]}accurateCollisionFn(t,e){const n=[[t.minX,t.minY],[t.maxX,t.maxY]];return e.shape.some((t=>{switch(t.type){case"LINE":return new RectangleCalculator(n[0],n[1]).isIntersectSegment(t.points[0],t.points[1]);case"MTEXT":return new RectangleCalculator(n[0],n[1]).isIntersectRectangleEdge(t.points[0],t.points[1]);case"CIRCLE":if(Array.isArray(t.points)&&t.r)return new RectangleCalculator(n[0],n[1]).isIntersectCircleAndCenter(t.points[0],t.r);break;case"ARC":if(Array.isArray(t.points)&&t.r&&t.startAngle&&t.endAngle)return new RectangleCalculator(n[0],n[1]).isIntersectArc(t.points[0],t.r,t.startAngle,t.endAngle,t.anticlockwise)}return!1}))}}__decorateClass$u([it(gt)],EntityRTree.prototype,"boundingBox",2);var Et=Object.getOwnPropertyDescriptor;const Mt="VisualWorkerViewChange",Tt="BaseMousedownChange",xt="BaseMouseChange",Nt="BaseMouseupChange",Pt="BaseMouseRecordsChange",Dt="WheelDeltaYChange";let Lt=class extends ht{constructor(){super(),__publicField(this,"_visualWorkerView",{a:1,b:0,c:0,d:1,e:0,f:0}),__publicField(this,"_baseMousedownX",0),__publicField(this,"_baseMousedownY",0),__publicField(this,"_baseMouseX",0),__publicField(this,"_baseMouseY",0),__publicField(this,"_baseMouseupX",0),__publicField(this,"_baseMouseupY",0),__publicField(this,"_baseMouseRecords",[]),__publicField(this,"_wheelDeltaY",0)}get visualWorkerView(){return this._visualWorkerView}setVisualWorkerView(t){const e=this._visualWorkerView;this._visualWorkerView=t,this.dispatchEvent(Mt,t,e)}get baseMousedownX(){return this._baseMousedownX}get baseMousedownY(){return this._baseMousedownY}setBaseMousedown(t){const e=[this._baseMousedownX,this._baseMousedownY];this._baseMousedownX=t[0],this._baseMousedownY=t[1],this.dispatchEvent(Tt,t,e)}get baseMouseX(){return this._baseMouseX}get baseMouseY(){return this._baseMouseY}setBaseMouse(t){const e=[this._baseMouseX,this._baseMouseY];this._baseMouseX=t[0],this._baseMouseY=t[1],this.dispatchEvent(xt,t,e)}get baseMouseupX(){return this._baseMouseupX}get baseMouseupY(){return this._baseMouseupY}setBaseMouseup(t){const e=[this._baseMouseupX,this._baseMouseupY];this._baseMouseupX=t[0],this._baseMouseupY=t[1],this.dispatchEvent(Nt,t,e)}get baseMouseRecords(){return this._baseMouseRecords}setBaseMouseRecords(t){const e=this._baseMouseRecords;this._baseMouseRecords=t,this.dispatchEvent(Pt,t,e)}get wheelDeltaY(){return this._wheelDeltaY}setWheelDeltaY(t){const e=this._wheelDeltaY;this._wheelDeltaY=t,this.dispatchEvent(Dt,t,e)}get mousedownX(){return this.affineInverseTransformX(this._baseMousedownX)}get mousedownY(){return this.affineInverseTransformY(this._baseMousedownY)}get mouseX(){return this.affineInverseTransformX(this._baseMouseX)}get mouseY(){return this.affineInverseTransformY(this._baseMouseY)}get mouseupX(){return this.affineInverseTransformX(this._baseMouseupX)}getmouseupY(){return this.affineInverseTransformY(this._baseMouseupY)}get mouseRecords(){return this._baseMouseRecords.map((t=>t.map(((t,e)=>0===e?this.affineInverseTransformX(t):this.affineInverseTransformY(t)))))}affineTransformX(t){const{a:e,e:n}=this._visualWorkerView;return t*e+n}affineTransformY(t){const{d:e,f:n}=this._visualWorkerView;return t*e+n}affineInverseTransformX(t){const{a:e,e:n}=this._visualWorkerView;return(t-n)/e}affineInverseTransformY(t){const{d:e,f:n}=this._visualWorkerView;return(t-n)/e}affineTransformPoint(t){return[this.affineTransformX(t[0]),this.affineTransformY(t[1])]}affineInverseTransformPoint(t){return[this.affineInverseTransformX(t[0]),this.affineInverseTransformY(t[1])]}getAbsoluteTransformFromRelative(t,e){return{a:t.a*e.a+t.c*e.b,b:t.b*e.a+t.d*e.b,c:t.a*e.c+t.c*e.d,d:t.b*e.c+t.d*e.d,e:t.a*e.e+t.c*e.f+t.e,f:t.b*e.e+t.d*e.f+t.f}}};Lt=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?Et(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],Lt);var Ot=Object.getOwnPropertyDescriptor;const Bt="KeyDown",Rt="KeyUp";let _t=class extends ht{constructor(){super(),__publicField(this,"pressedKeys",new Set),__publicField(this,"lastProcessedKey",null),__publicField(this,"handleKeyDown",(t=>{const e=t.key.toLocaleUpperCase();this.lastProcessedKey!==e&&(this.lastProcessedKey=e,console.info("%c键盘按下："+e,"color: green;"),this.pressedKeys.has(e)||(this.pressedKeys.add(e),this.eventPreventDefaultFilter(t),this.dispatchEvent(Bt,e)))})),__publicField(this,"handleKeyUp",(t=>{const e=t.key.toLocaleUpperCase();this.pressedKeys.has(e)&&(this.pressedKeys.delete(e),t.preventDefault(),this.dispatchEvent(Rt,e)),this.lastProcessedKey=null})),__publicField(this,"clearPressedKeys",(()=>{this.pressedKeys.forEach((t=>{this.dispatchEvent(Rt,t)})),this.pressedKeys.clear(),this.lastProcessedKey=null,console.info("%c焦点丢失，清空按下的键","color: blue;")})),this.keyboardListenerInit()}keyboardListenerInit(){document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp),window.addEventListener("blur",this.clearPressedKeys)}eventPreventDefaultFilter(t){const e=t.key.toLocaleUpperCase();["F12","F5","F8"].includes(e)||this.pressedKeys.has("SHIFT")&&this.pressedKeys.has("CONTROL")&&this.pressedKeys.has("C")||t.preventDefault()}getPressedKeys(){return Array.from(this.pressedKeys)}isKeyPressed(t){return this.pressedKeys.has(t.toLocaleUpperCase())}removeEventListeners(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),window.removeEventListener("blur",this.clearPressedKeys)}};_t=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?Ot(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],_t);var kt=Object.getOwnPropertyDescriptor;let Wt=class{constructor(t){__publicField(this,"_crossLength"),__publicField(this,"_squareLength"),__publicField(this,"_detectTime"),__publicField(this,"_maxNodeEntityShowNum"),__publicField(this,"_snapSize"),__publicField(this,"_selectedNodeSize"),this.envConfig=t}init(){this._crossLength=100*this.envConfig.dpr,this._squareLength=10*this.envConfig.dpr,this._detectTime=20,this._maxNodeEntityShowNum=10,this._snapSize=20*this.envConfig.dpr,this._selectedNodeSize=12*this.envConfig.dpr}get crossLength(){return this._crossLength}get squareLength(){return this._squareLength}get detectTime(){return this._detectTime}get maxNodeEntityShowNum(){return this._maxNodeEntityShowNum}get snapSize(){return this._snapSize}get selectedNodeSize(){return this._selectedNodeSize}};var jt,Vt;Wt=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?kt(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable(),(jt=0,Vt=it(dt),(t,e)=>Vt(t,e,jt))],Wt);var qt=Object.defineProperty,Xt=Object.getOwnPropertyDescriptor,__decorateClass$q=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Xt(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&qt(e,n,s),s},Yt=(t=>(t.CROSSWITHSQUARE="CROSSWITHSQUARE",t.NONE="NONE",t.CROSS="CROSS",t.SQUARE="SQUARE",t.DRAGGING="DRAGGING",t))(Yt||{});let Ht=class{constructor(){__publicField(this,"domManager"),__publicField(this,"envConfig"),__publicField(this,"systemConfig"),__publicField(this,"renderWorker"),__publicField(this,"canvas")}init(){this.canvas=this.domManager.interactionCanvas,this.canvas.width=Math.ceil(this.canvas.offsetWidth*this.envConfig.dpr),this.canvas.height=Math.ceil(this.canvas.offsetHeight*this.envConfig.dpr);const t=this.canvas.transferControlToOffscreen();this.renderWorker=new Worker(new URL(""+new URL("InteractionRender-DoU4bGMN.js",import.meta.url).href,import.meta.url),{type:"module",name:"visual"}),this.renderWorker.postMessage({event:"INIT",canvas:t,dpr:this.envConfig.dpr,crossLength:this.systemConfig.crossLength,squareLength:this.systemConfig.squareLength,snapSize:this.systemConfig.snapSize,ghostClearCompensation:this.envConfig.ghostClearCompensation},[t])}drawCursor(t,e){"NONE"===t?"none"!==this.canvas.style.cursor&&(this.canvas.style.cursor="none"):"DRAGGING"===t?"grabbing"!==this.canvas.style.cursor&&(this.canvas.style.cursor="grabbing"):("none"!==this.canvas.style.cursor&&(this.canvas.style.cursor="none"),this.renderWorker.postMessage({event:"DRAWCURSOR",cursorState:t,point:e}))}drawSelectRect(t,e){this.renderWorker.postMessage({event:"DRAWSELECTRECT",startPoint:t,endPoint:e})}clearCursorAndSelectRect(t,e,n){this.renderWorker.postMessage({event:"CLEARCURSORANDSELECTRECT",cursorState:t,startPoint:e,endPoint:n})}clearAllShapes(){this.renderWorker.postMessage({event:"CLEARALLSHAPES"})}drawEndpoint(t,e="#F2D378"){this.renderWorker.postMessage({event:"DRAWENDPOINT",coordinate:t,strokeStyle:e})}drawMidpoint(t){this.renderWorker.postMessage({event:"DRAWMIDPOINT",coordinate:t})}drawPerpendicular(t){this.renderWorker.postMessage({event:"DRAWPERPENDICULAR",coordinate:t})}drawInsertionPoint(t){this.renderWorker.postMessage({event:"DRAWINSERTIONPOINT",coordinate:t})}drawTangency(t){this.renderWorker.postMessage({event:"DRAWTANGENCY",coordinate:t})}drawQuadrant(t){this.renderWorker.postMessage({event:"DRAWQUADRANT",coordinate:t})}drawClosest(t){this.renderWorker.postMessage({event:"DRAWCLOSEST",coordinate:t})}drawIntersection(t){this.renderWorker.postMessage({event:"DRAWINTERSECTION",coordinate:t})}};__decorateClass$q([it(at)],Ht.prototype,"domManager",2),__decorateClass$q([it(dt)],Ht.prototype,"envConfig",2),__decorateClass$q([it(Wt)],Ht.prototype,"systemConfig",2),Ht=__decorateClass$q([injectable()],Ht);var Ft=Object.getOwnPropertyDescriptor;let Kt=class{constructor(){__publicField(this,"idPool",{})}createId(){let t=this.createOnceId();for(;this.idPool[t];)t=this.createOnceId();return this.idPool[t]=!0,t}createOnceId(){return Array(3).fill(0).map((()=>Math.ceil(255*Math.random()))).concat(255).join("-")}deleteId(t){delete this.idPool[t]}};Kt=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?Ft(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],Kt);var Ut=Object.defineProperty,zt=Object.getOwnPropertyDescriptor,__decorateClass$o=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?zt(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Ut(e,n,s),s};let Gt=class{constructor(){__publicField(this,"envConfig"),__publicField(this,"domManager"),__publicField(this,"mouse"),__publicField(this,"renderWorker"),__publicField(this,"processRenderResolve",null)}init(){this.canvasInit(),this.workerListenerInit()}canvasInit(){const t=this.domManager.commandCanvas;t.width=Math.ceil(t.offsetWidth*this.envConfig.dpr),t.height=Math.ceil(t.offsetHeight*this.envConfig.dpr);const e=t.transferControlToOffscreen();this.renderWorker=new Worker(new URL(""+new URL("CommandRender-CRaJpyi6.js",import.meta.url).href,import.meta.url),{type:"module",name:"visual"}),this.renderWorker.postMessage({event:"INIT",canvas:e,dpr:this.envConfig.dpr},[e])}workerListenerInit(){this.renderWorker.addEventListener("message",(t=>{var e,n;"PROCESSRENDERFINISHED"===(null==(e=t.data)?void 0:e.event)&&(null==(n=this.processRenderResolve)||n.call(this,t.data),this.processRenderResolve=null)}))}render(t,e){if(!e){const{a:t,b:n,c:i,d:r,e:s,f:o}=this.mouse.visualWorkerView;e={a:t,b:n,c:i,d:r,e:s,f:o}}return new Promise((n=>{this.processRenderResolve=n,this.renderWorker.postMessage({event:"PROCESSRENDER",entityArr:t,viewInfo:e,stopPrevProcessRender:!0})}))}clearAll(){this.renderWorker.postMessage({event:"CLEAR",clearArea:[[0,0],[this.domManager.dataCanvas.width,this.domManager.dataCanvas.height]]})}};__decorateClass$o([it(dt)],Gt.prototype,"envConfig",2),__decorateClass$o([it(at)],Gt.prototype,"domManager",2),__decorateClass$o([it(Lt)],Gt.prototype,"mouse",2),__decorateClass$o([rt()],Gt.prototype,"init",1),Gt=__decorateClass$o([injectable()],Gt);var Qt=Object.defineProperty,$t=Object.getOwnPropertyDescriptor,__decorateClass$n=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?$t(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Qt(e,n,s),s};const Jt="ShapeCreated",Zt="ShapeEdited",te="ShapeDelete";let ee=class{constructor(){__publicField(this,"dataManager"),__publicField(this,"historyList",[]),__publicField(this,"entityStatusHash",{}),__publicField(this,"pointer",0)}add(t,e){this.historyList=this.historyList.slice(0,this.pointer),this.historyList.push({shapeChangeType:t,entitiesId:e.map((t=>t.id))}),this.pointer++,this.addStatus(e)}revert(t){if(t<0)return void console.warn("无法进行撤销了");if(t>this.historyList.length)return void console.warn("无法进行重做了");if(t===this.pointer)return;if(t<this.pointer){const e=this.historyList.slice(t,this.pointer);for(let t=e.length-1;t>=0;t--){const n=e[t].shapeChangeType,i=e[t].entitiesId.map((t=>{this.entityStatusHash[t].pointer--;let e=null;return n===Zt?(e=this.entityStatusHash[t].entityStatusArr[this.entityStatusHash[t].pointer-1],e.AABB=this.entityStatusHash[t].entityStatusArr[this.entityStatusHash[t].pointer].AABB):e=this.entityStatusHash[t].entityStatusArr[this.entityStatusHash[t].pointer],e}));switch(n){case Jt:this.dataManager.delEntityData(i);break;case Zt:this.dataManager.editEntitiesData(i);break;case te:this.dataManager.addEntityData(i)}this.pointer--}}else{const e=this.historyList.slice(this.pointer,t);for(let t=0;t<e.length;t++){const n=e[t].shapeChangeType,i=e[t].entitiesId.map((t=>{this.entityStatusHash[t].pointer++;const e=this.entityStatusHash[t].entityStatusArr[this.entityStatusHash[t].pointer-1];return n===Zt&&(e.AABB=this.entityStatusHash[t].entityStatusArr[this.entityStatusHash[t].pointer-2].AABB),e}));switch(n){case Jt:this.dataManager.addEntityData(i);break;case Zt:this.dataManager.editEntitiesData(i);break;case te:this.dataManager.delEntityData(i)}this.pointer++}}}undo(){const t=this.pointer-1;this.revert(t)}redo(){const t=this.pointer+1;this.revert(t)}addStatus(t){t.forEach((t=>{this.entityStatusHash[t.id]||(this.entityStatusHash[t.id]={entityStatusArr:[],pointer:0}),this.entityStatusHash[t.id].entityStatusArr=this.entityStatusHash[t.id].entityStatusArr.slice(0,this.entityStatusHash[t.id].pointer),this.entityStatusHash[t.id].entityStatusArr.push(t),this.entityStatusHash[t.id].pointer++}))}throwStatus(t){t.reverse().forEach((t=>{t.entitiesId.forEach((t=>{this.entityStatusHash[t].entityStatusArr.pop(),this.entityStatusHash[t].pointer--}))}))}};__decorateClass$n([it(It)],ee.prototype,"dataManager",2),ee=__decorateClass$n([injectable()],ee);var ne=Object.defineProperty,ie=Object.getOwnPropertyDescriptor,__decorateClass$m=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?ie(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&ne(e,n,s),s},re=(t=>(t.CommandStart="CommandStart",t.CommandEnd="CommandEnd",t.CommandError="CommandError",t.MateCommandEnd="MateCommandEnd",t))(re||{}),se=(t=>(t.Rretry="Rretry",t.Over="Over",t))(se||{});let oe=class extends ht{constructor(){super(),__publicField(this,"dataManager"),__publicField(this,"guide"),__publicField(this,"commandHistoryManager"),__publicField(this,"shapeIdManager"),__publicField(this,"isRunning",!1),__publicField(this,"description",""),__publicField(this,"nextCommandStateStrArr",[]),__publicField(this,"commandStateStr",""),__publicField(this,"UNDORule",{name:"UNDO",action:()=>{console.warn("方法未实现")},msg:"放弃(U)",next:[]})}run(t,e){try{if(this.isRunning){if("ESCAPE"===t)return this.dispatchEvent("MateCommandEnd",{command:this}),this.dispatchEvent("CommandEnd",{command:this}),void this.commandOver();if(this.nextCommandStateStrArr.includes(t||"")&&(console.info("%c命令从"+this.commandStateStr+"切换到"+t,"color: green;"),this.commandStateStr=t||""),this.rule.subCommand[this.commandStateStr]){console.info("%c当前命令："+this.rule.subCommand[this.commandStateStr].msg,"color: green;");const t=this.rule.subCommand[this.commandStateStr].action(e);if(this.dispatchEvent("MateCommandEnd",{data:t?{...t.data}:{},command:this}),t)switch(t.commandStatusWorkflowType){case"Over":return this.dispatchEvent("CommandEnd",{data:t?{...t.data}:{},command:this}),void this.commandOver();case"Rretry":return}this.commandStateStr&&(console.info("%c可执行命令："+this.rule.subCommand[this.commandStateStr].next.join(" | "),"color: green;"),this.nextCommandStateStrArr=this.rule.subCommand[this.commandStateStr].next,this.commandStateStr=this.rule.subCommand[this.commandStateStr].next[0]),this.commandStateStr||(this.dispatchEvent("CommandEnd",{command:this}),this.commandOver())}else this.dispatchEvent("MateCommandEnd",{command:this}),console.trace("指令状态不合法！")}else{this.dispatchEvent("CommandStart",{command:this}),this.isRunning=!0,console.info("%c当前命令："+this.rule.msg,"color: green;");const t=this.rule.action(e);if(this.dispatchEvent("MateCommandEnd",{data:t?{...t.data}:{},command:this}),t)switch(t.commandStatusWorkflowType){case"Over":return this.dispatchEvent("CommandEnd",{data:t?{...t.data}:{},command:this}),void this.commandOver();case"Rretry":return}console.info("%c可执行命令："+this.rule.next.join(" | "),"color: green;"),this.nextCommandStateStrArr=this.rule.next,this.commandStateStr=this.rule.next[0],this.commandStateStr||(this.dispatchEvent("CommandEnd",{command:this}),this.commandOver())}}catch(n){console.error("指令错误:",n),this.dispatchEvent("CommandError",{command:this}),this.commandOver()}}commandOver(){this.isRunning=!1,console.info("%c命令结束","color: yellow;"),this.commandStateStr="",this.dispose()}shapeCreated(t){const e=[];t.forEach((t=>{const n=deepCopy(t);n.id=this.shapeIdManager.createId(),e.push(n)})),e.length&&(this.dataManager.addEntityData(e),this.commandHistoryManager.add(Jt,e))}shapeEdit(t){t.length&&(this.dataManager.editEntitiesData(t),this.commandHistoryManager.add(Zt,t))}shapeDeleted(t){t.length&&(this.dataManager.delEntityData(t),this.commandHistoryManager.add(te,t),t.forEach((t=>{this.shapeIdManager.deleteId(t.id)})))}};__decorateClass$m([it(It)],oe.prototype,"dataManager",2),__decorateClass$m([it(Gt)],oe.prototype,"guide",2),__decorateClass$m([it(ee)],oe.prototype,"commandHistoryManager",2),__decorateClass$m([it(Kt)],oe.prototype,"shapeIdManager",2),oe=__decorateClass$m([injectable()],oe);class MessageQueue{constructor(t){__publicField(this,"queue",[]),__publicField(this,"isProcessing",!1),__publicField(this,"currentStrategy"),this.setStrategy(t)}setStrategy(t){this.currentStrategy=t}addTask(t){return new Promise(((e,n)=>{this.currentStrategy.addToEnqueue(this,t,e,n),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0,this.currentStrategy.beforeExecuteMessage&&this.currentStrategy.beforeExecuteMessage(this);const{task:t,resolve:e,reject:n}=this.queue.shift();try{e(await this.executeMessage(t))}catch(i){n(i)}this.isProcessing=!1,this.queue.length>0&&this.processQueue()}async executeMessage(t){return"function"==typeof t?await t():"string"==typeof t?(console.log("Message:",t),t):null}getQueueSize(){return this.queue.length}getCurrentStrategy(){return this.currentStrategy.name}}class ExecuteLatestStrategy{constructor(){__publicField(this,"name","ExecuteLatestStrategy")}addToEnqueue(t,e,n,i){t.queue=[{task:e,resolve:n,reject:i}]}}var ae=Object.defineProperty,ce=Object.getOwnPropertyDescriptor,__decorateClass$l=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?ce(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&ae(e,n,s),s};let LINE=class extends oe{constructor(){super(...arguments),__publicField(this,"mouse"),__publicField(this,"description","线段绘制"),__publicField(this,"currentCommandStateStr",""),__publicField(this,"interactionDataArr",[]),__publicField(this,"queue",new MessageQueue(new ExecuteLatestStrategy)),__publicField(this,"addTask",(()=>{this.queue.addTask(this.drawInteractionShape)})),__publicField(this,"firstPoint"),__publicField(this,"rule",{action:()=>{this.currentCommandStateStr="",this.interactionDataArr=[],this.mouse.addEventListener(xt,this.addTask),this.mouse.addEventListener(Mt,this.addTask)},msg:"线段",next:["POINT1"],subCommand:{POINT1:{action:t=>{if(!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:t}},this.firstPoint=this.interactionDataArr[0].data.point},msg:"指定第1点",next:["POINT2","UNDO"]},POINT2:{action:t=>{if(this.currentCommandStateStr="POINT2",!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};{this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:t}};const e={type:this.constructor.name,shape:[{type:this.constructor.name,points:[]}]};2===this.interactionDataArr.length&&(e.shape[0].points=this.interactionDataArr.map((t=>t.data.point)),this.shapeCreated([e]),this.clearInteractionShape(),this.interactionDataArr=[this.interactionDataArr[1]])}},msg:"指定下一点",next:["POINT3","UNDO"]},POINT3:{action:t=>{if(this.currentCommandStateStr="POINT3",!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};{this.interactionDataArr[1]={commandStateStr:"POINT3",data:{point:t}};const e={type:this.constructor.name,shape:[{type:this.constructor.name,points:[]}]};2===this.interactionDataArr.length&&(e.shape[0].points=this.interactionDataArr.map((t=>t.data.point)),this.shapeCreated([e]),this.clearInteractionShape(),this.interactionDataArr=[this.interactionDataArr[1]])}},msg:"指定下一点",next:["POINT3","CLOSE","UNDO"]},UNDO:this.UNDORule,CLOSE:{action:()=>{this.interactionDataArr[1]={commandStateStr:"CLOSE",data:{point:this.firstPoint}};const t={type:this.constructor.name,shape:[{type:this.constructor.name,points:[]}]};2===this.interactionDataArr.length&&(t.shape[0].points=this.interactionDataArr.map((t=>t.data.point)),this.shapeCreated([t]),this.clearInteractionShape())},msg:"闭合(C)",next:[]}}}),__publicField(this,"drawInteractionShape",(()=>{const t=[],e={type:At.LINE,shape:[{type:At.LINE,points:[]}]};1===this.interactionDataArr.length&&(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[0].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]),t.push(e),this.clearInteractionShape(),this.guide.render(t).then((()=>{this.isRunning||this.clearInteractionShape()}))}))}clearInteractionShape(){this.guide.clearAll()}dispose(){this.clearInteractionShape(),this.mouse.removeEventListener(xt,this.addTask),this.mouse.removeEventListener(Mt,this.addTask)}};__decorateClass$l([it(Lt)],LINE.prototype,"mouse",2),LINE=__decorateClass$l([injectable()],LINE);class ERASE extends oe{constructor(){super(...arguments),__publicField(this,"rule",{action:()=>{if(this.dataManager.selectionBoxEntities.length<=0)return{data:{event:"CommandSelect"},commandStatusWorkflowType:se.Over};const t=this.dataManager.selectionBoxEntities.length;this.shapeDeleted(this.dataManager.selectionBoxEntities),console.info(`删除${t}个对象`)},msg:"删除",next:[],subCommand:{}})}dispose(){}}var he=Object.defineProperty,ue=Object.getOwnPropertyDescriptor,__decorateClass$k=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?ue(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&he(e,n,s),s};let MOVE=class extends oe{constructor(){super(...arguments),__publicField(this,"mouse"),__publicField(this,"description","移动"),__publicField(this,"currentCommandStateStr",""),__publicField(this,"interactionDataArr",[]),__publicField(this,"queue",new MessageQueue(new ExecuteLatestStrategy)),__publicField(this,"addTask",(()=>{this.queue.addTask(this.drawInteractionShape)})),__publicField(this,"rule",{action:()=>{if(this.dataManager.selectionBoxEntities.length<=0)return{data:{event:"CommandSelect"},commandStatusWorkflowType:se.Over};this.currentCommandStateStr="",this.interactionDataArr=[],this.mouse.addEventListener(xt,this.addTask),this.mouse.addEventListener(Mt,this.addTask)},msg:"移动",next:["POINT1","DISPLACEMENT"],subCommand:{POINT1:{action:t=>{if(!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:t}}},msg:"指定基点",next:["POINT2"]},POINT2:{action:t=>(this.currentCommandStateStr="POINT2",this.setFinalPoint(t)),msg:"指定第二个点",next:[]},DISPLACEMENT:{action:()=>{this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:[0,0]}}},msg:"位移(D)",next:["DISPLACEMENTNUM"]},DISPLACEMENTNUM:{action:t=>(this.currentCommandStateStr="DISPLACEMENTNUM",this.setFinalPoint(t)),msg:"指定位移",next:[]}}}),__publicField(this,"drawInteractionShape",(()=>{const t=[],e={type:At.LINE,shape:[{type:At.LINE,points:[]}]};if(1===this.interactionDataArr.length&&(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[0].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]),t.push(e),1===this.interactionDataArr.length){const e=deepCopy(this.dataManager.selectionBoxEntities),n=[this.mouse.mouseX-this.interactionDataArr[0].data.point[0],this.mouse.mouseY-this.interactionDataArr[0].data.point[1]];t.push(...e.map((t=>{var e;return t.shape.forEach((t=>{var e;null==(e=t.points)||e.forEach((t=>{t.forEach(((e,i)=>{n[i]&&(t[i]=e+n[i])}))}))})),(null==(e=t.other)?void 0:e.boxSelected)&&(t.other.boxSelected=!1),t})))}this.clearInteractionShape(),this.guide.render(t).then((()=>{this.isRunning||this.clearInteractionShape()}))}))}setFinalPoint(t){const e=this.dataManager.selectionBoxEntities.length;if(e>0){if(isNumArray(t))this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:t}};else{if(!isNumeric(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};{this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:[0,0]}};const e=this.interactionDataArr[0].data.point,n=this.movePoint(e,[this.mouse.mouseX-e[0],this.mouse.mouseY-e[1]],Number(t));this.interactionDataArr[1].data.point=n}}const n=deepCopy(this.dataManager.selectionBoxEntities),i=[this.interactionDataArr[1].data.point[0]-this.interactionDataArr[0].data.point[0],this.interactionDataArr[1].data.point[1]-this.interactionDataArr[0].data.point[1]];this.shapeEdit(n.map((t=>{var e;return t.shape.forEach((t=>{var e;null==(e=t.points)||e.forEach((t=>{t.forEach(((e,n)=>{i[n]&&(t[n]=e+i[n])}))}))})),(null==(e=t.other)?void 0:e.boxSelected)&&(t.other.boxSelected=!1),t}))),console.info(`移动了${e}个对象`)}}movePoint(t,e,n){const[i,r]=t,[s,o]=e,a=Math.sqrt(s*s+o*o),c=[s/a,o/a];return[i+n*c[0],r+n*c[1]]}clearInteractionShape(){this.guide.clearAll()}dispose(){this.clearInteractionShape(),this.mouse.removeEventListener(xt,this.addTask),this.mouse.removeEventListener(Mt,this.addTask)}};__decorateClass$k([it(Lt)],MOVE.prototype,"mouse",2),MOVE=__decorateClass$k([injectable()],MOVE);var de=Object.defineProperty,le=Object.getOwnPropertyDescriptor,__decorateClass$j=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?le(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&de(e,n,s),s};let COPY=class extends oe{constructor(){super(...arguments),__publicField(this,"mouse"),__publicField(this,"description","复制"),__publicField(this,"currentCommandStateStr",""),__publicField(this,"interactionDataArr",[]),__publicField(this,"queue",new MessageQueue(new ExecuteLatestStrategy)),__publicField(this,"addTask",(()=>{this.queue.addTask(this.drawInteractionShape)})),__publicField(this,"rule",{action:()=>{if(this.dataManager.selectionBoxEntities.length<=0)return{data:{event:"CommandSelect"},commandStatusWorkflowType:se.Over};this.currentCommandStateStr="",this.interactionDataArr=[],this.mouse.addEventListener(xt,this.addTask),this.mouse.addEventListener(Mt,this.addTask)},msg:"复制",next:["POINT1"],subCommand:{POINT1:{action:t=>{if(!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:t}}},msg:"指定基点",next:["POINT2"]},POINT2:{action:t=>{this.currentCommandStateStr="POINT2";const e=this.dataManager.selectionBoxEntities.length;if(e>0){if(isNumArray(t))this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:t}};else{if(!isNumeric(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};{this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:[0,0]}};const e=this.interactionDataArr[0].data.point,n=this.movePoint(e,[this.mouse.mouseX-e[0],this.mouse.mouseY-e[1]],Number(t));this.interactionDataArr[1].data.point=n}}const n=deepCopy(this.dataManager.selectionBoxEntities),i=[this.interactionDataArr[1].data.point[0]-this.interactionDataArr[0].data.point[0],this.interactionDataArr[1].data.point[1]-this.interactionDataArr[0].data.point[1]];this.shapeCreated(n.map((t=>{var e;return t.shape.forEach((t=>{var e;null==(e=t.points)||e.forEach((t=>{t.forEach(((e,n)=>{i[n]&&(t[n]=e+i[n])}))}))})),(null==(e=t.other)?void 0:e.boxSelected)&&(t.other.boxSelected=!1),t}))),this.interactionDataArr=[this.interactionDataArr[0]],console.info(`复制了${e}个对象`)}},msg:"指定第二个点",next:["POINT2","UNDO"]},UNDO:this.UNDORule}}),__publicField(this,"drawInteractionShape",(()=>{const t=[],e={type:At.LINE,shape:[{type:At.LINE,points:[]}]};if(1===this.interactionDataArr.length&&(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[0].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]),t.push(e),1===this.interactionDataArr.length){const e=deepCopy(this.dataManager.selectionBoxEntities),n=[this.mouse.mouseX-this.interactionDataArr[0].data.point[0],this.mouse.mouseY-this.interactionDataArr[0].data.point[1]];t.push(...e.map((t=>{var e;return t.shape.forEach((t=>{var e;null==(e=t.points)||e.forEach((t=>{t.forEach(((e,i)=>{n[i]&&(t[i]=e+n[i])}))}))})),(null==(e=t.other)?void 0:e.boxSelected)&&(t.other.boxSelected=!1),t})))}this.clearInteractionShape(),this.guide.render(t).then((()=>{this.isRunning||this.clearInteractionShape()}))}))}movePoint(t,e,n){const[i,r]=t,[s,o]=e,a=Math.sqrt(s*s+o*o),c=[s/a,o/a];return[i+n*c[0],r+n*c[1]]}clearInteractionShape(){this.guide.clearAll()}dispose(){this.clearInteractionShape(),this.mouse.removeEventListener(xt,this.addTask),this.mouse.removeEventListener(Mt,this.addTask)}};__decorateClass$j([it(Lt)],COPY.prototype,"mouse",2),COPY=__decorateClass$j([injectable()],COPY);var pe=Object.defineProperty,ge=Object.getOwnPropertyDescriptor,__decorateClass$i=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?ge(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&pe(e,n,s),s};let RECTANGLE=class extends oe{constructor(){super(...arguments),__publicField(this,"mouse"),__publicField(this,"description","矩形绘制"),__publicField(this,"currentCommandStateStr",""),__publicField(this,"interactionDataArr",[]),__publicField(this,"rule",{action:()=>{this.currentCommandStateStr="",this.interactionDataArr=[]},msg:"矩形",next:["POINT1","CHAMFER","ELEVATION","FILLET","THICKNESS","WIDTH"],subCommand:{POINT1:{action:()=>{},msg:"指定第一个角点",next:["POINT2","AREA","DIMENSION","ROTATION"]},POINT2:{action:()=>{},msg:"指定另一个角点",next:[]},AREA:{action:()=>{},msg:"面积(A)",next:["AREAINPUT"]},AREAINPUT:{action:(t=100)=>{},msg:"输入以当前单位计算的矩形面积 <100.0000>",next:["LENGTHORWIDTH"]},LENGTHORWIDTH:{action:(t="LENGTH")=>{},msg:"计算矩形标注时依据",next:["ALENGTH","AWIDTH"]},ALENGTH:{action:()=>{},msg:"长度(L)",next:[]},AWIDTH:{action:()=>{},msg:"宽度(W)",next:[]},DIMENSION:{action:()=>{},msg:"尺寸(D)",next:["RLENGTH"]},RLENGTH:{action:()=>{},msg:"指定矩形的长度",next:["RWIDTH"]},RWIDTH:{action:()=>{},msg:"指定矩形的宽度",next:["POINT1"]},ROTATION:{action:()=>{},msg:"旋转(R)",next:["RANGLE","PICKUP"]},RANGLE:{action:()=>{},msg:"旋转角度",next:["POINT1"]},PICKUP:{action:()=>{},msg:"拾取点(P)",next:["PPOINT1"]},PPOINT1:{action:()=>{},msg:"指定第一点",next:["PPOINT2"]},PPOINT2:{action:()=>{},msg:"指定第二点",next:["POINT1"]},CHAMFER:{action:()=>{},msg:"倒角(C)",next:["CHAMFER1"]},CHAMFER1:{action:()=>{},msg:"指定矩形的第一个倒角距离",next:["CHAMFER2"]},CHAMFER2:{action:()=>{},msg:"指定矩形的第2个倒角距离",next:["POINT1"]},ELEVATION:{action:()=>{},msg:"指定标高",next:["POINT1"]},FILLET:{action:()=>{},msg:"圆角尺寸",next:["POINT1"]},THICKNESS:{action:()=>{},msg:"厚度大小",next:["POINT1"]},WIDTH:{action:()=>{},msg:"宽度大小",next:["POINT1"]}}})}dispose(){}};__decorateClass$i([it(Lt)],RECTANGLE.prototype,"mouse",2),RECTANGLE=__decorateClass$i([injectable()],RECTANGLE);class CircleCalculator{constructor(t,e){__publicField(this,"points"),__publicField(this,"r"),this.points=[t],this.r=e}static from3Points(t){if(3!==t.length)throw new Error("Exactly three points are required");const[e,n,i]=t,r=n[0]-e[0],s=n[1]-e[1],o=i[0]-e[0],a=i[1]-e[1],c=r*(e[0]+n[0])+s*(e[1]+n[1]),h=o*(e[0]+i[0])+a*(e[1]+i[1]),u=2*(r*(i[1]-e[1])-s*(i[0]-e[0]));if(0===u)throw new Error("三个点共线，无法确定圆");const d=(a*c-s*h)/u,l=(r*h-o*c)/u,p=[d,l],g=Math.sqrt((d-e[0])**2+(l-e[1])**2);return new CircleCalculator(p,g)}getCircleParams(){return{points:this.points,r:this.r}}getQuadrantPoints(){const[t,e]=this.points[0],n=this.r;return[[t,e+n],[t-n,e],[t,e-n],[t+n,e]]}}var me=Object.defineProperty,fe=Object.getOwnPropertyDescriptor,__decorateClass$h=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?fe(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&me(e,n,s),s};let CIRCLE=class extends oe{constructor(){super(...arguments),__publicField(this,"mouse"),__publicField(this,"description","圆绘制"),__publicField(this,"currentCommandStateStr",""),__publicField(this,"interactionDataArr",[]),__publicField(this,"queue",new MessageQueue(new ExecuteLatestStrategy)),__publicField(this,"addTask",(()=>{this.queue.addTask(this.drawInteractionShape)})),__publicField(this,"rule",{action:()=>{this.currentCommandStateStr="",this.interactionDataArr=[],this.mouse.addEventListener(xt,this.addTask),this.mouse.addEventListener(Mt,this.addTask)},msg:"圆",next:["CENTER","P3","P2","T"],subCommand:{CENTER:{action:t=>{if(!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:t}}},msg:"圆心(CENTER)",next:["R","D"]},R:{action:t=>{if(this.currentCommandStateStr="R",isNumArray(t)){if(this.interactionDataArr[1]={commandStateStr:"R",data:{point:t||[0,0]}},2===this.interactionDataArr.length){const t=this.interactionDataArr[1].data.point,e=this.interactionDataArr[0].data.point,n={type:this.constructor.name,shape:[{type:this.constructor.name,points:[e],r:Math.sqrt((t[0]-e[0])**2+(t[1]-e[1])**2)}]};this.shapeCreated([n]),this.clearInteractionShape()}}else{if(!isNumeric(t))return console.log("请输入半径"),{commandStatusWorkflowType:se.Rretry};{const e=this.interactionDataArr[0].data.point,n={type:this.constructor.name,shape:[{type:this.constructor.name,points:[e],r:t}]};this.shapeCreated([n]),this.clearInteractionShape()}}},msg:"半径(R)",next:[]},D:{action:t=>{if(this.currentCommandStateStr="D",isNumArray(t)){if(this.interactionDataArr[1]={commandStateStr:"D",data:{point:t||[0,0]}},2===this.interactionDataArr.length){const t=this.interactionDataArr[1].data.point,e=this.interactionDataArr[0].data.point,n={type:this.constructor.name,shape:[{type:this.constructor.name,points:[e],r:Math.sqrt((t[0]-e[0])**2+(t[1]-e[1])**2)/2}]};this.shapeCreated([n]),this.clearInteractionShape()}}else{if(!isNumeric(t))return console.log("请输入直径"),{commandStatusWorkflowType:se.Rretry};{const e=this.interactionDataArr[0].data.point,n={type:this.constructor.name,shape:[{type:this.constructor.name,points:[e],r:t/2}]};this.shapeCreated([n]),this.clearInteractionShape()}}},msg:"直径(D)",next:[]},P3:{action:()=>{this.currentCommandStateStr="P3"},msg:"三点(P3)",next:["POINT1"]},POINT1:{action:t=>{if(!isNumArray(t))return console.log("请输入坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:t}}},msg:"第一点(POINT1)",next:["POINT2"]},POINT2:{action:t=>{if(!isNumArray(t))return console.log("请输入坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:t}}},msg:"第二点(POINT2)",next:["POINT3"]},POINT3:{action:t=>{if(!isNumArray(t))return console.log("请输入坐标点"),{commandStatusWorkflowType:se.Rretry};{this.interactionDataArr[2]={commandStateStr:"POINT3",data:{point:t}};const e=CircleCalculator.from3Points(this.interactionDataArr.map((t=>t.data.point))).getCircleParams(),n={type:this.constructor.name,shape:[{type:this.constructor.name,points:e.points,r:e.r}]};this.shapeCreated([n]),this.clearInteractionShape()}},msg:"第三点(POINT3)",next:[]}}}),__publicField(this,"drawInteractionShape",(()=>{let t=[];if("P3"===this.currentCommandStateStr){t=[];const e={type:At.LINE,shape:[{type:At.LINE,points:[]}]};if(1===this.interactionDataArr.length?(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[0].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]):2===this.interactionDataArr.length&&(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[1].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]),t.push(e),2===this.interactionDataArr.length){const e={type:this.constructor.name,shape:[{type:this.constructor.name,points:[]}]},n=[...this.interactionDataArr.map((t=>t.data.point)),[this.mouse.mouseX,this.mouse.mouseY]];e.shape[0]={...e.shape[0],...CircleCalculator.from3Points(n).getCircleParams()},t.push(e)}}else if(1===this.interactionDataArr.length){t=[];const e={type:At.LINE,shape:[{type:At.LINE,points:[]}]};1===this.interactionDataArr.length&&(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[0].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]),t.push(e);const n=this.interactionDataArr[0].data.point,i=[this.mouse.mouseX,this.mouse.mouseY],r={type:this.constructor.name,shape:[{type:this.constructor.name,points:[n],r:Math.sqrt((n[0]-i[0])**2+(n[1]-i[1])**2)/("D"===this.currentCommandStateStr?2:1)}]};t.push(r)}this.clearInteractionShape(),this.guide.render(t).then((()=>{this.isRunning||this.clearInteractionShape()}))}))}clearInteractionShape(){this.guide.clearAll()}dispose(){this.clearInteractionShape(),this.mouse.removeEventListener(xt,this.addTask),this.mouse.removeEventListener(Mt,this.addTask)}};__decorateClass$h([it(Lt)],CIRCLE.prototype,"mouse",2),CIRCLE=__decorateClass$h([injectable()],CIRCLE);var ye=Object.defineProperty,ve=Object.getOwnPropertyDescriptor,__decorateClass$g=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?ve(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&ye(e,n,s),s};let ARC=class extends oe{constructor(){super(...arguments),__publicField(this,"mouse"),__publicField(this,"description","圆弧绘制"),__publicField(this,"currentCommandStateStr",""),__publicField(this,"interactionDataArr",[]),__publicField(this,"queue",new MessageQueue(new ExecuteLatestStrategy)),__publicField(this,"addTask",(()=>{this.queue.addTask(this.drawInteractionShape)})),__publicField(this,"rule",{action:()=>{this.currentCommandStateStr="",this.interactionDataArr=[],this.mouse.addEventListener(xt,this.addTask),this.mouse.addEventListener(Mt,this.addTask)},msg:"圆弧",next:["POINT1"],subCommand:{POINT1:{action:t=>{if(this.currentCommandStateStr="POINT1",!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:t}}},msg:"指定第1个点",next:["POINT2","UNDO"]},POINT2:{action:t=>{if(this.currentCommandStateStr="POINT2",!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:t}}},msg:"指定第2个点",next:["POINT3","UNDO"]},POINT3:{action:t=>{if(this.currentCommandStateStr="POINT3",!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};{this.interactionDataArr[2]={commandStateStr:"POINT3",data:{point:t}};const e={type:this.constructor.name,shape:[{type:this.constructor.name,points:[]}]};if(3!==this.interactionDataArr.length)throw new Error("交互点数量不对！");e.shape[0]={...e.shape[0],...ArcCalculator.from3Points(this.interactionDataArr.map((t=>t.data.point))).getCanvasArcParams()},this.shapeCreated([e]),this.clearInteractionShape()}},msg:"指定端点",next:[]},UNDO:this.UNDORule}}),__publicField(this,"drawInteractionShape",(()=>{const t=[],e={type:At.LINE,shape:[{type:At.LINE,points:[]}]};if(1===this.interactionDataArr.length?(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[0].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]):2===this.interactionDataArr.length&&(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[1].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]),t.push(e),2===this.interactionDataArr.length){const e={type:this.constructor.name,shape:[{type:this.constructor.name,points:[]}]},n=[...this.interactionDataArr.map((t=>t.data.point)),[this.mouse.mouseX,this.mouse.mouseY]];e.shape[0]={...e.shape[0],...ArcCalculator.from3Points(n).getCanvasArcParams()},t.push(e)}this.clearInteractionShape(),this.guide.render(t).then((()=>{this.isRunning||this.clearInteractionShape()}))}))}clearInteractionShape(){this.guide.clearAll()}dispose(){this.clearInteractionShape(),this.mouse.removeEventListener(xt,this.addTask),this.mouse.removeEventListener(Mt,this.addTask)}};__decorateClass$g([it(Lt)],ARC.prototype,"mouse",2),ARC=__decorateClass$g([injectable()],ARC);var Se=Object.defineProperty,Ae=Object.getOwnPropertyDescriptor,__decorateClass$f=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Ae(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Se(e,n,s),s};let PLINE=class extends oe{constructor(){super(...arguments),__publicField(this,"mouse"),__publicField(this,"description","多段线绘制"),__publicField(this,"currentCommandStateStr",""),__publicField(this,"interactionDataArr",[]),__publicField(this,"queue",new MessageQueue(new ExecuteLatestStrategy)),__publicField(this,"addTask",(()=>{this.queue.addTask(this.drawInteractionShape)})),__publicField(this,"drawShapeItemType",At.LINE),__publicField(this,"entityTemp",{type:this.constructor.name,shape:[]}),__publicField(this,"rule",{action:()=>{this.currentCommandStateStr="",this.interactionDataArr=[],this.mouse.addEventListener(xt,this.addTask),this.mouse.addEventListener(Mt,this.addTask)},msg:"多段线",next:["POINT1"],subCommand:{POINT1:{action:t=>{if(!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:t}}},msg:"起点",next:["POINT2","A","L","H","U","W"]},POINT2:{action:t=>{if(!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:t}},2===this.interactionDataArr.length&&(this.entityTemp.shape.push(this.creatNewShapeItem(this.interactionDataArr[1].data.point)),this.clearInteractionShape(),this.interactionDataArr=[this.interactionDataArr[1]])},msg:"指定下一点",next:["POINT2","A","C","H","L","U","W"]},L:{action:()=>{this.drawShapeItemType=At.LINE},msg:"绘制线段",next:["POINT2"]},A:{action:()=>{this.drawShapeItemType=At.ARC},msg:"绘制圆弧",next:["POINT2"]}}}),__publicField(this,"drawInteractionShape",(()=>{const t=[],e={type:At.LINE,shape:[{type:At.LINE,points:[]}]};if(1===this.interactionDataArr.length&&(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[0].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]),t.push(e),1===this.interactionDataArr.length){const e=deepCopy(this.entityTemp);e.shape.push(this.creatNewShapeItem([this.mouse.mouseX,this.mouse.mouseY])),t.push(e)}this.clearInteractionShape(),this.guide.render(t).then((()=>{this.isRunning||this.clearInteractionShape()}))}))}creatNewShapeItem(t){var e;if(this.drawShapeItemType===At.LINE)return{type:At.LINE,points:[this.interactionDataArr[0].data.point,t]};if(this.drawShapeItemType===At.ARC){const n=this.entityTemp.shape[this.entityTemp.shape.length-1];if(n&&n.type===At.LINE&&2===(null==(e=n.points)?void 0:e.length))return{type:At.ARC,...ArcCalculator.fromTangencyLine(n.points[0],n.points[1],t).getCanvasArcParams()};if(n&&n.type===At.ARC&&n.points&&n.r)return{type:At.ARC,...ArcCalculator.fromTangencyArc(n,t).getCanvasArcParams()}}throw new Error("Unsupported shape type")}clearInteractionShape(){this.guide.clearAll()}dispose(){this.clearInteractionShape(),this.mouse.removeEventListener(xt,this.addTask),this.mouse.removeEventListener(Mt,this.addTask)}};__decorateClass$f([it(Lt)],PLINE.prototype,"mouse",2),PLINE=__decorateClass$f([injectable()],PLINE);class HELP extends oe{constructor(){super(...arguments),__publicField(this,"rule",{action:()=>{console.log("展示帮助文档")},msg:"帮助",next:[],subCommand:{}})}dispose(){}}var be=Object.defineProperty,Ce=Object.getOwnPropertyDescriptor,__decorateClass$e=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Ce(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&be(e,n,s),s};let MTEXT=class extends oe{constructor(){super(...arguments),__publicField(this,"mouse"),__publicField(this,"description","多行文本"),__publicField(this,"currentCommandStateStr",""),__publicField(this,"interactionDataArr",[]),__publicField(this,"queue",new MessageQueue(new ExecuteLatestStrategy)),__publicField(this,"addTask",(()=>{this.queue.addTask(this.drawInteractionShape)})),__publicField(this,"rule",{action:()=>{this.currentCommandStateStr="",this.interactionDataArr=[],this.mouse.addEventListener(xt,this.addTask),this.mouse.addEventListener(Mt,this.addTask)},msg:"多行文本",next:["POINT1"],subCommand:{POINT1:{action:t=>{if(this.currentCommandStateStr="POINT1",!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:t}}},msg:"指定第1点",next:["POINT2","UNDO"]},POINT2:{action:t=>{if(this.currentCommandStateStr="POINT2",!isNumArray(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};if(this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:t}},2!==this.interactionDataArr.length)throw new Error("交互点数量不对！");{const t={type:this.constructor.name,shape:[{type:this.constructor.name,points:this.interactionDataArr.map((t=>t.data.point))}]};this.shapeCreated([t]),this.clearInteractionShape()}},msg:"指定终点",next:[]}}}),__publicField(this,"drawInteractionShape",(()=>{const t=[],e={type:At.LINE,shape:[{type:At.LINE,points:[]}]};if(1===this.interactionDataArr.length&&(e.shape[e.shape.length-1].points[0]=this.interactionDataArr[0].data.point,e.shape[e.shape.length-1].points[1]=[this.mouse.mouseX,this.mouse.mouseY]),t.push(e),1===this.interactionDataArr.length){const e={type:this.constructor.name,shape:[{type:this.constructor.name,points:[this.interactionDataArr[0].data.point,[this.mouse.mouseX,this.mouse.mouseY]]}]};t.push(e)}this.clearInteractionShape(),this.guide.render(t).then((()=>{this.isRunning||this.clearInteractionShape()}))}))}clearInteractionShape(){this.guide.clearAll()}dispose(){this.clearInteractionShape(),this.mouse.removeEventListener(xt,this.addTask),this.mouse.removeEventListener(Mt,this.addTask)}};__decorateClass$e([it(Lt)],MTEXT.prototype,"mouse",2),MTEXT=__decorateClass$e([injectable()],MTEXT);var we=Object.getOwnPropertyDescriptor;let SELECTIONBOXALL=class extends oe{constructor(){super(...arguments),__publicField(this,"rule",{action:()=>{this.setSelectionBoxAll()},msg:"全选",next:[],subCommand:{}})}setSelectionBoxAll(){const t=this.dataManager.all().map((t=>(t.other||(t.other={}),t.other.boxSelected=!0,t)));this.shapeEdit(t)}dispose(){}};SELECTIONBOXALL=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?we(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],SELECTIONBOXALL);var Ie=Object.getOwnPropertyDescriptor;let Ee=class{constructor(){__publicField(this,"accurary",1e-6)}numEqual(t,e){return t-e<this.accurary}};Ee=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?Ie(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],Ee);class PointCalculator{constructor(t){__publicField(this,"points"),this.points=[t]}getToPointDistance(t){const e=t[0]-this.points[0][0],n=t[1]-this.points[0][1];return Math.sqrt(e*e+n*n)}getToSegmentDistance(t,e){const[n,i]=this.points[0],[r,s]=t,[o,a]=e,c=o-r,h=a-s;if(0===c&&0===h)return Math.sqrt((n-r)**2+(i-s)**2);const u=((n-r)*c+(i-s)*h)/(c*c+h*h);if(u<0)return Math.sqrt((n-r)**2+(i-s)**2);if(u>1)return Math.sqrt((n-o)**2+(i-a)**2);const d=r+u*c,l=s+u*h;return Math.sqrt((n-d)**2+(i-l)**2)}getToCircleDistance(t,e){const[n,i]=this.points[0],[r,s]=t,o=Math.sqrt((n-r)**2+(i-s)**2);return Math.abs(o-e)}getToArcDistance(t,e,n,i,r=!1){const[s,o]=this.points[0],[a,c]=t,h=Math.atan2(o-c,s-a),u=r?h<=n&&h>=i:h>=n&&h<=i,d=Math.sqrt((s-a)**2+(o-c)**2),l=Math.abs(d-e);if(u)return l;{const t=a+e*Math.cos(n),r=c+e*Math.sin(n),h=a+e*Math.cos(i),u=c+e*Math.sin(i),d=Math.sqrt((s-t)**2+(o-r)**2),l=Math.sqrt((s-h)**2+(o-u)**2);return Math.min(d,l)}}getSegmentClosest(t,e){const[n,i]=this.points[0],[r,s]=t,[o,a]=e,c=o-r,h=a-s;if(0===c&&0===h)return[r,s];const u=((n-r)*c+(i-s)*h)/(c*c+h*h);if(u<=0)return[r,s];if(u>=1)return[o,a];return[r+u*c,s+u*h]}getCircleClosest(t,e){const[n,i]=this.points[0],[r,s]=t,o=n-r,a=i-s,c=Math.sqrt(o*o+a*a);if(0===c)return[r+e,s];const h=e/c;return[r+o*h,s+a*h]}getArcClosest(t,e,n,i,r=!1){const[s,o]=this.points[0],[a,c]=t;let h=Math.atan2(o-c,s-a);h<0&&(h+=2*Math.PI);const u=n<0?n+2*Math.PI:n,d=i<0?i+2*Math.PI:i;let l=Math.min(u,d),p=Math.max(u,d);r&&([l,p]=[p,l]);let g=h;if(r){if(h>l&&h<p){g=Math.min(Math.abs(h-l),2*Math.PI-Math.abs(h-l))<Math.min(Math.abs(h-p),2*Math.PI-Math.abs(h-p))?l:p}}else h<l?g=l:h>p&&(g=p);return[a+e*Math.cos(g),c+e*Math.sin(g)]}getSegmentClosestPointAndDistance(t,e){const n=this.getSegmentClosest(t,e);return{point:n,distance:this.getToPointDistance(n)}}getSegmentPerpendicular(t,e){const[n,i]=this.points[0],[r,s]=t,[o,a]=e,c=o-r,h=a-s;if(0===c&&0===h)return null;const u=((n-r)*c+(i-s)*h)/(c*c+h*h);if(u<0||u>1)return null;return[r+u*c,s+u*h]}getCircleTangency(t,e){const[n,i]=this.points[0],[r,s]=t,o=n-r,a=i-s,c=Math.sqrt(o*o+a*a);if(c<=e)return null;const h=e/c,u=h*a,d=h*o;return[[r+h*o-u,s+h*a+d],[r+h*o+u,s+h*a-d]]}getArcTangency(t,e,n,i,r=!1){const[s,o]=this.points[0],[a,c]=t,h=s-a,u=o-c,d=Math.sqrt(h*h+u*u);if(d<=e)return null;const l=Math.atan2(u,h),p=Math.acos(e/d),g=l+p,m=l-p,f=[a+e*Math.cos(g),c+e*Math.sin(g)],y=[a+e*Math.cos(m),c+e*Math.sin(m)],v=r?g<=n&&g>=i:g>=n&&g<=i,S=r?m<=n&&m>=i:m>=n&&m<=i;return v&&S?[f,y]:v?[f]:S?[y]:null}}class ListNode{constructor(t,e){__publicField(this,"key"),__publicField(this,"value"),__publicField(this,"prev",null),__publicField(this,"next",null),this.key=t,this.value=e}}class LRUCache{constructor(t){__publicField(this,"capacity"),__publicField(this,"cache"),__publicField(this,"head",null),__publicField(this,"tail",null),this.capacity=t,this.cache=new Map}get(t){if(!this.cache.has(t))return null;const e=this.cache.get(t);return this.moveToHead(e),e.value}put(t,e){if(this.cache.has(t)){const n=this.cache.get(t);n.value=e,this.moveToHead(n)}else{const n=new ListNode(t,e);this.cache.size>=this.capacity&&this.removeTail(),this.addToHead(n),this.cache.set(t,n)}}moveToHead(t){this.removeNode(t),this.addToHead(t)}addToHead(t){t.next=this.head,t.prev=null,null!==this.head&&(this.head.prev=t),this.head=t,null===this.tail&&(this.tail=t)}removeNode(t){null!==t.prev?t.prev.next=t.next:this.head=t.next,null!==t.next?t.next.prev=t.prev:this.tail=t.prev}removeTail(){null!==this.tail&&(this.cache.delete(this.tail.key),this.removeNode(this.tail))}has(t){return this.cache.has(t)}remove(t){const e=this.cache.get(t);e&&(this.removeNode(e),this.cache.delete(t))}}var Me=Object.defineProperty,Te=Object.getOwnPropertyDescriptor,__decorateClass$b=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Te(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Me(e,n,s),s};let xe=class{constructor(){__publicField(this,"dataManager"),__publicField(this,"entitiesKeyNodesCache",new LRUCache(20))}getEntitiesKeyNodes(t,e,n){this.getEntitiesArrKeyNode(e);const i=new RectangleCalculator(t[0],t[1]),r=[];return e.forEach((t=>{const e=this.entitiesKeyNodesCache.get(t.id);if(!e)return null;e.forEach(((e,s)=>{Object.entries(e).forEach((([e,o])=>{const a=Number(e);o.forEach(((e,o)=>{(!n||Array.isArray(n)&&n.includes(a))&&i.isPointInside(e)&&r.push({entity:t,shapeIndex:s,keyNode:a,pointIndex:o,coordinate:e})}))}))}))})),r}getEntitiesArrKeyNode(t){t.forEach((t=>{const e=this.entitiesKeyNodesCache.get(t.id);if(e)this.entitiesKeyNodesCache.put(t.id,e);else{const e=[];t.shape.forEach(((t,n)=>{e[n]=this.getSnapKeyNode(t)})),this.entitiesKeyNodesCache.put(t.id,e)}}))}getSnapKeyNode(t){const e={};switch(t.type){case At.LINE:if(Array.isArray(t.points)?e[De.Endpoint]=[t.points[0],t.points[1]]:console.error("异常数据"),t.points&&t.points.length>=2){const n=new LineCalculator(t.points[0],t.points[1]).getMidPoint();e[De.Midpoint]=[n]}else console.error("异常数据");break;case At.MTEXT:if(Array.isArray(t.points)){const n=t.points[0],i=t.points[1];e[De.Endpoint]=[n,[i[0],n[1]],i,[n[0],i[1]]]}else console.error("异常数据");break;case At.CIRCLE:if(e[De.Center]=[t.points[0]],t.points&&t.r){const n=t.points[0];e[De.Quadrant]=new CircleCalculator(n,t.r).getQuadrantPoints()}else console.error("异常数据");break;case At.ARC:e[De.Center]=[[]],e[De.Endpoint]=[[],[]],e[De.Midpoint]=[[]]}return e}dataManagerListenerInit(){this.dataManager.addEventListener(Ct,((t,e)=>{this.deleteEntityKeyNodesCache(t)})),this.dataManager.addEventListener(wt,((t,e)=>{this.deleteEntityKeyNodesCache(t)}))}deleteEntityKeyNodesCache(t){t.forEach((t=>{this.entitiesKeyNodesCache.has(t.id)&&this.entitiesKeyNodesCache.remove(t.id)}))}};__decorateClass$b([it(It)],xe.prototype,"dataManager",2),__decorateClass$b([rt()],xe.prototype,"dataManagerListenerInit",1),xe=__decorateClass$b([injectable()],xe);var Ne=Object.defineProperty,Pe=Object.getOwnPropertyDescriptor,__decorateClass$a=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Pe(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Ne(e,n,s),s},De=(t=>(t[t.Endpoint=0]="Endpoint",t[t.Midpoint=1]="Midpoint",t[t.Center=2]="Center",t[t.Node=3]="Node",t[t.Quadrant=4]="Quadrant",t[t.Intersection=5]="Intersection",t[t.Extension=6]="Extension",t[t.InsertionPoint=7]="InsertionPoint",t[t.Perpendicular=8]="Perpendicular",t[t.Tangent=9]="Tangent",t[t.Nearest=10]="Nearest",t[t.ApparentIntersection=11]="ApparentIntersection",t[t.Parallel=12]="Parallel",t))(De||{});let Le=class{constructor(){__publicField(this,"systemConfig"),__publicField(this,"dataManager"),__publicField(this,"entitiesKeyNodeManager"),__publicField(this,"mouse"),__publicField(this,"computGeometry"),__publicField(this,"interactionVisual"),__publicField(this,"openSnap",!0),__publicField(this,"openSnapType",[]),__publicField(this,"lastIntersectionShapeCoordinate",null),__publicField(this,"closestKeyNodeArr",[])}init(){this.setOpenSnapType([0,1,2,3,4,5,6,7,8,9,10,11,12])}getSnapBaseCoordinate(t){if(this.closestKeyNodeArr=[],this.canSnap()){if(t===Yt.CROSS){const t=this.snap();return t?this.mouse.affineTransformPoint(t):null}return this.getSnapBaseCoordinateWithoutCommanding(t)}return null}getClosestKeyNodeArr(){return console.warn("closestKeyNodeArr数据对外需进一步优化，此为临时方案！"),this.closestKeyNodeArr}canSnap(){return!!this.openSnap}canOnlySnapselectionBoxEntities(t){const e=this.dataManager.selectionBoxEntities.length;return t===Yt.CROSSWITHSQUARE&&e>0&&e<this.systemConfig.maxNodeEntityShowNum}getSnapBaseCoordinateWithoutCommanding(t){if(this.canOnlySnapselectionBoxEntities(t)){let t=null;const e=this.systemConfig.snapSize/2/this.mouse.visualWorkerView.a,n=[[this.mouse.mouseX-e/2,this.mouse.mouseY-e/2],[this.mouse.mouseX+e/2,this.mouse.mouseY+e/2]];let i=this.dataManager.getEntityByAABB(n,!0);if(i=this.dataManager.selectionBoxEntities.filter((t=>i.includes(t))),0===i.length)return null;{const e=this.entitiesKeyNodeManager.getEntitiesKeyNodes(n,i);let r=null,s=Number.MAX_VALUE;const o=new PointCalculator([this.mouse.mouseX,this.mouse.mouseY]);let a=[];if(e.forEach((t=>{const e=o.getToPointDistance(t.coordinate);r?e<s?(s=e,r=t,a=[t]):this.computGeometry.numEqual(e,s)&&a.push(t):(s=e,r=t,a.push(t))})),this.closestKeyNodeArr=a,r){t=r.coordinate;const e=setTimeout((()=>{this.drawEndpoint(this.mouse.affineTransformPoint(t),"#26DA6F"),clearTimeout(e)}),0)}return t?this.mouse.affineTransformPoint(t):null}}return null}setOpenSnapType(t){this.openSnapType=t}snap(){let t=null;const e=this.systemConfig.snapSize/2/this.mouse.visualWorkerView.a,n=[[this.mouse.mouseX-e/2,this.mouse.mouseY-e/2],[this.mouse.mouseX+e/2,this.mouse.mouseY+e/2]],i=this.dataManager.getEntityByAABB(n,!0);if(0===i.length)return null;{const e=this.entitiesKeyNodeManager.getEntitiesKeyNodes(n,i,this.openSnapType);let r=null,s=Number.MAX_VALUE;const o=new PointCalculator([this.mouse.mouseX,this.mouse.mouseY]);if(e.forEach((t=>{const e=o.getToPointDistance(t.coordinate);r?e<s&&(s=e,r=t):r=t})),r)switch(t=r.coordinate,this.lastIntersectionShapeCoordinate=t?this.mouse.affineTransformPoint(t):null,r.keyNode){case 0:if(this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawEndpoint(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0)}break;case 1:if(this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawMidpoint(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0)}break;case 4:if(this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawQuadrant(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0)}break;case 9:if(this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawTangency(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0)}}else t=null;if(t)return t;if(1===i.length){let e=null;const r=new RectangleCalculator(n[0],n[1]);if(this.mouse.mouseRecords.length>=1){const s=new PointCalculator(this.mouse.mouseRecords[this.mouse.mouseRecords.length-1]);e=i.some((e=>e.shape.some((e=>{switch(e.type){case At.LINE:{const n=s.getSegmentPerpendicular(e.points[0],e.points[1]);if(n&&r.isPointInside(n)){if(t=n,this.lastIntersectionShapeCoordinate=t?this.mouse.affineTransformPoint(t):null,this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawPerpendicular(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0)}return!0}break}case At.MTEXT:if(e.points){if(t=e.points[0],this.lastIntersectionShapeCoordinate=t?this.mouse.affineTransformPoint(t):null,this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawInsertionPoint(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0)}return!0}break;case At.CIRCLE:{const i=s.getCircleTangency(e.points[0],e.r);return null==i?void 0:i.some((e=>{if(new RectangleCalculator(n[0],n[1]).isPointInside(e)){if(t=e,this.lastIntersectionShapeCoordinate=t?this.mouse.affineTransformPoint(t):null,this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawTangency(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0)}return!0}}))}}}))))}if(e)return t;{const e=new PointCalculator([this.mouse.mouseX,this.mouse.mouseY]);return i.some((n=>n.shape.some((n=>{switch(n.type){case At.LINE:if(t=e.getSegmentClosest(n.points[0],n.points[1]),this.lastIntersectionShapeCoordinate=t?this.mouse.affineTransformPoint(t):null,this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawClosest(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0);return!0}break;case At.MTEXT:break;case At.CIRCLE:if(t=e.getCircleClosest(n.points[0],n.r),this.lastIntersectionShapeCoordinate=t?this.mouse.affineTransformPoint(t):null,this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawClosest(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0);return!0}break;case At.ARC:if(t=e.getArcClosest(n.points[0],n.r,n.startAngle,n.endAngle,n.anticlockwise),this.lastIntersectionShapeCoordinate=t?this.mouse.affineTransformPoint(t):null,this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawClosest(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0);return!0}}})))),t}}if(t=this.getEntityArrIntersection(i),this.lastIntersectionShapeCoordinate=t?this.mouse.affineTransformPoint(t):null,this.lastIntersectionShapeCoordinate){const e=setTimeout((()=>{this.drawIntersection(this.lastIntersectionShapeCoordinate),clearTimeout(e)}),0);return t}{const e=[],n=new PointCalculator([this.mouse.mouseX,this.mouse.mouseY]);i.forEach((t=>t.shape.forEach((t=>{switch(t.type){case At.LINE:e.push(n.getSegmentClosestPointAndDistance(t.points[0],t.points[1]));case At.MTEXT:}}))));let r=null;if(e.forEach((t=>{r?t.distance<r.distance&&(r=t):r=t})),t=r?r.point:null,this.lastIntersectionShapeCoordinate=t?this.mouse.affineTransformPoint(t):null,this.lastIntersectionShapeCoordinate){const t=setTimeout((()=>{this.drawClosest(this.lastIntersectionShapeCoordinate),clearTimeout(t)}),0)}return t}}}getEntityArrIntersection(t){let e=null;return t.some(((n,i)=>{const r=t.slice(i+1);return n.shape.some((t=>{switch(t.type){case At.LINE:{const n=new LineCalculator(t.points[0],t.points[1]);return r.some((t=>t.shape.some((t=>{switch(t.type){case At.LINE:{const i=n.getIntersectSegment(t.points[0],t.points[1]);if(i)return e=i,!0;break}case At.MTEXT:}}))))}case At.MTEXT:}}))})),e}drawEndpoint(t,e="#F2D378"){this.interactionVisual.drawEndpoint(t,e)}drawMidpoint(t){this.interactionVisual.drawMidpoint(t)}drawPerpendicular(t){this.interactionVisual.drawPerpendicular(t)}drawInsertionPoint(t){this.interactionVisual.drawInsertionPoint(t)}drawTangency(t){this.interactionVisual.drawTangency(t)}drawQuadrant(t){this.interactionVisual.drawQuadrant(t)}drawClosest(t){this.interactionVisual.drawClosest(t)}drawIntersection(t){this.interactionVisual.drawIntersection(t)}};__decorateClass$a([it(Wt)],Le.prototype,"systemConfig",2),__decorateClass$a([it(It)],Le.prototype,"dataManager",2),__decorateClass$a([it(xe)],Le.prototype,"entitiesKeyNodeManager",2),__decorateClass$a([it(Lt)],Le.prototype,"mouse",2),__decorateClass$a([it(Ee)],Le.prototype,"computGeometry",2),__decorateClass$a([it(Ht)],Le.prototype,"interactionVisual",2),Le=__decorateClass$a([injectable()],Le);var Oe=Object.defineProperty,Be=Object.getOwnPropertyDescriptor,__decorateClass$9=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Be(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Oe(e,n,s),s};let KEYNODESDRAG=class extends oe{constructor(){super(...arguments),__publicField(this,"mouse"),__publicField(this,"description","拖拽关键节点"),__publicField(this,"currentCommandStateStr",""),__publicField(this,"interactionDataArr",[]),__publicField(this,"queue",new MessageQueue(new ExecuteLatestStrategy)),__publicField(this,"addTask",(()=>{this.queue.addTask(this.drawInteractionShape)})),__publicField(this,"keyNodeInfo",[]),__publicField(this,"rule",{action:t=>{if(this.dataManager.selectionBoxEntities.length<=0)return{data:{event:"CommandSelect"},commandStatusWorkflowType:se.Over};this.currentCommandStateStr="",this.interactionDataArr=[],this.mouse.addEventListener(xt,this.addTask),this.mouse.addEventListener(Mt,this.addTask),this.keyNodeInfo=t,this.interactionDataArr[0]={commandStateStr:"POINT1",data:{point:this.mouse.mouseRecords[this.mouse.mouseRecords.length-1]||[0,0]}}},msg:"移动",next:["POINT2"],subCommand:{POINT2:{action:t=>(this.currentCommandStateStr="POINT2",this.setFinalPoint(t)),msg:"指定第二个点",next:[]}}}),__publicField(this,"drawInteractionShape",(()=>{if(this.interactionDataArr[0]){const t=[],e={type:At.LINE,shape:[{type:At.LINE,points:[this.interactionDataArr[0].data.point,[this.mouse.mouseX,this.mouse.mouseY]]}]};t.push(e),t.push(...this.getNewEntitiesByVector()),this.clearInteractionShape(),this.guide.render(t).then((()=>{this.isRunning||this.clearInteractionShape()}))}}))}setFinalPoint(t){const e=this.dataManager.selectionBoxEntities.length;if(e>0){if(isNumArray(t))this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:t}};else{if(!isNumeric(t))return console.log("请选择坐标点"),{commandStatusWorkflowType:se.Rretry};{this.interactionDataArr[1]={commandStateStr:"POINT2",data:{point:[0,0]}};const e=this.interactionDataArr[0].data.point,n=this.movePoint(e,[this.mouse.mouseX-e[0],this.mouse.mouseY-e[1]],Number(t));this.interactionDataArr[1].data.point=n}}this.shapeEdit(this.getNewEntitiesByVector()),console.info(`移动了${e}个对象`)}}movePoint(t,e,n){const[i,r]=t,[s,o]=e,a=Math.sqrt(s*s+o*o),c=[s/a,o/a];return[i+n*c[0],r+n*c[1]]}getNewEntitiesByVector(){if(this.interactionDataArr[0]){const t=[this.mouse.mouseX-this.interactionDataArr[0].data.point[0],this.mouse.mouseY-this.interactionDataArr[0].data.point[1]];return this.keyNodeInfo.map((e=>{var n,i,r,s,o,a,c,h,u;const d=deepCopy(e.entity);switch(d.shape[e.shapeIndex].type){case At.LINE:switch(e.keyNode){case De.Endpoint:switch(e.pointIndex){case 0:case 1:{const i=null==(n=d.shape[e.shapeIndex].points)?void 0:n[e.pointIndex];i&&(i[0]=i[0]+t[0],i[1]=i[1]+t[1]);break}}(null==(i=d.other)?void 0:i.boxSelected)&&(d.other.boxSelected=!1);break;case De.Midpoint:d.shape.forEach((e=>{var n;null==(n=e.points)||n.forEach((e=>{e.forEach(((n,i)=>{t[i]&&(e[i]=n+t[i])}))}))})),(null==(r=d.other)?void 0:r.boxSelected)&&(d.other.boxSelected=!1)}break;case At.MTEXT:if(e.keyNode===De.Endpoint){switch(e.pointIndex){case 0:case 1:case 2:case 3:{const n=null==(s=d.shape[e.shapeIndex].points)?void 0:s[e.pointIndex];n&&(n[0]=n[0]+t[0],n[1]=n[1]+t[1]);break}}(null==(o=d.other)?void 0:o.boxSelected)&&(d.other.boxSelected=!1)}break;case At.CIRCLE:switch(e.keyNode){case De.Center:{const n=null==(a=d.shape[e.shapeIndex].points)?void 0:a[0];n&&(n[0]=n[0]+t[0],n[1]=n[1]+t[1]),(null==(c=d.other)?void 0:c.boxSelected)&&(d.other.boxSelected=!1);break}case De.Quadrant:{const t=null==(h=d.shape[e.shapeIndex].points)?void 0:h[0],n=new PointCalculator(t).getToPointDistance([this.mouse.mouseX,this.mouse.mouseY]);d.shape[e.shapeIndex].r=n,(null==(u=d.other)?void 0:u.boxSelected)&&(d.other.boxSelected=!1)}}break;case At.ARC:switch(e.keyNode){case De.Center:case De.Midpoint:case De.Endpoint:}}return d}))}return[]}clearInteractionShape(){this.guide.clearAll()}dispose(){this.clearInteractionShape(),this.mouse.removeEventListener(xt,this.addTask),this.mouse.removeEventListener(Mt,this.addTask)}};__decorateClass$9([it(Lt)],KEYNODESDRAG.prototype,"mouse",2),KEYNODESDRAG=__decorateClass$9([injectable()],KEYNODESDRAG);class ESCAPE extends oe{constructor(){super(...arguments),__publicField(this,"rule",{action:()=>{console.log("取消")},msg:"取消",next:[],subCommand:{}})}dispose(){}}var Re=(t=>(t.allLocalData="allLocalData",t))(Re||{});class SAVEDATALOCAL extends oe{constructor(){super(...arguments),__publicField(this,"rule",{action:()=>{localStorage.setItem("allLocalData",JSON.stringify(this.dataManager.all()))},msg:"保存数据到本地",next:[],subCommand:{}})}dispose(){}}class READDATALOCAL extends oe{constructor(){super(...arguments),__publicField(this,"rule",{action:()=>{try{const t=localStorage.getItem(Re.allLocalData)||JSON.stringify([{type:"LINE",shape:[{type:"LINE",points:[[560.7685990200619,282.626456730535],[623.529322688868,243.0739120587179]]}],id:"87-4-182-255",AABB:[[559.6435990200619,241.9489120587179],[624.654322688868,283.751456730535]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[556.8750000000001,247.5],[594.0894538679736,306.5507153224364]]}],id:"26-149-19-255",AABB:[[555.7500000000001,246.375],[595.2144538679736,307.6757153224364]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[567.0118332081142,250.30362509391432],[604.2262870760877,309.35434041635074]]}],id:"61-121-108-255",AABB:[[565.8868332081142,249.17862509391432],[605.3512870760877,310.47934041635074]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[573.7736664162285,252.83931254695716],[610.988120284202,311.8900278693936]]}],id:"9-253-235-255",AABB:[[572.6486664162285,251.71431254695716],[612.113120284202,313.0150278693936]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!0,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[561.9404583020287,248.61316679188576],[599.1549121700021,307.6638821143222]]}],id:"50-124-63-255",AABB:[[560.8154583020287,247.48816679188576],[600.2799121700021,308.7888821143222]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[548.935390905862,278.4003109754636],[611.6961145746682,238.8477663036465]]}],id:"46-31-226-255",AABB:[[547.810390905862,237.7227663036465],[612.8211145746682,279.5253109754636]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[543.8699326038334,277.2871441835778],[606.6306562726396,237.73459951176073]]}],id:"145-5-252-255",AABB:[[542.7449326038334,236.60959951176073],[607.7556562726396,278.4121441835778]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[542.1613720860751,253.10109906931677],[604.9220957548813,213.54855439749974]]}],id:"80-58-236-255",AABB:[[541.0363720860751,212.42355439749974],[606.0470957548813,254.22609906931677]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[554.0067658119476,280.09076927749214],[616.7674894807537,240.53822460567505]]}],id:"96-73-174-255",AABB:[[552.8817658119476,239.41322460567505],[617.8924894807537,281.21576927749214]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[736.5095676218144,232.78493852575943],[699.2951137538411,173.7342232033231]]}],id:"116-218-93-255",AABB:[[698.1701137538411,172.6092232033231],[737.6345676218144,233.90993852575943]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[610.9881202842018,311.8900278693936],[736.5095676218144,232.78493852575943]]}],id:"130-75-239-255",AABB:[[609.8631202842018,231.65993852575943],[737.6345676218144,313.0150278693936]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[724.6763595076146,228.55879277068803],[687.4619056396413,169.5080774482517]]}],id:"31-202-3-255",AABB:[[686.3369056396413,168.3830774482517],[725.8013595076146,229.68379277068803]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[719.6109012055861,227.44562597880227],[682.3964473376127,168.39491065636594]]}],id:"48-42-128-255",AABB:[[681.2714473376127,167.26991065636594],[720.7359012055861,228.57062597880227]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[729.7477344137002,230.2492510727166],[692.5332805457268,171.19853575028026]]}],id:"235-66-172-255",AABB:[[691.4082805457268,170.07353575028026],[730.8727344137002,231.3742510727166]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[594.0894538679735,306.5507153224364],[719.6109012055861,227.44562597880227]]}],id:"199-62-105-255",AABB:[[592.9644538679735,226.32062597880227],[720.7359012055861,307.6757153224364]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[599.154912170002,307.6638821143222],[724.6763595076146,228.55879277068803]]}],id:"41-216-53-255",AABB:[[598.029912170002,227.43379277068803],[725.8013595076146,308.7888821143222]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[604.2262870760876,309.35434041635074],[729.7477344137002,230.2492510727166]]}],id:"21-38-82-255",AABB:[[603.1012870760876,229.1242510727166],[730.8727344137002,310.47934041635074]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[611.6961145746682,238.8477663036465],[593.0888876406815,209.32240864242834]]}],id:"145-189-176-255",AABB:[[591.9638876406815,208.19740864242834],[612.8211145746682,239.9727663036465]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[623.529322688868,243.0739120587179],[604.9220957548813,213.54855439749974]]}],id:"134-121-231-255",AABB:[[603.7970957548813,212.42355439749974],[624.654322688868,244.1989120587179]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!0,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[616.7674894807537,240.53822460567505],[598.1602625467671,211.0128669444569]]}],id:"145-185-172-255",AABB:[[597.0352625467671,209.8878669444569],[617.8924894807537,241.66322460567505]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[535.3995388779608,250.56541161627393],[554.0067658119476,280.09076927749214]]}],id:"140-186-10-255",AABB:[[534.2745388779608,249.44041161627393],[555.1317658119476,281.21576927749214]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[542.1613720860751,253.10109906931677],[560.7685990200619,282.626456730535]]}],id:"227-108-246-255",AABB:[[541.0363720860751,251.97609906931677],[561.8935990200619,283.751456730535]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[525.2627056698468,247.7617865223596],[543.8699326038335,277.2871441835778]]}],id:"95-185-235-255",AABB:[[524.1377056698468,246.6367865223596],[544.9949326038335,278.4121441835778]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[530.3281639718753,248.87495331424537],[548.935390905862,278.4003109754636]]}],id:"168-162-63-255",AABB:[[529.2031639718753,247.74995331424537],[550.060390905862,279.5253109754636]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[606.6306562726396,237.73459951176073],[588.0234293386529,208.20924185054258]]}],id:"178-213-146-255",AABB:[[586.8984293386529,207.08424185054258],[607.7556562726396,238.85959951176073]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[556.8750000000001,247.50000000000003],[682.3964473376127,168.39491065636594]]}],id:"56-72-149-255",AABB:[[555.7500000000001,167.26991065636594],[683.5214473376127,248.62500000000003]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[561.9404583020287,248.6131667918858],[687.4619056396413,169.5080774482517]]}],id:"62-25-200-255",AABB:[[560.8154583020287,168.3830774482517],[688.5869056396413,249.7381667918858]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[567.0118332081142,250.30362509391435],[692.5332805457268,171.19853575028026]]}],id:"57-167-33-255",AABB:[[565.8868332081142,170.07353575028026],[693.6582805457268,251.42862509391435]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[573.7736664162285,252.8393125469572],[699.2951137538411,173.7342232033231]]}],id:"116-222-73-255",AABB:[[572.6486664162285,172.6092232033231],[700.4201137538411,253.9643125469572]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"CIRCLE",shape:[{type:"CIRCLE",points:[[573.7736664162284,252.83931254695716]],r:49.42323593209979}],id:"97-47-118-255",AABB:[[523.2254304841285,202.29107661485736],[624.3219023483282,303.38754847905693]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{boxSelected:!1,collisioned:!1}},{type:"LINE",shape:[{type:"LINE",points:[[525.2627056698468,247.7617865223596],[588.0234293386529,208.20924185054258]]}],id:"131-34-239-255",AABB:[[524.1377056698468,207.08424185054258],[589.1484293386529,248.8867865223596]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[530.3281639718753,248.87495331424537],[593.0888876406815,209.32240864242834]]}],id:"54-96-3-255",AABB:[[529.2031639718753,208.19740864242834],[594.2138876406815,249.99995331424537]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"LINE",shape:[{type:"LINE",points:[[535.3995388779608,250.56541161627393],[598.1602625467671,211.0128669444569]]}],id:"78-49-246-255",AABB:[[534.2745388779608,209.8878669444569],[599.2852625467671,251.69041161627393]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{collisioned:!1,boxSelected:!1}},{type:"CIRCLE",shape:[{type:"CIRCLE",points:[[561.9404583020286,248.61316679188576]],r:49.42323593209979}],id:"111-221-178-255",AABB:[[511.39222236992873,198.06493085978596],[612.4886942341284,299.16140272398553]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{boxSelected:!1,collisioned:!1}},{type:"CIRCLE",shape:[{type:"CIRCLE",points:[[556.875,247.5]],r:49.42323593209979}],id:"4-156-3-255",AABB:[[506.3267640679002,196.9517640679002],[607.4232359320998,298.0482359320998]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{boxSelected:!1,collisioned:!1}},{type:"CIRCLE",shape:[{type:"CIRCLE",points:[[567.0118332081141,250.30362509391432]],r:49.42323593209979}],id:"85-88-177-255",AABB:[[516.4635972760143,199.75538916181452],[617.560069140214,300.8518610260141]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]},other:{boxSelected:!1,collisioned:!1}},{type:"ARC",shape:[{type:"ARC",points:[[561.6099986429685,252.2451492409711]],r:60.111134818181654,startAngle:2.820336956647173,endAngle:1.298768669427688,anticlockwise:!0}],id:"19-15-139-255",AABB:[[503.44916934564856,270.1007368371596],[578.8859639622995,313.48128405915276]],layer:{id:"7b1764",status:!0,name:"",on:!0,frozen:!1,locked:!1,color:"#fff",lineType:"",lineWeight:0,printStyle:"#fff",print:!0,description:"",entityList:[]}}]);if(t){const e=JSON.parse(t);this.shapeCreated(e)}}catch(t){console.error(t)}},msg:"读取本地数据",next:[],subCommand:{}})}dispose(){}}var _e=Object.defineProperty,ke=Object.getOwnPropertyDescriptor,__decorateClass$8=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?ke(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&_e(e,n,s),s};let We=class{constructor(){__publicField(this,"ctx"),__publicField(this,"envConfig"),__publicField(this,"dataManager"),__publicField(this,"mouse"),__publicField(this,"rtreeVisualShow",!0)}init(){this.ctxInit(),this.eventListenserInit()}ctxInit(){const t=function createTransparentCanvas(){const t=document.createElement("canvas");t.id=st.RTreeVisual,t.style.width="100%",t.style.height="100%",t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.cursor="none",t.style.backgroundColor="transparent",t.style.zIndex="1";const e=document.getElementById(st.DataVisual);if(e){const n=e.parentNode;n?n.appendChild(t):console.error(".canvas-container not found!")}else console.error("visual not found!");return t}(),e=Math.ceil(t.offsetWidth*this.envConfig.dpr),n=Math.ceil(t.offsetHeight*this.envConfig.dpr);this.ctx=t.getContext("2d"),this.ctx.canvas.width=e,this.ctx.canvas.height=n,this.ctx.strokeStyle="#f00",this.ctx.lineWidth=1*this.envConfig.dpr/this.mouse.visualWorkerView.a,this.ctx.save()}eventListenserInit(){this.mouse.addEventListener(Mt,(t=>{this.clearAll();const{a:e,b:n,c:i,d:r,e:s,f:o}=this.mouse.visualWorkerView;this.updateView(e,n,i,r,s,o,!0),this.updateRtreeVisual()})),this.dataManager.addEventListener(bt,(()=>{this.updateRtreeVisual()})),this.dataManager.addEventListener(Ct,(()=>{this.updateRtreeVisual()})),this.dataManager.addEventListener(wt,(()=>{this.updateRtreeVisual()}))}updateRtreeVisual(){this.clearAll(),this.rtreeVisualShow&&this.drawRTreeNode(this.dataManager.toJSON())}drawRTreeNode(t){if(this.draw([[t.minX,t.minY],[t.maxX,t.maxY]]),!t.leaf)for(let e=0;e<t.children.length;e++)this.drawRTreeNode(t.children[e])}clearAll(){const{a:t,d:e,e:n,f:i}=this.mouse.visualWorkerView;this.ctx.clearRect((0-n)/t,(0-i)/e,this.ctx.canvas.width/t,this.ctx.canvas.height/e)}draw(t){const[e,n]=t[0],[i,r]=t[1];this.ctx.strokeStyle=this.getRandomColor(),this.ctx.lineWidth=1*this.envConfig.dpr/this.mouse.visualWorkerView.a,this.ctx.strokeRect(e,n,i-e,r-n)}updateView(t,e,n,i,r,s,o=!1){o?this.ctx.setTransform(t,e,n,i,r,s):this.ctx.transform(t,e,n,i,r,s)}getRandomColor(){const t=Math.floor(256*Math.random()),e=Math.floor(256*Math.random()),n=Math.floor(256*Math.random());return"#"+t.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")+n.toString(16).padStart(2,"0")}};__decorateClass$8([it(dt)],We.prototype,"envConfig",2),__decorateClass$8([it(It)],We.prototype,"dataManager",2),__decorateClass$8([it(Lt)],We.prototype,"mouse",2),We=__decorateClass$8([injectable()],We);var je=Object.defineProperty,Ve=Object.getOwnPropertyDescriptor,__decorateClass$7=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Ve(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&je(e,n,s),s};let RTV=class extends oe{constructor(){super(...arguments),__publicField(this,"rtreeVisual"),__publicField(this,"rule",{action:()=>{this.rtreeVisual.rtreeVisualShow=!this.rtreeVisual.rtreeVisualShow,this.rtreeVisual.updateRtreeVisual()},msg:"展示/隐藏Rtree可视化视图",next:[],subCommand:{}})}dispose(){}};__decorateClass$7([it(We)],RTV.prototype,"rtreeVisual",2),RTV=__decorateClass$7([injectable()],RTV);var qe=Object.getOwnPropertyDescriptor;let Xe=class{constructor(t,e=10){__publicField(this,"commandsArr",[LINE,ERASE,MOVE,COPY,RECTANGLE,CIRCLE,ARC,PLINE,HELP,MTEXT,SELECTIONBOXALL,KEYNODESDRAG,ESCAPE,SAVEDATALOCAL,READDATALOCAL,RTV]),__publicField(this,"commandsMap",{}),__publicField(this,"commandCache"),__publicField(this,"iocContainer"),this.iocContainer=t,this.commandCache=new LRUCache(e),this.registerCommands()}registerCommands(){this.commandsArr.forEach((t=>{this.iocContainer.bind(t).toSelf(),this.commandsMap[t.name]=t}))}getCommand(t){let e=this.commandCache.get(t);if(e)return e;{const n=this.commandsMap[t];return n?(e=this.iocContainer.get(n),n&&e?(this.commandCache.put(t,e),e):e):(console.warn("没有找到有效指令！"),null)}}getAllCommands(){const t={};return this.commandsArr.forEach((e=>{t[e.name.toUpperCase()]=e.name.toUpperCase()})),t}};Xe=((t,e,n,i)=>{for(var r,s=i>1?void 0:i?qe(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=r(s)||s);return s})([injectable()],Xe);class Tween{constructor(t){__publicField(this,"startTime"),__publicField(this,"duration"),__publicField(this,"easingFunction"),__publicField(this,"onUpdateCallback"),__publicField(this,"startObject"),__publicField(this,"endObject"),this.startTime=0,this.duration=0,this.easingFunction=t=>t,this.onUpdateCallback=null,this.startObject=t,this.endObject={}}to(t,e){return this.endObject=t,this.duration=e,this}easing(t){return this.easingFunction=t,this}onUpdate(t){return this.onUpdateCallback=t,this}start(){this.startTime=performance.now(),this.update()}update(){const t=performance.now()-this.startTime,e=Math.min(t/this.duration,1),n=this.easingFunction(e),i={};for(const r in this.startObject)if(this.startObject.hasOwnProperty(r)&&this.endObject.hasOwnProperty(r)){const t=this.startObject[r],e=this.endObject[r],s=this.interpolate(t,e,n);i[r]=s}this.onUpdateCallback&&this.onUpdateCallback(i),e<1&&requestAnimationFrame((()=>{this.update()}))}interpolate(t,e,n){return t+(e-t)*n}}__publicField(Tween,"Linear",{None:t=>t}),__publicField(Tween,"Quadratic",{In:t=>t*t,Out:t=>t*(2-t),InOut:t=>t<.5?2*t*t:(4-2*t)*t-1}),__publicField(Tween,"Cubic",{In:t=>t*t*t,Out:t=>--t*t*t+1,InOut:t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}),__publicField(Tween,"Elastic",{In:t=>-Math.pow(2,10*(t-1))*Math.sin((t-1.075)*(2*Math.PI)/.3),Out:t=>Math.pow(2,-10*t)*Math.sin((t-.075)*(2*Math.PI)/.3)+1,InOut:t=>(t/=.5)<1?-.5*Math.pow(2,10*(t-1))*Math.sin((t-1.075)*(2*Math.PI)/.3):.5*Math.pow(2,-10*(t-1))*Math.sin((t-1.075)*(2*Math.PI)/.3)+1});var Ye=Object.defineProperty,He=Object.getOwnPropertyDescriptor,__decorateClass$5=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?He(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Ye(e,n,s),s};let Fe=class{constructor(){__publicField(this,"systemConfig"),__publicField(this,"mouse"),__publicField(this,"dataManager"),__publicField(this,"commandHistoryManager")}cursorCollisionDetect(t,e){var n;const i=[],r=this.dataManager.collisionEntity;(null==r?void 0:r.other)&&(r.other.collisioned=!1,i.push(r));const s=this.systemConfig.squareLength/2/this.mouse.visualWorkerView.a,o=this.dataManager.cursorCollisionDetect([[t-s,e-s],[t+s,e+s]]);if(o){if((null==r?void 0:r.id)===o.id)return;if(null==(n=o.other)?void 0:n.boxSelected)return;o.other?o.other.boxSelected||(o.other.collisioned=!0):o.other={collisioned:!0},i.push(o)}i.length&&this.dataManager.editEntitiesData(i)}setSingleSelectionBox(t){const e=this.dataManager.collisionEntity;let n=[];t||(n=this.dataManager.selectionBoxEntities.map((t=>(t.other&&(t.other.boxSelected=!1),t)))),e.other?(e.other.collisioned=!1,e.other.boxSelected=!e.other.boxSelected):e.other={boxSelected:!0},n.push(e),n.length&&this.dataManager.editEntitiesData(n)}setSelectionBox(t,e,n){const i=this.dataManager.selectionBoxEntities;n||i.forEach((t=>{t.other&&(t.other.boxSelected=!1)}));let r=[];t=[t[0],t[1]],e=[e[0],e[1]];const s=[[Math.min(t[0],e[0]),Math.min(t[1],e[1])],[Math.max(t[0],e[0]),Math.max(t[1],e[1])]];t[0]>e[0]?(console.time("向左框选"),r=this.dataManager.getEntityByAABB(s,!0),console.timeEnd("向左框选")):(console.time("向右框选"),r=this.dataManager.getEntityByAABBAllIn(s),console.timeEnd("向右框选")),r.forEach((t=>{t.other?(t.other.collisioned=!1,t.other.boxSelected=!t.other.boxSelected):t.other={boxSelected:!0}}));const o=function arrRemoveDuplic(t){const e=new Map,n=[];for(let i=0;i<t.length;i++)e.has(t[i].id)?e.set(t[i].id,!0):(e.set(t[i].id,!1),n.push(t[i]));return n}([...i,...r]);o.length&&this.dataManager.editEntitiesData(o)}clearSelectionBox(){const t=this.dataManager.selectionBoxEntities;t.forEach((t=>{var e;(null==(e=t.other)?void 0:e.boxSelected)&&(t.other.boxSelected=!1)})),t.length&&this.dataManager.editEntitiesData(t)}zoomCenter(t,e){const{minX:n,minY:i,maxX:r,maxY:s}=this.getAllShapesRange(t,e),o=r-n,a=s-i;let c=1;c=o/a>t/e?t/o:e/a;const h={a:c,b:0,c:0,d:c,e:(t-o*c)/2-n*c,f:(e-a*c)/2-i*c};new Tween(this.mouse.visualWorkerView).to(h,1e3).easing(Tween.Quadratic.InOut).onUpdate((t=>{})).start(),this.mouse.setVisualWorkerView(h)}getAllShapesRange(t,e){let n=Number.MAX_VALUE,i=Number.MAX_VALUE,r=-Number.MAX_VALUE,s=-Number.MAX_VALUE;return this.dataManager.all().forEach((t=>{const e=t.AABB;n=Math.min(n,e[0][0]),i=Math.min(i,e[0][1]),r=Math.max(r,e[1][0]),s=Math.max(s,e[1][1])})),n===Number.MAX_VALUE&&(n=0),i===Number.MAX_VALUE&&(i=0),r===-Number.MAX_VALUE&&(r=t),s===-Number.MAX_VALUE&&(s=e),{minX:n,minY:i,maxX:r,maxY:s}}};__decorateClass$5([it(Wt)],Fe.prototype,"systemConfig",2),__decorateClass$5([it(Lt)],Fe.prototype,"mouse",2),__decorateClass$5([it(It)],Fe.prototype,"dataManager",2),__decorateClass$5([it(ee)],Fe.prototype,"commandHistoryManager",2),Fe=__decorateClass$5([injectable()],Fe);var Ke=Object.defineProperty,Ue=Object.getOwnPropertyDescriptor,__decorateClass$4=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Ue(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Ke(e,n,s),s};let ze=class extends ht{constructor(){super(),__publicField(this,"commandRegistry"),__publicField(this,"interactionCommand"),__publicField(this,"commandHistoryManager"),__publicField(this,"commandInstance",null),__publicField(this,"prevCurrentCommandStr","")}getAllCommands(){return this.commandRegistry.getAllCommands()}undo(){this.commandHistoryManager.undo()}redo(){this.commandHistoryManager.redo()}cursorCollisionDetect(t,e){this.interactionCommand.cursorCollisionDetect(t,e)}setSingleSelectionBox(t){this.interactionCommand.setSingleSelectionBox(t)}setSelectionBox(t,e,n){this.interactionCommand.setSelectionBox(t,e,n)}clearSelectionBox(){this.interactionCommand.clearSelectionBox()}zoomCenter(t,e){this.interactionCommand.zoomCenter(t,e)}run(t,e){if(console.log(35,t,e),(!this.commandInstance||this.commandInstance&&!this.commandInstance.isRunning)&&t){let n=t;if(" "===n&&(n=this.prevCurrentCommandStr),this.commandInstance=this.commandRegistry.getCommand(n),this.commandInstance){this.commandInstance.once(re.CommandStart,(t=>{this.dispatchEvent(re.CommandStart,t)})),this.commandInstance.once(re.CommandEnd,(t=>{var e;this.dispatchEvent(re.CommandEnd,t),null==(e=this.commandInstance)||e.removeEventListener(re.MateCommandEnd,mateCommandEndHandler)})),this.commandInstance.once(re.CommandError,(t=>{this.dispatchEvent(re.CommandError,t)}));const mateCommandEndHandler=t=>{this.dispatchEvent(re.MateCommandEnd,t)};this.commandInstance.addEventListener(re.MateCommandEnd,mateCommandEndHandler),this.commandInstance.run(null,e),"ESCAPE"!==n&&(this.prevCurrentCommandStr=n)}else this.dispatchEvent(re.CommandError),console.error("无效指令")}else this.commandInstance&&this.commandInstance.run(t,e)}};__decorateClass$4([it(Xe)],ze.prototype,"commandRegistry",2),__decorateClass$4([it(Fe)],ze.prototype,"interactionCommand",2),__decorateClass$4([it(ee)],ze.prototype,"commandHistoryManager",2),ze=__decorateClass$4([injectable()],ze);var Ge=Object.defineProperty,Qe=Object.getOwnPropertyDescriptor,__decorateClass$3=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Qe(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Ge(e,n,s),s};let $e=class{constructor(){__publicField(this,"shortcuts",{}),__publicField(this,"defaultShortcuts",{}),__publicField(this,"commandManager")}init(){this.defaultShortcuts=this.commandManager.getAllCommands(),this.shortcuts={...this.defaultShortcuts}}setShortcut(t,e){this.shortcuts[t]=e}removeShortcut(t){delete this.shortcuts[t]}getAllShortcut(){return this.shortcuts}};__decorateClass$3([it(ze)],$e.prototype,"commandManager",2),$e=__decorateClass$3([injectable()],$e);class StateManager{constructor(t){__publicField(this,"state"),__publicField(this,"listenerMap",new WeakMap),__publicField(this,"keyMap",new Map),this.state=t,Object.keys(t).forEach((t=>{const e={};this.keyMap.set(t,e),this.listenerMap.set(e,[])}))}getState(t){return this.state[t]}setData(t){const e={...this.state};for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){if(!(n in this.state)){console.warn(`StateManager: Trying to update undefined key: ${n}`);continue}this.state[n]=t[n]}this.emit(this.state,e)}emit(t,e){const n=new Map;this.keyMap.forEach(((i,r)=>{const s=this.listenerMap.get(i);if(s&&s.length>0){const i=t[r],o=e[r];s.forEach((t=>{n.has(t)||n.set(t,{newValues:[],oldValues:[]}),n.get(t).newValues.push(i),n.get(t).oldValues.push(o)}))}})),n.forEach((({newValues:t,oldValues:e},n)=>{n(t,e)}))}watch(t,e){return t.forEach((t=>{if(!this.keyMap.has(t)){const e={};this.keyMap.set(t,e),this.listenerMap.set(e,[])}const n=this.keyMap.get(t),i=this.listenerMap.get(n);i?i.push(e):this.listenerMap.set(n,[e])})),()=>{this.unwatch(t,e)}}unwatch(t,e){t.forEach((t=>{const n=this.keyMap.get(t);if(n){const i=this.listenerMap.get(n);if(i){const r=i.filter((t=>t!==e));r.length>0?this.listenerMap.set(n,r):(this.listenerMap.delete(n),this.keyMap.delete(t))}}}))}unwatchAll(){this.keyMap.forEach((t=>{this.listenerMap.delete(t)})),this.keyMap.clear()}}var Je=Object.defineProperty,Ze=Object.getOwnPropertyDescriptor,__decorateClass$2=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?Ze(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&Je(e,n,s),s};let tn=class{constructor(){__publicField(this,"envConfig"),__publicField(this,"systemConfig"),__publicField(this,"mouse"),__publicField(this,"dataManager"),__publicField(this,"interactionVisual"),__publicField(this,"keyboard"),__publicField(this,"shortcutManager"),__publicField(this,"commandManager"),__publicField(this,"domManager"),__publicField(this,"snap"),__publicField(this,"stateManager",new StateManager({commandInteractionState:"NONE"})),__publicField(this,"input",""),__publicField(this,"prevCommandInteractionState","NONE"),__publicField(this,"cursorState",Yt.CROSSWITHSQUARE),__publicField(this,"debounceCursorCollisionDetect"),__publicField(this,"lastMouseMovePosition",[0,0]),__publicField(this,"centerKeyDoubleMousedowning",!1)}init(){this.debounceCursorCollisionDetect=function debounce(t,e){let n=null;return function(...i){null!==n&&clearTimeout(n),n=setTimeout((()=>{t(...i),n=null}),e)}}(this.commandManager.cursorCollisionDetect.bind(this.commandManager),this.systemConfig.detectTime),this.mouseInit(),this.keyboardInit(),this.watchInit(),this.shortcutManagerInit(),this.commandManagerListenerInit(),this.snap.init(),this.interactionVisual.init(),this.commandManager.run("READDATALOCAL")}getSnapPoint(){return this.snap.getSnapBaseCoordinate(this.cursorState)}shortcutManagerInit(){this.shortcutManager.init(),this.shortcutManager.setShortcut("L","LINE"),this.shortcutManager.setShortcut("C","CIRCLE"),this.shortcutManager.setShortcut("AS","MOVE"),this.shortcutManager.setShortcut("REC","RECTANGLE"),this.shortcutManager.setShortcut("M","MOVE"),this.shortcutManager.setShortcut("CC","COPY"),this.shortcutManager.setShortcut("DEL","ERASE"),this.shortcutManager.setShortcut("DELETE","ERASE"),this.shortcutManager.setShortcut("MT","MTEXT")}watchInit(){this.stateManager.watch(["commandInteractionState"],(([t],[e])=>{this.prevCommandInteractionState=e,console.log(73,`commandInteractionState changed from: ${e} to: ${t}`),this.cursorState=this.getCursorState(),this.interactionVisual.clearAllShapes(),this.interactionVisual.drawCursor(this.cursorState,[this.mouse.baseMouseX,this.mouse.baseMouseY])}))}mouseInit(){const t=this.domManager.interactionCanvas.getBoundingClientRect();this.domManager.interactionCanvas.addEventListener("mousedown",(e=>{switch(this.interactionVisual.clearCursorAndSelectRect(this.cursorState,[this.mouse.baseMousedownX,this.mouse.baseMousedownY],[this.mouse.baseMouseX,this.mouse.baseMouseY]),e.button){case 0:{this.mouse.setBaseMousedown([(e.clientX-t.left)*this.envConfig.dpr,(e.clientY-t.top)*this.envConfig.dpr]);const n=[...this.mouse.baseMouseRecords];n.push([this.mouse.baseMousedownX,this.mouse.baseMousedownY]),this.mouse.setBaseMouseRecords(n);break}case 1:if(e.preventDefault(),this.centerKeyDoubleMousedowning)this.centerKeyDoubleMousedowning=!1,this.commandManager.zoomCenter(Math.ceil(this.domManager.interactionCanvas.width),Math.ceil(this.domManager.interactionCanvas.height));else{this.centerKeyDoubleMousedowning=!0;const t=setTimeout((()=>{this.centerKeyDoubleMousedowning=!1,clearTimeout(t)}),400)}break;case 2:e.preventDefault()}let n=!1;const i=this.getSnapPoint();if(i){this.mouse.setBaseMousedown(i);const t=[...this.mouse.baseMouseRecords];t[t.length-1]=i,this.mouse.setBaseMouseRecords(t),"NONE"===this.stateManager.getState("commandInteractionState")&&(this.commandManager.run("KEYNODESDRAG",this.snap.getClosestKeyNodeArr()),n=!0)}this.cursorState=this.getCursorState(),this.interactionVisual.drawCursor(this.cursorState,[this.mouse.baseMouseX,this.mouse.baseMouseY]),1===e.button&&this.stateManager.setData({commandInteractionState:"DRAGGING"}),this.cursorState===Yt.NONE?1===this.mouse.mouseRecords.length&&this.dataManager.collisionEntity?(this.commandManager.setSingleSelectionBox(this.keyboard.isKeyPressed("SHIFT")),this.selectCompleteKeyDataReset()):this.mouse.mouseRecords.length>=2&&(this.commandManager.setSelectionBox(this.mouse.mouseRecords[0],this.mouse.mouseRecords[1],this.keyboard.isKeyPressed("SHIFT")),this.selectCompleteKeyDataReset()):this.cursorState===Yt.CROSS&&(n||this.commandManager.run(null,[this.mouse.mouseX,this.mouse.mouseY]))})),this.domManager.interactionCanvas.addEventListener("mousemove",(e=>{this.lastMouseMovePosition=[this.mouse.baseMouseX,this.mouse.baseMouseY],this.interactionVisual.clearCursorAndSelectRect(this.cursorState,[this.mouse.baseMousedownX,this.mouse.baseMousedownY],[this.mouse.baseMouseX,this.mouse.baseMouseY]),this.mouse.setBaseMouse([(e.clientX-t.left)*this.envConfig.dpr,(e.clientY-t.top)*this.envConfig.dpr]);const n=this.getSnapPoint();switch(n&&this.mouse.setBaseMouse(n),this.interactionVisual.drawCursor(this.cursorState,[this.mouse.baseMouseX,this.mouse.baseMouseY]),"DRAGGING"===this.stateManager.getState("commandInteractionState")&&this.centerMouseCoordinateUpdate(this.mouse.baseMouseX,this.mouse.baseMouseY,this.lastMouseMovePosition[0],this.lastMouseMovePosition[1]),this.cursorState){case Yt.CROSSWITHSQUARE:case Yt.SQUARE:0===this.mouse.mouseRecords.length&&this.debounceCursorCollisionDetect(this.mouse.mouseX,this.mouse.mouseY);break;case Yt.NONE:this.interactionVisual.drawSelectRect([this.mouse.baseMousedownX,this.mouse.baseMousedownY],[this.mouse.baseMouseX,this.mouse.baseMouseY])}})),this.domManager.interactionCanvas.addEventListener("mouseup",(e=>{switch(this.interactionVisual.clearCursorAndSelectRect(this.cursorState,[this.mouse.baseMousedownX,this.mouse.baseMousedownY],[this.mouse.baseMouseX,this.mouse.baseMouseY]),e.button){case 0:this.mouse.setBaseMouseup([(e.clientX-t.left)*this.envConfig.dpr,(e.clientY-t.top)*this.envConfig.dpr]);break;case 1:e.preventDefault(),this.stateManager.setData({commandInteractionState:this.prevCommandInteractionState});break;case 2:e.preventDefault()}const n=this.getSnapPoint();n&&this.mouse.setBaseMouseup(n),this.interactionVisual.drawCursor(this.cursorState,[this.mouse.baseMouseX,this.mouse.baseMouseY])})),this.domManager.interactionCanvas.addEventListener("contextmenu",(t=>{t.preventDefault()})),this.domManager.interactionCanvas.addEventListener("wheel",(t=>{t.preventDefault(),this.mouse.setWheelDeltaY(t.deltaY),this.wheelDeltaYUpdate(this.mouse.wheelDeltaY)}))}commandManagerListenerInit(){this.commandManager.addEventListener(re.CommandStart,(t=>{console.info("执行MyCommandEvent.CommandStart",t),this.stateManager.setData({commandInteractionState:"COMMANDING"})})),this.commandManager.addEventListener(re.CommandEnd,(t=>{var e,n,i;console.info("执行MyCommandEvent.CommandEnd",t),this.stateManager.setData({commandInteractionState:"NONE"}),"CommandSelect"===(null==(e=null==t?void 0:t.data)?void 0:e.event)&&this.stateManager.setData({commandInteractionState:"SELECT"}),"SELECTIONBOXALL"!==(null==(i=null==(n=null==t?void 0:t.command)?void 0:n.constructor)?void 0:i.name)&&this.commandManager.clearSelectionBox(),this.keyDataReset()})),this.commandManager.addEventListener(re.CommandError,(t=>{console.info("执行MyCommandEvent.CommandError",t),this.stateManager.setData({commandInteractionState:"NONE"}),this.keyDataReset()})),this.commandManager.addEventListener(re.MateCommandEnd,(t=>{var e;console.info("执行MyCommandEvent.MateCommandEnd",t),this.input="","CommandSelect"===(null==(e=null==t?void 0:t.data)?void 0:e.event)&&this.stateManager.setData({commandInteractionState:"SELECT"})}))}keyboardInit(){this.keyboard.addEventListener(Bt,(t=>{const e=this.keyboard.getPressedKeys().join("+");switch(console.log(150,e),e){case"CONTROL+A":this.commandManager.run("SELECTIONBOXALL");break;case"CONTROL+S":this.commandManager.run("SAVEDATALOCAL");break;case"CONTROL+Z":this.commandManager.undo();break;case"CONTROL+Y":this.commandManager.redo();break;case"ESCAPE":case"ESC":this.commandManager.run("ESCAPE");break;case"BACKSPACE":this.input=this.input.slice(0,-1);break;case"DELETE":this.commandManager.run("ERASE");break;default:switch(t){case" ":case"ENTER":if("COMMANDING"===this.stateManager.getState("commandInteractionState")){let t=this.input;isNumArray(t)?this.commandManager.run(null,t):isNumeric(t)?(t=Number(t),this.commandManager.run(null,t)):this.commandManager.run(t)}else{const t=this.shortcutManager.getAllShortcut()[this.input]||" ";this.commandManager.run(t)}break;default:1===t.length&&/^[0-9a-zA-Z]+$/.test(t)&&(this.input=this.input+t.toUpperCase())}}}))}getCursorState(){const t=this.stateManager.getState("commandInteractionState");return"NONE"!==t&&"SELECT"!==t||!this.mouse.baseMouseRecords.length?"NONE"===t?Yt.CROSSWITHSQUARE:"SELECT"===t?Yt.SQUARE:"COMMANDING"===t?Yt.CROSS:"DRAGGING"===t?Yt.DRAGGING:Yt.CROSSWITHSQUARE:Yt.NONE}centerMouseCoordinateUpdate(t,e,n,i){const r=(t-n)/this.mouse.visualWorkerView.a,s=(e-i)/this.mouse.visualWorkerView.d;this.setVisualWorkerView(1,0,0,1,r,s)}wheelDeltaYUpdate(t){if(0!==t){let e=1;if(t>0){if(this.mouse.visualWorkerView.a<=.02&&this.mouse.visualWorkerView.d<=.02)return;e=.9}else t<0&&(e=1.1);const n=e,i=0,r=0,s=e,o=this.mouse.mouseX*(1-e),a=this.mouse.mouseY*(1-e);this.setVisualWorkerView(n,i,r,s,o,a)}}setVisualWorkerView(t,e,n,i,r,s){this.mouse.setVisualWorkerView(this.mouse.getAbsoluteTransformFromRelative(this.mouse.visualWorkerView,{a:t,b:e,c:n,d:i,e:r,f:s}))}selectCompleteKeyDataReset(){this.interactionVisual.clearAllShapes(),this.mouse.setBaseMouseRecords([]),this.cursorState=this.getCursorState(),this.input="",this.interactionVisual.drawCursor(this.cursorState,[this.mouse.baseMouseX,this.mouse.baseMouseY])}keyDataReset(){this.interactionVisual.clearAllShapes(),this.mouse.setBaseMouseRecords([]),this.cursorState=this.getCursorState(),this.input="",this.interactionVisual.drawCursor(this.cursorState,[this.mouse.baseMouseX,this.mouse.baseMouseY])}};__decorateClass$2([it(dt)],tn.prototype,"envConfig",2),__decorateClass$2([it(Wt)],tn.prototype,"systemConfig",2),__decorateClass$2([it(Lt)],tn.prototype,"mouse",2),__decorateClass$2([it(It)],tn.prototype,"dataManager",2),__decorateClass$2([it(Ht)],tn.prototype,"interactionVisual",2),__decorateClass$2([it(_t)],tn.prototype,"keyboard",2),__decorateClass$2([it($e)],tn.prototype,"shortcutManager",2),__decorateClass$2([it(ze)],tn.prototype,"commandManager",2),__decorateClass$2([it(at)],tn.prototype,"domManager",2),__decorateClass$2([it(Le)],tn.prototype,"snap",2),tn=__decorateClass$2([injectable()],tn);var en=Object.defineProperty,nn=Object.getOwnPropertyDescriptor,__decorateClass$1=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?nn(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&en(e,n,s),s};let rn=class{constructor(){__publicField(this,"envConfig"),__publicField(this,"domManager"),__publicField(this,"dataManager"),__publicField(this,"mouse"),__publicField(this,"systemConfig"),__publicField(this,"renderWorker"),__publicField(this,"queue",new MessageQueue(new ExecuteLatestStrategy)),__publicField(this,"addTask",(()=>{this.queue.addTask(this.VisualWorkerViewChangeHandler.bind(this))}))}init(){this.canvasInit(),this.eventInit(),this.dataManagerListenerInit()}canvasInit(){const t=this.domManager.dataCanvas;t.width=Math.ceil(t.offsetWidth*this.envConfig.dpr),t.height=Math.ceil(t.offsetHeight*this.envConfig.dpr);const e=t.transferControlToOffscreen();this.renderWorker=new Worker(new URL(""+new URL("DataRender-CRaJpyi6.js",import.meta.url).href,import.meta.url),{type:"module",name:"visual"}),this.renderWorker.postMessage({event:"INIT",canvas:e,dpr:this.envConfig.dpr,selectedNodeSize:this.systemConfig.selectedNodeSize},[e])}dataManagerListenerInit(){this.dataManager.addEventListener(bt,(t=>{this.render(t)})),this.dataManager.addEventListener(Ct,((t,e)=>{let n=e.oldAABB;const{a:i}=this.mouse.visualWorkerView,r=this.systemConfig.selectedNodeSize/2/i;n=[[n[0][0]-r,n[0][1]-r],[n[1][0]+r,n[1][1]+r]];const s=new Set(t.map((t=>t.id))),o=this.dataManager.getEntityByAABB(n).filter((t=>!s.has(t.id)));this.clearArea(this.affineTransformAABB(n)),this.render([...o,...t])})),this.dataManager.addEventListener(wt,((t,e)=>{let n=e.oldAABB;const i=this.systemConfig.selectedNodeSize/2;n=[[n[0][0]-i,n[0][1]-i],[n[1][0]+i,n[1][1]+i]];const r=new Set(t.map((t=>t.id))),s=this.dataManager.getEntityByAABB(n).filter((t=>!r.has(t.id)));this.clearArea(this.affineTransformAABB(n)),this.render(s)}))}eventInit(){this.mouse.addEventListener(Mt,this.addTask)}VisualWorkerViewChangeHandler(){this.clearArea([[0,0],[this.domManager.dataCanvas.width,this.domManager.dataCanvas.height]]);const t=this.dataManager.all();this.render(t)}render(t,e){if(!e){const{a:t,b:n,c:i,d:r,e:s,f:o}=this.mouse.visualWorkerView;e={a:t,b:n,c:i,d:r,e:s,f:o}}this.renderWorker.postMessage({event:"RENDER",entityArr:t,viewInfo:e,renderShapeSelectedNode:this.dataManager.selectionBoxEntities.length<this.systemConfig.maxNodeEntityShowNum})}clearArea(t){this.renderWorker.postMessage({event:"CLEAR",clearArea:t})}affineTransformAABB(t){return t.map((t=>this.mouse.affineTransformPoint(t)))}};__decorateClass$1([it(dt)],rn.prototype,"envConfig",2),__decorateClass$1([it(at)],rn.prototype,"domManager",2),__decorateClass$1([it(It)],rn.prototype,"dataManager",2),__decorateClass$1([it(Lt)],rn.prototype,"mouse",2),__decorateClass$1([it(Wt)],rn.prototype,"systemConfig",2),rn=__decorateClass$1([injectable()],rn);class TextEditor{constructor(){__publicField(this,"container"),__publicField(this,"data"),__publicField(this,"options",{pageWidth:794,pageHeight:1123,pagePadding:[100,120,100,120],pageMargin:20,pagePaddingIndicatorSize:35,pagePaddingIndicatorColor:"#BABABA",color:"#333",fontSize:16,fontFamily:"Yahei",lineHeight:1.5,rangeColor:"#bbdfff",rangeOpacity:.6}),__publicField(this,"pageCanvasList",[]),__publicField(this,"pageCanvasCtxList",[]),__publicField(this,"rows",[]),__publicField(this,"positionList",[]),__publicField(this,"cursorPositionIndex",-1),__publicField(this,"cursorEl",null),__publicField(this,"cursorTimer"),__publicField(this,"textareaEl",null),__publicField(this,"isCompositing",!1),__publicField(this,"isMousedown",!1),__publicField(this,"range",[]),__publicField(this,"mousemoveTimer"),__publicField(this,"listeners",{mousedown:()=>{},rangeChange:()=>{}}),__publicField(this,"mousemoveEvent")}init(t,e,n={}){this.container=t,this.data=e,this.options=Object.assign(this.options,n),this.createPage(0),this.render(),document.body.addEventListener("mousemove",this.onMousemove.bind(this)),document.body.addEventListener("mouseup",this.onMouseup.bind(this))}render(t=!1){this.clear(),this.positionList=[],t||(this.rows=[],this.computeRows()),this.renderPage()}clear(){let{pageWidth:t,pageHeight:e}=this.options;this.pageCanvasCtxList.forEach((n=>{n.clearRect(0,0,t,e)}))}renderPage(){let{pageHeight:t,pagePadding:e}=this.options,n=t-e[0]-e[2],i=0,r=this.pageCanvasCtxList[i],s=0;this.renderPagePaddingIndicators(i),this.rows.forEach(((t,e)=>{if(s+t.height>n){i++,this.pageCanvasList[i]||this.createPage(i),this.renderPagePaddingIndicators(i),r=this.pageCanvasCtxList[i],s=0}this.renderRow(r,s,t,i,e),s+=t.height}))}renderRow(t,e,n,i,r){let{color:s,pagePadding:o,rangeColor:a,rangeOpacity:c}=this.options,h=o[3],u=o[0],d=h;e+=u,n.elementList.forEach((o=>{if(this.positionList.push({...o,pageIndex:i,rowIndex:r,rect:{leftTop:[d,e],leftBottom:[d,e+n.height],rightTop:[d+o.info.width,e],rightBottom:[d+o.info.width,e+n.height]}}),"\n"!==o.value){if(t.save(),o.background&&(t.save(),t.beginPath(),t.fillStyle=o.background,t.fillRect(d,e,o.info.width,n.height),t.restore()),o.underline&&(t.save(),t.beginPath(),t.moveTo(d,e+n.height),t.lineTo(d+o.info.width,e+n.height),t.stroke(),t.restore()),o.linethrough&&(t.save(),t.beginPath(),t.moveTo(d,e+n.height/2),t.lineTo(d+o.info.width,e+n.height/2),t.stroke(),t.restore()),t.font=o.font,t.fillStyle=o.color||s,t.fillText(o.value,d,e+n.height-(n.height-n.originHeight)/2-n.descent),2===this.range.length&&this.range[0]!==this.range[1]){let i=this.getRange(),r=this.positionList.length-1;r>=i[0]&&r<=i[1]&&(t.save(),t.beginPath(),t.globalAlpha=c,t.fillStyle=a,t.fillRect(d,e,o.info.width,n.height),t.restore())}d+=o.info.width,t.restore()}}))}getRange(){return this.range.length<2?[]:this.range[1]>this.range[0]?[this.range[0]+1,this.range[1]]:this.range[1]<this.range[0]?[this.range[1]+1,this.range[0]]:[]}clearRange(){this.range.length>0&&(this.range=[],this.render())}computeRows(){let{pageWidth:t,pagePadding:e,lineHeight:n,fontSize:i}=this.options,r=t-e[1]-e[3];const s=document.createElement("canvas").getContext("2d");let o=[];o.push({width:0,height:0,originHeight:0,descent:0,elementList:[]}),this.data.forEach((t=>{let{value:e,lineheight:a}=t,c=a||n,h=this.getFontStr(t),u={width:0,height:0,ascent:0,descent:0};if("\n"===e)u.height=i;else{s.font=h;let{width:t,actualBoundingBoxAscent:n,actualBoundingBoxDescent:i}=s.measureText(e);u.width=t,u.height=n+i,u.ascent=n,u.descent=i}let d={...t,info:u,font:h},l=o[o.length-1];l.width+u.width<=r&&"\n"!==e?(l.elementList.push(d),l.width+=u.width,l.height=Math.max(l.height,u.height*c),l.originHeight=Math.max(l.originHeight,u.height),l.descent=Math.max(l.descent,u.descent)):o.push({width:u.width,height:u.height*c,originHeight:u.height,elementList:[d],descent:u.descent})})),this.rows=o}getFontStr(t){let{fontSize:e,fontFamily:n}=this.options;return`${t.italic?"italic ":""} ${t.bold?"bold ":""} ${t.size||e}px  ${t.fontfamily||n} `}createPage(t){let{pageWidth:e,pageHeight:n,pageMargin:i}=this.options,r=document.createElement("canvas");const s=window.devicePixelRatio;r.width=e*s,r.height=n*s,r.style.width=e+"px",r.style.height=n+"px",r.style.cursor="text",r.style.backgroundColor="#fff",r.style.boxShadow="#9ea1a566 0 2px 12px",r.style.marginBottom=i+"px",r.addEventListener("mousedown",(e=>{this.onMousedown(e,t)})),this.container.appendChild(r);let o=r.getContext("2d");o.scale(s,s),this.pageCanvasList.push(r),this.pageCanvasCtxList.push(o)}onMousedown(t,e){this.isMousedown=!0;let{x:n,y:i}=this.windowToCanvas(t,this.pageCanvasList[e]),r=this.getPositionByPos(n,i,e);this.cursorPositionIndex=r,this.computeAndRenderCursor(r,e),this.range[0]=r,this.listeners.mousedown&&this.listeners.mousedown(r)}onMousemove(t){this.mousemoveEvent=t,this.mousemoveTimer||(this.mousemoveTimer=setTimeout((()=>{if(this.mousemoveTimer=void 0,!this.isMousedown)return;t=this.mousemoveEvent;let e=this.getPosInPageIndex(t.clientX,t.clientY);if(-1===e)return;let{x:n,y:i}=this.windowToCanvas(t,this.pageCanvasList[e]),r=this.getPositionByPos(n,i,e);-1!==r&&(this.range[1]=r,this.listeners.rangeChange&&this.listeners.rangeChange(this.getRange()),Math.abs(this.range[1]-this.range[0])>0&&(this.cursorPositionIndex=-1,this.hideCursor()),this.render(!0))}),100))}onMouseup(){this.isMousedown=!1}getPositionByPos(t,e,n){for(let r=0;r<this.positionList.length;r++){let i=this.positionList[r];if(i.pageIndex===n&&(t>=i.rect.leftTop[0]&&t<=i.rect.rightTop[0]&&e>=i.rect.leftTop[1]&&e<=i.rect.leftBottom[1]))return t<i.rect.leftTop[0]+i.info.width/2?r-1:r}let i=-1;for(let r=0;r<this.positionList.length;r++){let t=this.positionList[r];t.pageIndex===n&&(e>=t.rect.leftTop[1]&&e<=t.rect.leftBottom[1]&&(i=r))}if(-1!==i)return i;for(let r=0;r<this.positionList.length;r++){this.positionList[r].pageIndex===n&&(i=r)}return i}getCursorInfo(t){let e=this.positionList[t],{fontSize:n,pagePadding:i,lineHeight:r}=this.options,s=(e?e.size:null)||n,o=s+s/2;if(!e){if(this.positionList[t+1]){let e=this.getCursorInfo(t+1);return{x:i[3],y:e.y,height:e.height}}return{x:i[3],y:i[0]+(s*r-o)/2,height:o}}let a="\n"===e.value,c=this.rows[e.rowIndex];return{x:a?e.rect.leftTop[0]:e.rect.rightTop[0],y:e.rect.rightTop[1]+c.height-(c.height-c.originHeight)/2-o+(o-Math.max(s,e.info.height))/2,height:o}}computeAndRenderCursor(t,e){let n=this.getCursorInfo(t),i=this.canvasToContainer(n.x,n.y,this.pageCanvasList[e]);this.setCursor(i.x,i.y,n.height)}setCursor(t,e,n){this.clearRange(),clearTimeout(this.cursorTimer),this.cursorEl||(this.cursorEl=document.createElement("div"),this.cursorEl.style.position="absolute",this.cursorEl.style.width="1px",this.cursorEl.style.backgroundColor="#000",this.container.appendChild(this.cursorEl)),this.cursorEl.style.left=t+"px",this.cursorEl.style.top=e+"px",this.cursorEl.style.height=n+"px",this.cursorEl.style.opacity="1";let i=setTimeout((()=>{this.focus(),this.cursorEl&&(this.cursorEl.style.display="block"),this.blinkCursor("0"),clearTimeout(i)}),0)}hideCursor(){clearTimeout(this.cursorTimer),this.cursorEl&&(this.cursorEl.style.display="none")}blinkCursor(t){this.cursorTimer=setTimeout((()=>{this.cursorEl&&(this.cursorEl.style.opacity=t,this.blinkCursor("0"===t?"1":"0"))}),600)}focus(){this.textareaEl||(this.textareaEl=document.createElement("textarea"),this.textareaEl.style.position="fixed",this.textareaEl.style.left="-99999px",this.textareaEl.addEventListener("input",this.onInput.bind(this)),this.textareaEl.addEventListener("compositionstart",(()=>{this.isCompositing=!0})),this.textareaEl.addEventListener("compositionend",(()=>{this.isCompositing=!1})),this.textareaEl.addEventListener("keydown",this.onKeydown.bind(this)),this.textareaEl.addEventListener("blur",(()=>{this.hideCursor()})),document.body.appendChild(this.textareaEl)),this.textareaEl.focus()}blur(){this.textareaEl&&this.textareaEl.blur()}onInput(t){let e=setTimeout((()=>{clearTimeout(e);let n=t.data;if(!n||this.isCompositing)return;let i=n.split(""),r=i.length;this.getRange().length>0&&this.delete();let s=this.positionList[this.cursorPositionIndex];this.data.splice(this.cursorPositionIndex+1,0,...i.map((t=>({...s||{},value:t})))),this.render(),this.cursorPositionIndex+=r,this.computeAndRenderCursor(this.cursorPositionIndex,this.positionList[this.cursorPositionIndex].pageIndex)}),0)}onKeydown(t){8===t.keyCode?this.delete():13===t.keyCode&&this.newLine()}delete(){if(this.cursorPositionIndex<0){let t=this.getRange();if(!(t.length>0))return;{let e=t[1]-t[0]+1;this.data.splice(t[0],e),this.cursorPositionIndex=t[0]-1}}else this.data.splice(this.cursorPositionIndex,1),this.render(),this.cursorPositionIndex--;let t=this.positionList[this.cursorPositionIndex];this.computeAndRenderCursor(this.cursorPositionIndex,t?t.pageIndex:0)}newLine(){this.data.splice(this.cursorPositionIndex+1,0,{value:"\n"}),this.render(),this.cursorPositionIndex++;let t=this.positionList[this.cursorPositionIndex];this.computeAndRenderCursor(this.cursorPositionIndex,t.pageIndex)}getPosInPageIndex(t,e){let{left:n,top:i,right:r,bottom:s}=this.container.getBoundingClientRect();if(t<n||t>r||e<i||e>s)return-1;let{pageHeight:o,pageMargin:a}=this.options,c=e-i+this.container.scrollTop;for(let h=0;h<this.pageCanvasList.length;h++){let t=h*(o+a);if(c>=t&&c<=t+o)return h}return-1}windowToCanvas(t,e){let{left:n,top:i}=e.getBoundingClientRect();return{x:t.clientX-n,y:t.clientY-i}}canvasToContainer(t,e,n){return{x:t+n.offsetLeft,y:e+n.offsetTop}}renderPagePaddingIndicators(t){let e=this.pageCanvasCtxList[t];if(!e)return;let{pageWidth:n,pageHeight:i,pagePaddingIndicatorColor:r,pagePadding:s,pagePaddingIndicatorSize:o}=this.options;e.save(),e.strokeStyle=r,[[[s[3],s[0]-o],[s[3],s[0]],[s[3]-o,s[0]]],[[n-s[1],s[0]-o],[n-s[1],s[0]],[n-s[1]+o,s[0]]],[[s[3],i-s[2]+o],[s[3],i-s[2]],[s[3]-o,i-s[2]]],[[n-s[1],i-s[2]+o],[n-s[1],i-s[2]],[n-s[1]+o,i-s[2]]]].forEach((t=>{t.forEach(((n,i)=>{0===i?(e.beginPath(),e.moveTo(...n)):e.lineTo(...n),i>=t.length-1&&e.stroke()}))})),e.restore()}}var sn=Object.defineProperty,on=Object.getOwnPropertyDescriptor,__decorateClass=(t,e,n,i)=>{for(var r,s=i>1?void 0:i?on(e,n):e,o=t.length-1;o>=0;o--)(r=t[o])&&(s=(i?r(e,n,s):r(s))||s);return i&&s&&sn(e,n,s),s};let an=class{constructor(){__publicField(this,"envConfig"),__publicField(this,"systemConfig"),__publicField(this,"domManager"),__publicField(this,"interactionManager"),__publicField(this,"dataVisual"),__publicField(this,"rtreeVisual"),__publicField(this,"editor",new TextEditor)}init(t){this.envConfig.setDpr(window.devicePixelRatio),this.systemConfig.init(),this.domManager.init(t),this.dataVisual.init(),this.rtreeVisual.init(),this.interactionManager.init()}};__decorateClass([it(dt)],an.prototype,"envConfig",2),__decorateClass([it(Wt)],an.prototype,"systemConfig",2),__decorateClass([it(at)],an.prototype,"domManager",2),__decorateClass([it(tn)],an.prototype,"interactionManager",2),__decorateClass([it(rn)],an.prototype,"dataVisual",2),__decorateClass([it(We)],an.prototype,"rtreeVisual",2),an=__decorateClass([injectable()],an);const cn=new nt;cn.bind(dt).toSelf().inSingletonScope(),cn.bind(Wt).toSelf().inSingletonScope(),cn.bind(ht).toSelf().inSingletonScope(),cn.bind(at).toSelf().inSingletonScope(),cn.bind(Lt).toSelf().inSingletonScope(),cn.bind(_t).toSelf().inSingletonScope(),cn.bind(oe).toSelf(),cn.bind(ze).toSelf().inSingletonScope(),cn.bind($e).toSelf().inSingletonScope(),cn.bind(Le).toSelf().inSingletonScope(),cn.bind(Ht).toSelf().inSingletonScope(),cn.bind(an).toSelf().inSingletonScope(),cn.bind(rn).toSelf().inSingletonScope(),cn.bind(We).toSelf().inSingletonScope(),cn.bind(ee).toSelf().inSingletonScope(),cn.bind(Fe).toSelf().inSingletonScope(),cn.bind(xe).toSelf().inSingletonScope(),cn.bind(It).toSelf().inSingletonScope(),cn.bind(Gt).toSelf().inSingletonScope(),cn.bind(tn).toSelf().inSingletonScope(),cn.bind(yt).toSelf().inSingletonScope(),cn.bind(Kt).toSelf().inSingletonScope(),cn.bind(gt).toSelf().inSingletonScope(),cn.bind(Ee).toSelf(),cn.bind(Xe).toDynamicValue((()=>new Xe(cn))).inSingletonScope();const hn=cn.get(an),un=r('<div class="container" data-v-42da9eaf><div id="cad" data-v-42da9eaf></div></div><div class="help" data-v-42da9eaf><div class="title" data-v-42da9eaf>快捷键说明</div><p data-v-42da9eaf>左框选：鼠标左键，选中框内</p><p data-v-42da9eaf>右框选：鼠标左键，选中框相交</p><p data-v-42da9eaf>平移：长按滚轮</p><p data-v-42da9eaf>缩放：滚动滚轮</p><p data-v-42da9eaf>缩放居中：双击滚轮</p><p data-v-42da9eaf>直线：L 或 LINE</p><p data-v-42da9eaf>圆：C 或 CIRCLE</p><p data-v-42da9eaf>圆弧：ARC</p><p data-v-42da9eaf>终止指令：ESC</p><p data-v-42da9eaf>移动：AS 或 M 或 MOVE，支持输入距离</p><p data-v-42da9eaf>复制：CC 或 COPY，支持输入距离</p><p data-v-42da9eaf>删除：DEL 或 DELETE</p><p data-v-42da9eaf>编辑：拖拽节点</p><p data-v-42da9eaf>继续上次指令：空格</p><p data-v-42da9eaf>撤销：CTRL+Z</p><p data-v-42da9eaf>重做：CTRL+Y</p><p data-v-42da9eaf>全选：CTRL+A</p><p data-v-42da9eaf>缓存：CTRL+S</p><p data-v-42da9eaf>开启/关闭RTree视图：RTV</p><p data-v-42da9eaf>子命令：部分实现</p><p data-v-42da9eaf>其他：todo..</p></div>',2),dn=s(n({__name:"index",setup:t=>(i((()=>{hn.init(document.getElementById("cad"))})),(t,e)=>un)}),[["__scopeId","data-v-42da9eaf"]]);export{dn as default};
