var __defProp=Object.defineProperty,__defNormalProp=(t,e,s)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,__publicField=(t,e,s)=>__defNormalProp(t,"symbol"!=typeof e?e+"":e,s);!function(){"use strict";const t=new WeakMap;function getMetadataMap(e,s){return t.get(e)&&t.get(e).get(s)}function ordinaryGetOwnMetadata(t,e,s){if(void 0===e)throw new TypeError;const i=getMetadataMap(e,s);return i&&i.get(t)}function ordinaryDefineOwnMetadata(e,s,i,o){if(o&&!["string","symbol"].includes(typeof o))throw new TypeError;(getMetadataMap(i,o)||function createMetadataMap(e,s){const i=t.get(e)||new Map;t.set(e,i);const o=i.get(s)||new Map;return i.set(s,o),o}(i,o)).set(e,s)}function ordinaryGetMetadata(t,e,s){return ordinaryGetOwnMetadata(t,e,s)?ordinaryGetOwnMetadata(t,e,s):Object.getPrototypeOf(e)?ordinaryGetMetadata(t,Object.getPrototypeOf(e),s):void 0}const e={decorate:function decorate(t,e,s,i){if(!Array.isArray(t)||0===t.length)throw new TypeError;return void 0!==s?function decorateProperty(t,e,s,i){return t.reverse().forEach((t=>{i=t(e,s,i)||i})),i}(t,e,s,i):"function"==typeof e?function decorateConstructor(t,e){return t.reverse().forEach((t=>{const s=t(e);s&&(e=s)})),e}(t,e):void 0},defineMetadata:function defineMetadata(t,e,s,i){ordinaryDefineOwnMetadata(t,e,s,i)},getMetadata:function getMetadata(t,e,s){return ordinaryGetMetadata(t,e,s)},getOwnMetadata:function getOwnMetadata(t,e,s){return ordinaryGetOwnMetadata(t,e,s)},hasMetadata:function hasMetadata(t,e,s){return!!ordinaryGetMetadata(t,e,s)},hasOwnMetadata:function hasOwnMetadata(t,e,s){return!!ordinaryGetOwnMetadata(t,e,s)},metadata:function metadata(t,e){return function decorator(s,i){ordinaryDefineOwnMetadata(t,e,s,i)}}};Object.assign(Reflect,e);var s=(t=>(t.InteractionVisual="InteractionVisual",t.CommandVisual="CommandVisual",t.DataVisual="DataVisual",t.RTreeVisual="RTreeVisual",t))(s||{}),i="inversify:tagged",o="inversify:tagged_props",a="inversify:paramtypes",n="Metadata key was used more than once in a parameter:",r="The @inject @multiInject @tagged and @named decorators must be applied to the parameters of a class constructor or a class property.",h=function(){function Metadata2(t,e){this.key=t,this.value=e}return Metadata2.prototype.toString=function(){return"named"===this.key?"named: "+String(this.value).toString()+" ":"tagged: { key:"+this.key.toString()+", value: "+String(this.value)+" }"},Metadata2}();function tagParameter(t,e,s,o){!function _throwIfMethodParameter(t){if(void 0!==t)throw new Error(r)}(e),_tagParameterOrProperty(i,t,s.toString(),o)}function _ensureNoMetadataKeyDuplicates(t){var e=[];if(Array.isArray(t)){var s=function getFirstArrayDuplicate(t){for(var e=new Set,s=0,i=t;s<i.length;s++){var o=i[s];if(e.has(o))return o;e.add(o)}}((e=t).map((function(t){return t.key})));if(void 0!==s)throw new Error(n+" "+s.toString())}else e=[t];return e}function _tagParameterOrProperty(t,e,s,i){var o=_ensureNoMetadataKeyDuplicates(i),a={};Reflect.hasOwnMetadata(t,e)&&(a=Reflect.getMetadata(t,e));var r=a[s];if(void 0===r)r=[];else for(var _loop_1=function(t){if(o.some((function(e){return e.key===t.key})))throw new Error(n+" "+t.key.toString())},h=0,c=r;h<c.length;h++){_loop_1(c[h])}r.push.apply(r,o),a[s]=r,Reflect.defineMetadata(t,a,e)}function createTaggedDecorator(t){return function(e,s,i){"number"==typeof i?tagParameter(e,s,i,t):function tagProperty(t,e,s){if(function targetIsConstructorFunction(t){return void 0!==t.prototype}(t))throw new Error(r);_tagParameterOrProperty(o,t.constructor,e,s)}(e,s,t)}}function injectable(){return function(t){if(Reflect.hasOwnMetadata(a,t))throw new Error("Cannot apply @injectable decorator multiple times.");var e=Reflect.getMetadata("design:paramtypes",t)||[];return Reflect.defineMetadata(a,e,t),t}}var c=function injectBase(t){return function(e){return function(s,i,o){if(void 0===e){var a="function"==typeof s?s.name:s.constructor.name;throw new Error("@inject called with undefined this could mean that the class "+a+" has a circular dependency problem. You can use a LazyServiceIdentifier to  overcome this limitation.")}return createTaggedDecorator(new h(t,e))(s,i,o)}}}("inject"),d=Object.getOwnPropertyDescriptor;let l=class{constructor(){__publicField(this,"domContainer"),__publicField(this,"interactionCanvas"),__publicField(this,"commandCanvas"),__publicField(this,"dataCanvas")}init(t){if(this.domContainer=t,!this.isPositionAbsolute(this.domContainer))throw new Error("CAD domContainer must be position absolute !");this.interactionCanvas=this.createCanvas(s.InteractionVisual),this.commandCanvas=this.createCanvas(s.CommandVisual),this.dataCanvas=this.createCanvas(s.DataVisual),this.domContainer.appendChild(this.dataCanvas),this.domContainer.appendChild(this.commandCanvas),this.domContainer.appendChild(this.interactionCanvas)}createCanvas(t){const e=document.createElement("canvas");switch(e.id=t,e.style.width="100%",e.style.height="100%",e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.cursor="none",t){case s.InteractionVisual:e.style.backgroundColor="transparent",e.style.zIndex="3";break;case s.CommandVisual:e.style.backgroundColor="transparent",e.style.zIndex="2";break;case s.DataVisual:e.style.backgroundColor="#000",e.style.zIndex="1"}return e}isPositionAbsolute(t){return"absolute"===window.getComputedStyle(t).position}};l=((t,e,s,i)=>{for(var o,a=i>1?void 0:i?d(e,s):e,n=t.length-1;n>=0;n--)(o=t[n])&&(a=o(a)||a);return a})([injectable()],l);var C=Object.getOwnPropertyDescriptor;let p=class{constructor(){__publicField(this,"list",new Map)}addEventListener(t,e){let s=this.list.get(t);s||(s=new Set,this.list.set(t,s)),s.has(e)||s.add(e)}dispatchEvent(t,...e){const s=this.list.get(t);if(s)for(const i of s)i(...e)}removeEventListener(t,e){const s=this.list.get(t);s&&s.has(e)&&s.delete(e)}once(t,e){const tempFn=(...s)=>{e(...s),this.removeEventListener(t,tempFn)};this.addEventListener(t,tempFn)}};p=((t,e,s,i)=>{for(var o,a=i>1?void 0:i?C(e,s):e,n=t.length-1;n>=0;n--)(o=t[n])&&(a=o(a)||a);return a})([injectable()],p);var g=Object.getOwnPropertyDescriptor;let u=class extends p{constructor(){super(),__publicField(this,"_dpr",1)}get dpr(){return this._dpr}setDpr(t){this._dpr=t}get ghostClearCompensation(){return 1*this._dpr}};u=((t,e,s,i)=>{for(var o,a=i>1?void 0:i?g(e,s):e,n=t.length-1;n>=0;n--)(o=t[n])&&(a=o(a)||a);return a})([injectable()],u);var S=Object.getOwnPropertyDescriptor;let f=class{constructor(t){__publicField(this,"_crossLength"),__publicField(this,"_squareLength"),__publicField(this,"_detectTime"),__publicField(this,"_maxNodeEntityShowNum"),__publicField(this,"_snapSize"),__publicField(this,"_selectedNodeSize"),this.envConfig=t}init(){this._crossLength=100*this.envConfig.dpr,this._squareLength=10*this.envConfig.dpr,this._detectTime=20,this._maxNodeEntityShowNum=10,this._snapSize=20*this.envConfig.dpr,this._selectedNodeSize=12*this.envConfig.dpr}get crossLength(){return this._crossLength}get squareLength(){return this._squareLength}get detectTime(){return this._detectTime}get maxNodeEntityShowNum(){return this._maxNodeEntityShowNum}get snapSize(){return this._snapSize}get selectedNodeSize(){return this._selectedNodeSize}};var v,x;f=((t,e,s,i)=>{for(var o,a=i>1?void 0:i?S(e,s):e,n=t.length-1;n>=0;n--)(o=t[n])&&(a=o(a)||a);return a})([injectable(),(v=0,x=c(u),(t,e)=>x(t,e,v))],f);var m=Object.defineProperty,y=Object.getOwnPropertyDescriptor,__decorateClass=(t,e,s,i)=>{for(var o,a=i>1?void 0:i?y(e,s):e,n=t.length-1;n>=0;n--)(o=t[n])&&(a=(i?o(e,s,a):o(a))||a);return i&&a&&m(e,s,a),a},T=(t=>(t.CROSSWITHSQUARE="CROSSWITHSQUARE",t.NONE="NONE",t.CROSS="CROSS",t.SQUARE="SQUARE",t.DRAGGING="DRAGGING",t))(T||{});let w=class{constructor(){__publicField(this,"domManager"),__publicField(this,"envConfig"),__publicField(this,"systemConfig"),__publicField(this,"renderWorker"),__publicField(this,"canvas")}init(){this.canvas=this.domManager.interactionCanvas,this.canvas.width=Math.ceil(this.canvas.offsetWidth*this.envConfig.dpr),this.canvas.height=Math.ceil(this.canvas.offsetHeight*this.envConfig.dpr);const t=this.canvas.transferControlToOffscreen();this.renderWorker=new Worker(self.location.href,{type:"module",name:"visual"}),this.renderWorker.postMessage({event:"INIT",canvas:t,dpr:this.envConfig.dpr,crossLength:this.systemConfig.crossLength,squareLength:this.systemConfig.squareLength,snapSize:this.systemConfig.snapSize,ghostClearCompensation:this.envConfig.ghostClearCompensation},[t])}drawCursor(t,e){"NONE"===t?"none"!==this.canvas.style.cursor&&(this.canvas.style.cursor="none"):"DRAGGING"===t?"grabbing"!==this.canvas.style.cursor&&(this.canvas.style.cursor="grabbing"):("none"!==this.canvas.style.cursor&&(this.canvas.style.cursor="none"),this.renderWorker.postMessage({event:"DRAWCURSOR",cursorState:t,point:e}))}drawSelectRect(t,e){this.renderWorker.postMessage({event:"DRAWSELECTRECT",startPoint:t,endPoint:e})}clearCursorAndSelectRect(t,e,s){this.renderWorker.postMessage({event:"CLEARCURSORANDSELECTRECT",cursorState:t,startPoint:e,endPoint:s})}clearAllShapes(){this.renderWorker.postMessage({event:"CLEARALLSHAPES"})}drawEndpoint(t,e="#F2D378"){this.renderWorker.postMessage({event:"DRAWENDPOINT",coordinate:t,strokeStyle:e})}drawMidpoint(t){this.renderWorker.postMessage({event:"DRAWMIDPOINT",coordinate:t})}drawPerpendicular(t){this.renderWorker.postMessage({event:"DRAWPERPENDICULAR",coordinate:t})}drawInsertionPoint(t){this.renderWorker.postMessage({event:"DRAWINSERTIONPOINT",coordinate:t})}drawTangency(t){this.renderWorker.postMessage({event:"DRAWTANGENCY",coordinate:t})}drawQuadrant(t){this.renderWorker.postMessage({event:"DRAWQUADRANT",coordinate:t})}drawClosest(t){this.renderWorker.postMessage({event:"DRAWCLOSEST",coordinate:t})}drawIntersection(t){this.renderWorker.postMessage({event:"DRAWINTERSECTION",coordinate:t})}};__decorateClass([c(l)],w.prototype,"domManager",2),__decorateClass([c(u)],w.prototype,"envConfig",2),__decorateClass([c(f)],w.prototype,"systemConfig",2),w=__decorateClass([injectable()],w);new class Interaction{constructor(){__publicField(this,"osCtx"),__publicField(this,"dpr"),__publicField(this,"snapSize"),__publicField(this,"crossLength"),__publicField(this,"squareLength"),__publicField(this,"ghostClearCompensation"),__publicField(this,"crosshairImageDataInfo",new Map),this.addEventListenerInit()}addEventListenerInit(){self.addEventListener("message",(t=>{const e=t.data||{};switch(e.event){case"INIT":{this.dpr=e.dpr,this.snapSize=e.snapSize,this.crossLength=e.crossLength,this.squareLength=e.squareLength,this.ghostClearCompensation=e.ghostClearCompensation;const t=e.canvas;this.osCtx=t.getContext("2d"),this.osCtx.strokeStyle="#fff",this.osCtx.lineWidth=1*this.dpr,this.osCtx.save(),this.crosshairImageDataInfoInit();break}case"DRAWCURSOR":this.drawCursor(e.cursorState,e.point);break;case"DRAWSELECTRECT":this.drawSelectRect(e.startPoint,e.endPoint);break;case"CLEARCURSORANDSELECTRECT":this.clearCursorAndSelectRect(e.cursorState,e.startPoint,e.endPoint);break;case"CLEARALLSHAPES":this.clearAllShapes();break;case"DRAWENDPOINT":this.drawEndpoint(e.coordinate,e.strokeStyle);break;case"DRAWMIDPOINT":this.drawMidpoint(e.coordinate);break;case"DRAWQUADRANT":this.drawQuadrant(e.coordinate);break;case"DRAWPERPENDICULAR":this.drawPerpendicular(e.coordinate);break;case"DRAWINSERTIONPOINT":this.drawInsertionPoint(e.coordinate);break;case"DRAWTANGENCY":this.drawTangency(e.coordinate);break;case"DRAWCLOSEST":this.drawClosest(e.coordinate);break;case"DRAWINTERSECTION":this.drawIntersection(e.coordinate)}}))}crosshairImageDataInfoInit(){this.crosshairImageDataInfo.set(T.NONE,T.NONE),this.crosshairImageDataInfo.set(T.DRAGGING,T.DRAGGING);const t=this.crossLength/2,e=this.squareLength/2;this.osCtx.clearRect(0,0,this.crossLength,this.crossLength),this.osCtx.beginPath(),this.osCtx.moveTo(0,t),this.osCtx.lineTo(this.crossLength,t),this.osCtx.moveTo(t,this.crossLength),this.osCtx.lineTo(t,0),this.osCtx.stroke();let s=this.osCtx.getImageData(0,0,this.crossLength,this.crossLength);this.crosshairImageDataInfo.set(T.CROSS,s),this.osCtx.clearRect(0,0,this.crossLength,this.crossLength),this.osCtx.beginPath(),this.osCtx.moveTo(t-e,t-e),this.osCtx.lineTo(t+e,t-e),this.osCtx.lineTo(t+e,t+e),this.osCtx.lineTo(t-e,t+e),this.osCtx.lineTo(t-e,t-e),this.osCtx.stroke(),s=this.osCtx.getImageData(0,0,this.crossLength,this.crossLength),this.crosshairImageDataInfo.set(T.SQUARE,s),this.osCtx.clearRect(0,0,this.crossLength,this.crossLength),this.osCtx.beginPath(),this.osCtx.moveTo(0,t),this.osCtx.lineTo(this.crossLength,t),this.osCtx.moveTo(t,this.crossLength),this.osCtx.lineTo(t,0),this.osCtx.moveTo(t-e,t-e),this.osCtx.lineTo(t+e,t-e),this.osCtx.lineTo(t+e,t+e),this.osCtx.lineTo(t-e,t+e),this.osCtx.lineTo(t-e,t-e),this.osCtx.stroke(),s=this.osCtx.getImageData(0,0,this.crossLength,this.crossLength),this.crosshairImageDataInfo.set(T.CROSSWITHSQUARE,s),this.osCtx.clearRect(0,0,this.crossLength,this.crossLength)}drawCursor(t,e){const s=this.crosshairImageDataInfo.get(t);s&&this.osCtx.putImageData(s,e[0]-this.crossLength/2,e[1]-this.crossLength/2)}drawSelectRect(t,e){this.osCtx.save();const s=t[0],i=t[1],o=e[0]-s,a=e[1]-i;o>0?this.osCtx.fillStyle="rgba(30, 30, 140, 0.3)":(this.osCtx.fillStyle="rgba(10, 230, 10, 0.3)",this.osCtx.setLineDash([5,5])),this.osCtx.strokeRect(s,i,o,a),this.osCtx.fillRect(s,i,o,a),this.osCtx.restore()}clearCursor(t){this.osCtx.clearRect(t[0]-this.crossLength/2-this.ghostClearCompensation,t[1]-this.crossLength/2-this.ghostClearCompensation,this.crossLength+2*this.ghostClearCompensation,this.crossLength+2*this.ghostClearCompensation)}clearSelectRect(t,e){let s=this.ghostClearCompensation,i=this.ghostClearCompensation,o=t[0],a=t[1],n=e[0]-o,r=e[1]-a;n<0&&(s*=-1),r<0&&(i*=-1),o-=s,a-=i,n+=2*s,r+=2*i,this.osCtx.clearRect(o,a,n,r)}clearCursorAndSelectRect(t,e,s){if(this.clearCursor(s),t===T.NONE)this.clearSelectRect(e,s)}clearAllShapes(){this.osCtx.clearRect(0,0,this.osCtx.canvas.width,this.osCtx.canvas.height)}drawEndpoint(t,e="#F2D378"){const[s,i]=t;this.osCtx.save(),this.osCtx.strokeStyle=e,this.osCtx.beginPath(),this.osCtx.moveTo(s-this.snapSize/2,i-this.snapSize/2),this.osCtx.lineTo(s+this.snapSize/2,i-this.snapSize/2),this.osCtx.lineTo(s+this.snapSize/2,i+this.snapSize/2),this.osCtx.lineTo(s-this.snapSize/2,i+this.snapSize/2),this.osCtx.closePath(),this.osCtx.stroke(),this.osCtx.restore()}drawMidpoint(t){const[e,s]=t;this.osCtx.save(),this.osCtx.strokeStyle="#F2D378",this.osCtx.beginPath(),this.osCtx.moveTo(e,s-this.snapSize/2),this.osCtx.lineTo(e+this.snapSize/2,s+this.snapSize/2),this.osCtx.lineTo(e-this.snapSize/2,s+this.snapSize/2),this.osCtx.closePath(),this.osCtx.stroke(),this.osCtx.restore()}drawQuadrant(t){const[e,s]=t;this.osCtx.save(),this.osCtx.strokeStyle="#F2D378",this.osCtx.beginPath(),this.osCtx.moveTo(e,s-this.snapSize/2),this.osCtx.lineTo(e+this.snapSize/2,s),this.osCtx.lineTo(e,s+this.snapSize/2),this.osCtx.lineTo(e-this.snapSize/2,s),this.osCtx.closePath(),this.osCtx.stroke(),this.osCtx.restore()}drawPerpendicular(t){const[e,s]=t;this.osCtx.save(),this.osCtx.strokeStyle="#F2D378",this.osCtx.beginPath(),this.osCtx.moveTo(e-this.snapSize/2,s),this.osCtx.lineTo(e,s),this.osCtx.lineTo(e,s+this.snapSize/2),this.osCtx.moveTo(e-this.snapSize/2,s-this.snapSize/2),this.osCtx.lineTo(e-this.snapSize/2,s+this.snapSize/2),this.osCtx.lineTo(e+this.snapSize/2,s+this.snapSize/2),this.osCtx.stroke(),this.osCtx.restore()}drawInsertionPoint(t){const[e,s]=t;this.osCtx.save(),this.osCtx.strokeStyle="#F2D378",this.osCtx.beginPath(),this.osCtx.moveTo(e-this.snapSize/2,s-this.snapSize/2),this.osCtx.lineTo(e+2,s-this.snapSize/2),this.osCtx.lineTo(e+2,s-2),this.osCtx.lineTo(e+this.snapSize/2,s-2),this.osCtx.lineTo(e+this.snapSize/2,s+this.snapSize/2),this.osCtx.lineTo(e-2,s+this.snapSize/2),this.osCtx.lineTo(e-2,s+2),this.osCtx.lineTo(e-this.snapSize/2,s+2),this.osCtx.closePath(),this.osCtx.stroke(),this.osCtx.restore()}drawTangency(t){const[e,s]=t;this.osCtx.save(),this.osCtx.strokeStyle="#F2D378",this.osCtx.beginPath(),this.osCtx.arc(e,s,this.snapSize/2,0,2*Math.PI),this.osCtx.closePath(),this.osCtx.stroke(),this.osCtx.restore()}drawClosest(t){const[e,s]=t;this.osCtx.save(),this.osCtx.strokeStyle="#F2D378",this.osCtx.beginPath(),this.osCtx.moveTo(e-this.snapSize/2,s-this.snapSize/2),this.osCtx.lineTo(e+this.snapSize/2,s-this.snapSize/2),this.osCtx.lineTo(e-this.snapSize/2,s+this.snapSize/2),this.osCtx.lineTo(e+this.snapSize/2,s+this.snapSize/2),this.osCtx.lineTo(e-this.snapSize/2,s-this.snapSize/2),this.osCtx.closePath(),this.osCtx.stroke(),this.osCtx.restore()}drawIntersection(t){const[e,s]=t;this.osCtx.save(),this.osCtx.strokeStyle="#F2D378",this.osCtx.beginPath(),this.osCtx.moveTo(e-this.snapSize/2,s-this.snapSize/2),this.osCtx.lineTo(e+this.snapSize/2,s+this.snapSize/2),this.osCtx.moveTo(e+this.snapSize/2,s-this.snapSize/2),this.osCtx.lineTo(e-this.snapSize/2,s+this.snapSize/2),this.osCtx.stroke(),this.osCtx.restore()}}}();
